jQuery(document).ready(function($) {
    // Inline external libraries
    var scripts = [
        'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js',
        'https://unpkg.com/swiper@8/swiper-bundle.min.js'
    ];
    function loadScripts(index) {
        if (index >= scripts.length) {
            console.log('All external scripts loaded');
            return;
        }
        var script = document.createElement('script');
        script.src = scripts[index];
        script.async = false;
        script.onload = function() {
            console.log('Loaded script: ' + scripts[index]);
            loadScripts(index + 1);
        };
        script.onerror = function() {
            console.error('Failed to load script: ' + scripts[index]);
            loadScripts(index + 1);
        };
        document.head.appendChild(script);
    }
    loadScripts(0);

    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://unpkg.com/swiper@8/swiper-bundle.min.css';
    link.onload = function() {
        console.log('Loaded Swiper CSS');
    };
    document.head.appendChild(link);

    // Inline CSS for vehicle popup, Field 57 input, Generate Note popup, feature popup, trim levels popup, and Push to DriveCentric buttons
    var cssStyles = '\
        #vehiclePopup {\
            position: fixed;\
            top: 50%;\
            left: 50%;\
            transform: translate(-50%, -50%);\
            width: 90%;\
            max-width: 900px;\
            max-height: 85vh;\
            background: linear-gradient(145deg, #ffffff, #f8fafc);\
            border-radius: 16px;\
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);\
            z-index: 1001;\
            overflow-y: auto;\
            padding: 30px;\
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;\
            animation: slideIn 0.3s ease-out;\
            white-space: nowrap;\
        }\
        @keyframes slideIn {\
            from { transform: translate(-50%, -60%); opacity: 0; }\
            to { transform: translate(-50%, -50%); opacity: 1; }\
        }\
        #vehiclePopupContent {\
            padding: 0;\
        }\
        #overlay {\
            position: fixed;\
            top: 0;\
            left: 0;\
            width: 100%;\
            height: 100%;\
            background: rgba(0, 0, 0, 0.7);\
            z-index: 1000;\
            cursor: pointer;\
        }\
        .close-popup {\
            position: absolute;\
            top: 15px;\
            right: 15px;\
            padding: 10px 20px;\
            font-size: 16px;\
            font-weight: 600;\
            color: #ffffff;\
            background: #dc2626;\
            border: none;\
            border-radius: 8px;\
            cursor: pointer;\
            transition: background 0.2s ease, transform 0.2s ease;\
        }\
        .close-popup:hover {\
            background: #b91c1c;\
            transform: scale(1.05);\
        }\
        .vehicle-gallery {\
            margin-bottom: 30px;\
            border-radius: 12px;\
            overflow: hidden;\
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);\
        }\
        .swiper-container {\
            width: 100%;\
            height: 400px;\
            position: relative;\
        }\
        .swiper-slide img {\
            width: 100%;\
            height: 100%;\
            object-fit: cover;\
            border-radius: 12px 12px 0 0;\
            transition: transform 0.3s ease;\
        }\
        .swiper-slide img:hover {\
            transform: scale(1.02);\
        }\
        .swiper-button-prev, .swiper-button-next {\
            color: #ffffff;\
            background: rgba(0, 0, 0, 0.5);\
            width: 40px;\
            height: 40px;\
            border-radius: 50%;\
            transition: background 0.2s ease;\
        }\
        .swiper-button-prev:hover, .swiper-button-next:hover {\
            background: rgba(0, 0, 0, 0.7);\
        }\
        .swiper-pagination-bullet {\
            background: #ffffff;\
            opacity: 0.7;\
        }\
        .swiper-pagination-bullet-active {\
            background: #dc2626;\
            opacity: 1;\
        }\
        .vehicle-actions {\
            display: flex;\
            gap: 15px;\
            justify-content: center;\
            margin-bottom: 30px;\
        }\
        .vehicle-action-button {\
            display: inline-block;\
            padding: 12px 24px;\
            font-size: 16px;\
            font-weight: 600;\
            text-decoration: none;\
            color: #ffffff;\
            background: #2563eb;\
            border-radius: 8px;\
            transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;\
        }\
        .vehicle-action-button:hover {\
            background: #1d4ed8;\
            transform: translateY(-2px);\
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);\
        }\
        .vehicle-action-button.online {\
            background: #16a34a;\
        }\
        .vehicle-action-button.online:hover {\
            background: #15803d;\
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);\
        }\
        .vehicle-details-grid {\
            display: grid;\
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\
            gap: 20px;\
            margin-bottom: 30px;\
        }\
        .vehicle-detail {\
            background: #f1f5f9;\
            padding: 15px;\
            border-radius: 8px;\
            font-size: 15px;\
            color: #334155;\
            transition: background 0.2s ease;\
        }\
        .vehicle-detail strong {\
            color: #1e293b;\
            font-weight: 600;\
        }\
        .vehicle-detail:hover {\
            background: #e2e8f0;\
        }\
        .vehicle-description {\
            background: #ffffff;\
            padding: 20px;\
            border-radius: 8px;\
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\
        }\
        .vehicle-description h3 {\
            margin: 0 0 15px 0;\
            font-size: 20px;\
            color: #1e293b;\
            font-weight: 700;\
        }\
        .vehicle-description p {\
            margin: 0;\
            font-size: 15px;\
            color: #475569;\
            line-height: 1.6;\
        }\
        #input_3_57 {\
            pointer-events: auto !important;\
            z-index: 10 !important;\
            opacity: 1 !important;\
        }\
        #generateNoteButton, #pushToDriveCentricButton, #pushToDriveCentricButton2, #viewTrimLevelsButton, .view-vehicle-info {\
            padding: 12px 24px;\
            font-size: 16px;\
            font-weight: 600;\
            color: #ffffff;\
            background: #2563eb;\
            border: none;\
            border-radius: 8px;\
            cursor: pointer;\
            transition: background 0.2s ease, transform 0.2s ease;\
        }\
        #generateNoteButton:hover, #pushToDriveCentricButton:hover, #pushToDriveCentricButton2:hover, #viewTrimLevelsButton:hover, .view-vehicle-info:hover {\
            background: #1d4ed8;\
            transform: translateY(-2px);\
        }\
        #notePopup {\
            position: fixed;\
            top: 50%;\
            left: 50%;\
            transform: translate(-50%, -50%);\
            width: 90%;\
            max-width: 600px;\
            max-height: 80vh;\
            background: #ffffff;\
            border-radius: 16px;\
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);\
            z-index: 1002;\
            overflow-y: auto;\
            padding: 30px;\
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;\
            animation: slideIn 0.3s ease-out;\
        }\
        #notePopupContent {\
            padding: 0;\
        }\
        #noteOverlay {\
            position: fixed;\
            top: 0;\
            left: 0;\
            width: 100%;\
            height: 100%;\
            background: rgba(0, 0, 0, 0.7);\
            z-index: 1001;\
            cursor: pointer;\
        }\
        .note-close-popup {\
            position: absolute;\
            top: 15px;\
            right: 15px;\
            padding: 10px 20px;\
            font-size: 16px;\
            font-weight: 600;\
            color: #ffffff;\
            background: #dc2626;\
            border: none;\
            border-radius: 8px;\
            cursor: pointer;\
            transition: background 0.2s ease, transform 0.2s ease;\
        }\
        .note-close-popup:hover {\
            background: #b91c1c;\
            transform: scale(1.05);\
        }\
        .note-header {\
            margin-bottom: 20px;\
            text-align: center;\
        }\
        .note-header h2 {\
            margin: 0;\
            font-size: 24px;\
            color: #1e293b;\
            font-weight: 700;\
        }\
        .note-list {\
            list-style: none;\
            padding: 0;\
            margin: 0 0 20px 0;\
        }\
        .note-item {\
            display: flex;\
            justify-content: space-between;\
            padding: 10px 0;\
            border-bottom: 1px solid #e2e8f0;\
        }\
        .note-label {\
            font-weight: 600;\
            color: #334155;\
            flex: 1;\
        }\
        .note-value {\
            color: #475569;\
            flex: 2;\
            text-align: right;\
        }\
        .copy-note-button {\
            display: block;\
            margin: 0 auto;\
            padding: 12px 24px;\
            font-size: 16px;\
            font-weight: 600;\
            color: #ffffff;\
            background: #16a34a;\
            border: none;\
            border-radius: 8px;\
            cursor: pointer;\
            transition: background 0.2s ease, transform 0.2s ease;\
        }\
        .copy-note-button:hover {\
            background: #15803d;\
            transform: translateY(-2px);\
        }\
        #featurePopup {\
            position: fixed;\
            top: 50%;\
            left: 50%;\
            transform: translate(-50%, -50%);\
            width: 90%;\
            max-width: 500px;\
            max-height: 70vh;\
            background: #ffffff;\
            border-radius: 12px;\
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);\
            z-index: 1003;\
            overflow-y: auto;\
            padding: 25px;\
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;\
            animation: slideIn 0.3s ease-out;\
        }\
        #featurePopupContent {\
            padding: 0;\
        }\
        #featureOverlay {\
            position: fixed;\
            top: 0;\
            left: 0;\
            width: 100%;\
            height: 100%;\
            background: rgba(0, 0, 0, 0.7);\
            z-index: 1002;\
            cursor: pointer;\
        }\
        .feature-close-popup {\
            position: absolute;\
            top: 15px;\
            right: 15px;\
            padding: 8px 16px;\
            font-size: 14px;\
            font-weight: 600;\
            color: #ffffff;\
            background: #dc2626;\
            border: none;\
            border-radius: 8px;\
            cursor: pointer;\
            transition: background 0.2s ease, transform 0.2s ease;\
        }\
        .feature-close-popup:hover {\
            background: #b91c1c;\
            transform: scale(1.05);\
        }\
        .feature-header {\
            margin-bottom: 20px;\
            text-align: center;\
        }\
        .feature-header h2 {\
            margin: 0;\
            font-size: 22px;\
            color: #1e293b;\
            font-weight: 700;\
        }\
        .feature-description {\
            font-size: 15px;\
            color: #475569;\
            line-height: 1.6;\
            margin: 0;\
        }\
        .feature-info-icon {\
            display: inline-flex;\
            align-items: center;\
            justify-content: center;\
            width: 20px;\
            height: 20px;\
            margin-right: 5px;\
            font-size: 14px;\
            font-weight: bold;\
            color: #ffffff !important;\
            background: #2563eb !important;\
            border-radius: 50%;\
            cursor: pointer;\
            transition: background 0.2s ease, transform 0.2s ease;\
            z-index: 10 !important;\
            position: relative;\
            text-decoration: none !important;\
        }\
        .feature-info-icon:hover {\
            background: #1d4ed8 !important;\
            transform: scale(1.1);\
        }\
        .gfield_checkbox .feature-info-icon {\
            pointer-events: auto !important;\
        }\
        #trimLevelsPopup {\
            position: fixed;\
            top: 50%;\
            left: 50%;\
            transform: translate(-50%, -50%);\
            width: 90%;\
            max-width: 1500px;\
            max-height: 80vh;\
            background: #ffffff;\
            border-radius: 16px;\
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);\
            z-index: 1004;\
            overflow-y: auto;\
            padding: 30px;\
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;\
            animation: slideIn 0.3s ease-out;\
        }\
        #trimLevelsPopupContent {\
            padding: 0;\
        }\
        #trimLevelsOverlay {\
            position: fixed;\
            top: 0;\
            left: 0;\
            width: 100%;\
            height: 100%;\
            background: rgba(0, 0, 0, 0.7);\
            z-index: 1003;\
            cursor: pointer;\
        }\
        .trim-close-popup {\
            position: absolute;\
            top: 15px;\
            right: 15px;\
            padding: 10px 20px;\
            font-size: 16px;\
            font-weight: 600;\
            color: #ffffff;\
            background: #dc2626;\
            border: none;\
            border-radius: 8px;\
            cursor: pointer;\
            transition: background 0.2s ease, transform 0.2s ease;\
        }\
        .trim-close-popup:hover {\
            background: #b91c1c;\
            transform: scale(1.05);\
        }\
        .trim-header {\
            margin-bottom: 20px;\
            text-align: center;\
        }\
        .trim-header h2 {\
            margin: 0;\
            font-size: 24px;\
            color: #1e293b;\
            font-weight: 700;\
        }\
        .trim-table-container {\
            overflow-x: auto;\
            margin-bottom: 20px;\
        }\
        .trim-table {\
            width: 100%;\
            border-collapse: collapse;\
            background: #f8fafc;\
            border-radius: 8px;\
            overflow: hidden;\
        }\
        .trim-table th, .trim-table td {\
            padding: 12px 15px;\
            text-align: left;\
            font-size: 12.6px;\
            color: #334155;\
            border-bottom: 1px solid #e2e8f0;\
            min-width: 100px;\
        }\
        .trim-table th {\
            background: #2563eb;\
            color: #ffffff;\
            font-weight: 600;\
            cursor: pointer;\
            transition: background 0.2s ease;\
        }\
        .trim-table th:hover {\
            background: #1d4ed8;\
        }\
        .trim-table td {\
            background: #ffffff;\
        }\
        .trim-table tr:hover td {\
            background: #f1f5f9;\
        }\
        .trim-table a {\
            color: #2563eb;\
            text-decoration: none;\
            font-weight: 500;\
        }\
        .trim-table a:hover {\
            text-decoration: underline;\
            color: #1d4ed8;\
        }\
        .copy-stock-link {\
            margin-left: 10px;\
            font-size: 12.6px;\
            cursor: pointer;\
        }\
        .feature-groups {\
            display: grid;\
            grid-template-columns: repeat(5, 1fr);\
            gap: 20px;\
        }\
        .feature-column h4 {\
            text-align: center;\
            font-size: 16px;\
            margin-bottom: 10px;\
        }\
        @media (max-width: 768px) {\
            #notePopup, #vehiclePopup, #featurePopup, #trimLevelsPopup {\
                width: 95%;\
                padding: 20px;\
            }\
            .note-item {\
                flex-direction: column;\
                gap: 5px;\
            }\
            .note-value {\
                text-align: left;\
            }\
            .swiper-container {\
                height: 250px;\
            }\
            .trim-table th, .trim-table td {\
                font-size: 10.8px;\
                padding: 8px 10px;\
                min-width: 80px;\
            }\
            .copy-stock-link {\
                font-size: 10.8px;\
            }\
            .feature-groups {\
                grid-template-columns: repeat(2, 1fr);\
            }\
        }\
        /* Terrain checkbox spacing */\
        .gchoice[class*="gchoice_terrain_"] {\
            margin-bottom: 4% !important;\
            padding-bottom: 4px;\
        }\
        /* Acadia checkbox spacing */\
        .gchoice[class*="gchoice_acadia_"] {\
            margin-bottom: 4% !important;\
            padding-bottom: 4px;\
        }\
        /* Yukon checkbox spacing */\
        .gchoice[class*="gchoice_yukon_"] {\
            margin-bottom: 4% !important;\
            padding-bottom: 4px;\
        }';
    $('head').append('<style id="popupStyles">' + cssStyles + '</style>');
    console.log('Inline vehicle popup, Field 57, Generate Note, feature popup, trim levels popup, and Push to DriveCentric buttons CSS appended');

    // Dynamically get Form ID
    var form = $('.gform_wrapper form');
    var formId = form.attr('id') ? form.attr('id').replace('gform_', '') : '3';
    console.log('Form ID: ' + formId);

    // Field IDs
    var stockFieldId = 20;
    var yearFieldId = 21;
    var makeFieldId = 23;
    var modelFieldId = 22;
    var stockKiaFieldId = 80;
    var yearKiaFieldId = 82;
    var makeKiaFieldId = 83;
    var modelKiaFieldId = 84;
    var yearFoundFieldId = 124;
    var makeFoundFieldId = 138;
    var modelFoundFieldId = 126;
    var customerCommentFieldId = 113;
    var availabilityFieldId = 26;
    var tradeInQuestionFieldId = 27;
    var buttonContainerFieldId = 49;
    var buttonContainerFieldId2 = 127;
    var tradeInYearFieldId = 36;
    var tradeInMakeFieldId = 37;
    var tradeInModelFieldId = 38;
    var tradeInAltYearFieldId = 66;
    var tradeInAltMakeFieldId = 67;
    var tradeInAltModelFieldId = 70;
    var videoMessageFieldId = 43;
    var nameFieldId = 44;
    var phoneFieldId = 45;
    var emailFieldId = 46;
    var textReceiptFieldId = 48;
    var textReceiptFieldId2 = 121;
    var managerFieldId = 13;
    var salespersonFieldId = 12;
    var bdcRepFieldId = 14;
    var gmcManagerFieldId = 104;
    var gmcSalespersonFieldId = 105;
    var gmcBdcRepFieldId = 106;
    var hiddenFieldId = 19;
    var radioFieldId = 17;
    var dealershipFieldId = 11;
    var dateFieldId = 52;
    var timePeriodFieldId = 53;
    var appointmentConfirmationFieldId = 57;
    var generateNoteFieldId = 60;
    var k4CheckboxFieldId = 64;
    var k5CheckboxFieldId = 85;
    var carnivalHybridCheckboxFieldId = 98;
    var carnivalCheckboxFieldId = 86;
    var ev6CheckboxFieldId = 101;
    var ev9CheckboxFieldId = 102;
    var niroEvCheckboxFieldId = 100;
    var niroHybridCheckboxFieldId = 95;
    var seltosCheckboxFieldId = 89;
    var sorentoHybridCheckboxFieldId = 97;
    var sorentoCheckboxFieldId = 92;
    var soulCheckboxFieldId = 88;
    var sportageCheckboxFieldId = 91;
    var sportageHybridCheckboxFieldId = 96;
    var tellurideCheckboxFieldId = 93;
    var htmlBlockFieldId = 69;
    var trimLevelsButtonFieldId = 112;
    var nameFieldId2 = 117;
    var phoneFieldId2 = 118;
    var emailFieldId2 = 119;
    var gmcModelFieldId = 107;
    var terrainCheckboxFieldId = 129;
    var terrainHtmlBlockFieldId = 137;
    var acadiaCheckboxFieldId = 138;
    var acadiaHtmlBlockFieldId = 138;
    var yukonCheckboxFieldId = 139;
    var yukonHtmlBlockFieldId = 139;
    var canyonCheckboxFieldId = 140;
    var canyonHtmlBlockFieldId = 140;

    // Global variables
    var vehicleData = null;
    var vehicleKiaData = null;
    var currentSwiper = null;
    var isProcessingClick = false;
    var serviceData = { trade: {}, tradeAlt: { year: '', make: '', model: '' }, new: {}, dealership: '' };
    var checkCustomerInfoCounter = 0;
    var featureDescriptions = {};
    var trimLevelsData = {};
    var terrainPopulated = false;
    var acadiaPopulated = false;
    var yukonPopulated = false;
    var canyonPopulated = false;
    
    // Function to find best description match with fuzzy matching for typos
    function findBestDescriptionMatch(searchFeature, descriptionMap) {
        console.log('üîç Fuzzy matching for:', searchFeature);
        console.log('Available keys:', Object.keys(descriptionMap));
        
        // Handle specific known typos first
        var typoMap = {
            'COMPATABILITY': 'COMPATIBILITY',
            'INFOTAINTMENT': 'INFOTAINMENT'
        };
        
        // Check if we need to fix a common typo
        var correctedFeature = searchFeature;
        for (var typo in typoMap) {
            if (searchFeature.indexOf(typo) !== -1) {
                correctedFeature = searchFeature.replace(typo, typoMap[typo]);
                console.log('üîß Corrected typo:', searchFeature, '->', correctedFeature);
                if (descriptionMap[correctedFeature]) {
                    console.log('‚úÖ Direct match found after typo correction');
                    return descriptionMap[correctedFeature];
                }
            }
        }
        
        var bestMatch = null;
        var highestSimilarity = 0;
        var threshold = 0.7; // Lower threshold for better matching
        
        for (var key in descriptionMap) {
            var similarity = calculateSimilarity(correctedFeature, key);
            console.log('Similarity between "' + correctedFeature + '" and "' + key + '": ' + similarity);
            
            if (similarity > highestSimilarity && similarity >= threshold) {
                highestSimilarity = similarity;
                bestMatch = descriptionMap[key];
                console.log('‚úÖ New best match found: "' + key + '" with similarity ' + similarity);
            }
        }
        
        if (bestMatch) {
            console.log('üéØ Best match found with similarity:', highestSimilarity);
        } else {
            console.log('‚ùå No fuzzy match found above threshold', threshold);
        }
        
        return bestMatch;
    }
    
    // Function to calculate similarity between two strings
    function calculateSimilarity(str1, str2) {
        // Simple Levenshtein distance based similarity
        var longer = str1.length > str2.length ? str1 : str2;
        var shorter = str1.length > str2.length ? str2 : str1;
        
        if (longer.length === 0) return 1.0;
        
        var distance = levenshteinDistance(longer, shorter);
        return (longer.length - distance) / longer.length;
    }
    
    // Function to calculate Levenshtein distance between two strings
    function levenshteinDistance(str1, str2) {
        var matrix = [];
        
        for (var i = 0; i <= str2.length; i++) {
            matrix[i] = [i];
        }
        
        for (var j = 0; j <= str1.length; j++) {
            matrix[0][j] = j;
        }
        
        for (i = 1; i <= str2.length; i++) {
            for (j = 1; j <= str1.length; j++) {
                if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                    matrix[i][j] = matrix[i - 1][j - 1];
                } else {
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j - 1] + 1, // substitution
                        matrix[i][j - 1] + 1,     // insertion
                        matrix[i - 1][j] + 1      // deletion
                    );
                }
            }
        }
        
        return matrix[str2.length][str1.length];
    }

    // Model to field ID, CSV URL, and model filter mappings
    var modelConfigs = {
        'K4': { fieldId: k4CheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/kiamodels/K4.csv', modelFilter: 'K4' },
        'K5': { fieldId: k5CheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/kiamodels/K5.csv', modelFilter: 'K5' },
        'CARNIVAL-HYBRID': { fieldId: carnivalHybridCheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/kiamodels/CARNIVAL-HYBRID.csv', modelFilter: 'Carnival Hybrid' },
        'CARNIVAL': { fieldId: carnivalCheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/kiamodels/CARNIVAL.csv', modelFilter: 'Carnival' },
        'EV6': { fieldId: ev6CheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/kiamodels/EV6.csv', modelFilter: 'EV6' },
        'EV9': { fieldId: ev9CheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/kiamodels/EV9.csv', modelFilter: 'EV9' },
        'NIRO-EV': { fieldId: niroEvCheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/kiamodels/NIRO-EV.csv', modelFilter: 'Niro' },
        'NIROHYBRID': { fieldId: niroHybridCheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/kiamodels/NIROHYBRID.csv', modelFilter: 'Niro' },
        'SELTOS': { fieldId: seltosCheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/kiamodels/SELTOS1.csv', modelFilter: 'Seltos' },
        'SORENTO-HYBRID': { fieldId: sorentoHybridCheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/kiamodels/SORENTO-HYBRID.csv', modelFilter: 'Sorento Hybrid' },
        'SORENTO': { fieldId: sorentoCheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/kiamodels/SORENTO.csv', modelFilter: 'Sorento' },
        'SOUL': { fieldId: soulCheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/kiamodels/SOUL.csv', modelFilter: 'Soul' },
        'SPORTAGE': { fieldId: sportageCheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/kiamodels/SPORTAGE.csv', modelFilter: 'Sportage' },
        'SPORTAGE-HYBRID': { fieldId: sportageHybridCheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/kiamodels/SPORTAGE-HYBRID.csv', modelFilter: 'Sportage Hybrid' },
        'TELLURIDE': { fieldId: tellurideCheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/kiamodels/TELLURIDE.csv', modelFilter: 'Telluride' },
        'TERRAIN': { fieldId: terrainCheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/gmcmodels/terrain.csv', modelFilter: 'Terrain', isGmc: true },
        'ACADIA': { fieldId: acadiaCheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/gmcmodels/acadia.csv', modelFilter: 'Acadia', isGmc: true },
        'YUKON': { fieldId: yukonCheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/gmcmodels/yukon.csv', modelFilter: 'Yukon', isGmc: true },
        'CANYON': { fieldId: canyonCheckboxFieldId, csvUrl: 'https://hutchinsonautoteam.com/gmcmodels/canyon.csv', modelFilter: 'Canyon', isGmc: true }
    };

    // Email mappings
    var emailMappings = {
        'Kia of Macon': {
            'Cullen Young': 'cullenyoung@drivekiaofmacon.com',
            'Hunter Holland': 'hunterholland@drivekiaofmacon.com',
            'Jacob Driggers': 'jacobdriggers@drivekiaofmacon.com',
            'Jake Perez': 'jakeperez@drivekiaofmacon.com',
            'John Hall': 'johnhall@drivekiaofmacon.com',
            'John West': 'johnwest@drivekiaofmacon.com',
            'Jose Ortiz': 'joseortiz@drivekiaofmacon.com',
            'Justin Williams': 'justinwilliams@drivekiaofmacon.com',
            'Marc Romage': 'marcromage@drivekiaofmacon.com',
            'Patrick Davis': 'patrickdavis@drivekiaofmacon.com',
            'Paul Warren': 'paulwarren@drivekiaofmacon.com',
            'Andrew Olson': 'andrewolson@drivekiaofmacon.com',
            'Bailey Bryant': 'baileybryant@drivekiaofmacon.com',
            'Joseph Muhammed': 'josephmuhammad@drivekiaofmacon.com',
            'Phillip Mitchell': 'phillipmitchell@drivekiaofmacon.com',
            'Sharaz Hassan': 'sharazhassan@drivekiaofmacon.com',
            'Caroline Harvey': 'carolineharvey@drivekiaofmacon.com',
            'Chase Winters': 'chasewinters@drivekiaofmacon.com',
            'Dawn Alston': 'dawnalston@drivekiaofmacon.com',
            'Marlanna Brooks': 'marlannabrooks@drivekiaofmacon.com',
            'Pamela Johnson': 'pamelajohnson@drivekiaofmacon.com',
            'Sauda Glenn': 'saudaglenn@drivekiaofmacon.com'
        },
        'GMC Cadillac': {
            'Austin Altenau': 'austinaltenau@drivehutchinsoncadillac.com',
            'Austin Clark': 'austinclark@drivehutchinsoncadillac.com',
            'Byron James': 'byronjames@drivehutchinsoncadillac.com',
            'Eric Anderson': 'ericanderson@drivehutchinsoncadillac.com',
            'Gregory Fluellen': 'gregoryfluellen@drivehutchinsoncadillac.com',
            'Nicholas Gargiulo': 'nicholasgargiulo@drivehutchinsoncadillac.com',
            'Rose Rostro': 'roserostro@drivehutchinsoncadillac.com',
            'Gregory Clark': 'gregoryclark@drivehutchinsoncadillac.com',
            'Bradley Nichols': 'bradleynichols@drivehutchinsoncadillac.com',
            'James Watkins': 'jameswatkins@drivehutchinsoncadillac.com',
            'Ryan Rock': 'ryanrock@drivehutchinsoncadillac.com',
            'Caroline Harvey': 'carolineharvey@drivehutchinsoncadillac.com',
            'Chase Winters': 'chasewinters@drivehutchinsoncadillac.com',
            'Dawn Alston': 'dawnalston@drivehutchinsoncadillac.com',
            'Marlanna Brooks': 'marlannabrooks@drivehutchinsoncadillac.com',
            'Pamela Johnson': 'pamelajohnson@drivehutchinsoncadillac.com',
            'Sauda Glenn': 'saudaglenn@drivehutchinsoncadillac.com'
        }
    };

    // Fetch CSV with retry mechanism
    function fetchCsvWithRetry(url, identifier, maxRetries, retryDelay) {
        let attempt = 0;
        function tryFetch(resolve, reject) {
            console.log(`Fetching ${identifier} CSV, attempt ${attempt + 1} of ${maxRetries}: ${url}`);
            $.ajax({
                url: url,
                method: 'GET',
                success: function(csvText) {
                    if (!csvText || csvText.trim() === '') {
                        console.warn(`${identifier} CSV is empty, length: ${csvText.length}`);
                        reject(new Error('Empty CSV file'));
                        return;
                    }
                    csvText = csvText.replace(/\r\n|\r/g, '\n').replace(/\n+/g, '\n').trim();
                    console.log(`${identifier} CSV fetched successfully, length: ${csvText.length} characters, first 100 chars: ${csvText.substring(0, 100)}`);
                    resolve(csvText);
                },
                error: function(xhr, status, error) {
                    attempt++;
                    console.error(`Error fetching ${identifier} CSV, attempt ${attempt}: ${status} - ${error}`, {
                        statusCode: xhr.status,
                        responseText: xhr.responseText || 'No response'
                    });
                    if (attempt < maxRetries) {
                        setTimeout(() => tryFetch(resolve, reject), retryDelay * Math.pow(2, attempt));
                    } else {
                        reject(new Error(`Failed to fetch ${identifier} CSV after ${maxRetries} attempts: ${error}`));
                    }
                }
            });
        }
        return new Promise((resolve, reject) => tryFetch(resolve, reject));
    }

    // Load feature descriptions from CSV or JavaScript content
    function loadFeatureDescriptions() {
        var csvUrl = 'https://hutchinsonautoteam.com/kiamodels/KIAMODELDESCRIPTIONS.CSV';
        fetchCsvWithRetry(csvUrl, 'Feature Descriptions', 3, 1000).then(function(csvText) {
            if (csvText.trim().startsWith('//') || csvText.trim().startsWith('var featureDescriptions = {')) {
                console.log('Detected JavaScript content in Feature Descriptions file');
                try {
                    var objMatch = csvText.match(/var featureDescriptions = ({[\s\S]*?});/);
                    if (!objMatch || !objMatch[1]) {
                        throw new Error('Could not extract valid JavaScript object');
                    }
                    var objString = objMatch[1];
                    featureDescriptions = eval('(' + objString + ')');
                    console.log('Feature Descriptions parsed from JavaScript, features: ' + Object.keys(featureDescriptions).length);
                    if (Object.keys(featureDescriptions).length === 0) {
                        console.warn('Parsed featureDescriptions object is empty');
                        alert('Warning: Feature Descriptions file contains an empty object. Feature descriptions will not be available. Please verify the file at ' + csvUrl);
                    }
                } catch (error) {
                    console.error('Error parsing JavaScript content for Feature Descriptions: ' + error.message, {
                        rawContent: csvText.substring(0, 500)
                    });
                    featureDescriptions = {};
                    alert('Error: Failed to parse Feature Descriptions file (JavaScript format). Please ensure the file at ' + csvUrl + ' contains a valid JavaScript object or contact support.');
                }
            } else {
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        console.log('Feature Descriptions CSV parsed, rows: ' + results.data.length);
                        if (results.data.length === 0 || !results.meta.fields.includes('Feature') || !results.meta.fields.includes('Description')) {
                            console.error('Feature Descriptions CSV missing required columns or empty', {
                                headers: results.meta.fields || [],
                                firstRow: results.data[0] || 'None',
                                rawContent: csvText.substring(0, 500)
                            });
                            featureDescriptions = {};
                            alert('Error: Feature Descriptions CSV is empty or missing required columns (Feature, Description). Please verify the file at ' + csvUrl + ' or contact support.');
                            return;
                        }
                        featureDescriptions = {};
                        results.data.forEach(function(row) {
                            var feature = row['Feature'] ? row['Feature'].trim().toUpperCase() : '';
                            var description = row['Description'] ? row['Description'].trim() : '';
                            if (feature && description) {
                                featureDescriptions[feature] = description;
                            } else {
                                console.warn('Skipping invalid feature row:', { feature: feature, description: description });
                            }
                        });
                        console.log('Feature Descriptions loaded from CSV, features: ' + Object.keys(featureDescriptions).length);
                        if (Object.keys(featureDescriptions).length === 0) {
                            console.warn('No valid features loaded from CSV');
                            alert('Warning: No valid feature descriptions loaded from CSV. Please verify the file at ' + csvUrl);
                        }
                    },
                    error: function(error) {
                        console.error('Papa Parse error for Feature Descriptions CSV: ' + error);
                        featureDescriptions = {};
                        alert('Error: Failed to parse Feature Descriptions CSV. Please ensure the file at ' + csvUrl + ' is a valid CSV with Feature and Description columns or contact support.');
                    }
                });
            }
        }).catch(function(error) {
            console.error('Fetch error for Feature Descriptions: ' + error.message);
            featureDescriptions = {};
            alert('Error: Unable to load Feature Descriptions file. Please check the file at ' + csvUrl + ' or contact support.');
        });
    }

    // Load GMC Terrain feature descriptions from CSV
    var terrainFeatureDescriptions = {};
    function loadTerrainFeatureDescriptions() {
        var csvUrl = 'https://hutchinsonautoteam.com/gmcmodels/gmcterraindescriptions.csv';
        console.log('üî• TERRAIN DESCRIPTIONS - Loading GMC Terrain descriptions from:', csvUrl);
        fetchCsvWithRetry(csvUrl, 'GMC Terrain Feature Descriptions', 3, 1000).then(function(csvText) {
            console.log('GMC Terrain descriptions CSV fetched successfully, length:', csvText.length);
            console.log('First 500 characters of CSV:', csvText.substring(0, 500));
            
            // Parse the CSV - handle {FEATURE:DESCRIPTION} format
            terrainFeatureDescriptions = {};
            
            // The CSV format is: {FEATURE :DESCRIPTION}
            // Split by } to get each feature block
            var blocks = csvText.split('}');
            console.log('Total terrain blocks found:', blocks.length);
            
            for (var i = 0; i < blocks.length; i++) {
                var block = blocks[i].trim();
                if (block.length > 0) {
                    console.log('Processing terrain block ' + i + ':', block.substring(0, 100));
                    
                    // Remove opening { and find the colon separator
                    block = block.replace(/^{/, '');
                    var colonIndex = block.indexOf(':');
                    
                    if (colonIndex > 0) {
                        var feature = block.substring(0, colonIndex).trim().toUpperCase();
                        var description = block.substring(colonIndex + 1).trim();
                        
                        // Clean up the description
                        description = description.replace(/^"|"$/g, '');
                        
                        terrainFeatureDescriptions[feature] = description;
                        console.log('‚úÖ Terrain feature stored:', feature, '=', description.substring(0, 100));
                    } else {
                        console.log('‚ö†Ô∏è Could not parse terrain block (no colon found):', block.substring(0, 100));
                    }
                }
            }
            
            console.log('GMC Terrain Feature Descriptions loaded, features:', Object.keys(terrainFeatureDescriptions).length);
            console.log('Sample features loaded:', Object.keys(terrainFeatureDescriptions).slice(0, 5));
            console.log('All terrain features loaded:', Object.keys(terrainFeatureDescriptions));
            if (Object.keys(terrainFeatureDescriptions).length === 0) {
                console.warn('No GMC Terrain descriptions were parsed from CSV');
            } else {
                console.log('SUCCESS: GMC Terrain descriptions loaded successfully!');
            }
        }).catch(function(error) {
            console.error('Fetch error for GMC Terrain Feature Descriptions:', error.message);
            terrainFeatureDescriptions = {};
        });
    }

    // Load GMC Acadia feature descriptions from CSV
    var acadiaFeatureDescriptions = {};
    function loadAcadiaFeatureDescriptions() {
        var csvUrl = 'https://www.hutchinsonautoteam.com/gmcmodels/gmcacadiadescriptions.csv';
        console.log('üî• ACADIA DESCRIPTIONS - Loading GMC Acadia descriptions from:', csvUrl);
        fetchCsvWithRetry(csvUrl, 'GMC Acadia Feature Descriptions', 3, 1000).then(function(csvText) {
            console.log('GMC Acadia descriptions CSV fetched successfully, length:', csvText.length);
            console.log('First 500 characters of CSV:', csvText.substring(0, 500));
            
            // Parse the CSV - handle {FEATURE:DESCRIPTION} format
            acadiaFeatureDescriptions = {};
            
            // The CSV format is: {FEATURE :DESCRIPTION}
            // Split by } to get each feature block
            var blocks = csvText.split('}');
            console.log('Total acadia blocks found:', blocks.length);
            
            for (var i = 0; i < blocks.length; i++) {
                var block = blocks[i].trim();
                if (block.length > 0) {
                    console.log('Processing acadia block ' + i + ':', block.substring(0, 100));
                    
                    // Remove opening { and find the colon separator
                    block = block.replace(/^{/, '');
                    var colonIndex = block.indexOf(':');
                    
                    if (colonIndex > 0) {
                        var feature = block.substring(0, colonIndex).trim().toUpperCase();
                        var description = block.substring(colonIndex + 1).trim();
                        
                        // Clean up the description
                        description = description.replace(/^"|"$/g, '');
                        
                        acadiaFeatureDescriptions[feature] = description;
                        console.log('‚úÖ Acadia feature stored:', feature, '=', description.substring(0, 100));
                    } else {
                        console.log('‚ö†Ô∏è Could not parse acadia block (no colon found):', block.substring(0, 100));
                    }
                }
            }
            
            console.log('GMC Acadia Feature Descriptions loaded, features:', Object.keys(acadiaFeatureDescriptions).length);
            console.log('Sample features loaded:', Object.keys(acadiaFeatureDescriptions).slice(0, 5));
            console.log('All acadia features loaded:', Object.keys(acadiaFeatureDescriptions));
            if (Object.keys(acadiaFeatureDescriptions).length === 0) {
                console.warn('No GMC Acadia descriptions were parsed from CSV');
            } else {
                console.log('SUCCESS: GMC Acadia descriptions loaded successfully!');
            }
        }).catch(function(error) {
            console.error('Fetch error for GMC Acadia Feature Descriptions:', error.message);
            acadiaFeatureDescriptions = {};
        });
    }

    // Load GMC Yukon feature descriptions from CSV
    var yukonFeatureDescriptions = {};
    function loadYukonFeatureDescriptions() {
        var csvUrl = 'https://hutchinsonautoteam.com/gmcmodels/gmcyukondescriptions.csv';
        console.log('üî• YUKON DESCRIPTIONS - Loading GMC Yukon descriptions from:', csvUrl);
        fetchCsvWithRetry(csvUrl, 'GMC Yukon Feature Descriptions', 3, 1000).then(function(csvText) {
            console.log('GMC Yukon descriptions CSV fetched successfully, length:', csvText.length);
            console.log('First 500 characters of CSV:', csvText.substring(0, 500));
            
            // Parse the CSV - handle complex format with curly braces and colon separators
            yukonFeatureDescriptions = {};
            
            // Split by lines and process each line
            var lines = csvText.split('\n').filter(function(line) { return line.trim(); });
            
            lines.forEach(function(line, index) {
                try {
                    // Each line should be in format: {FEATURE NAME:DESCRIPTION}
                    var match = line.match(/^\{([^:]+):(.+)\}$/);
                    if (match) {
                        var feature = match[1].trim();
                        var description = match[2].trim();
                        
                        // Store with case-insensitive key for matching
                        yukonFeatureDescriptions[feature.toUpperCase()] = description;
                        console.log('Loaded GMC Yukon description for:', feature);
                    } else {
                        console.warn('Could not parse yukon description line:', line.substring(0, 100));
                    }
                } catch (error) {
                    console.error('Error parsing yukon description line:', error, line.substring(0, 100));
                }
            });
            
            console.log('GMC Yukon Feature Descriptions loaded, features:', Object.keys(yukonFeatureDescriptions).length);
            console.log('Sample features loaded:', Object.keys(yukonFeatureDescriptions).slice(0, 5));
            console.log('All yukon features loaded:', Object.keys(yukonFeatureDescriptions));
            if (Object.keys(yukonFeatureDescriptions).length === 0) {
                console.warn('No GMC Yukon descriptions were parsed from CSV');
            } else {
                console.log('SUCCESS: GMC Yukon descriptions loaded successfully!');
            }
        }).catch(function(error) {
            console.error('Fetch error for GMC Yukon Feature Descriptions:', error.message);
            yukonFeatureDescriptions = {};
        });
    }

    // Global variable for Canyon feature descriptions
    var canyonFeatureDescriptions = {};
    
    // Load Canyon feature descriptions
    function loadCanyonFeatureDescriptions() {
        var canyonDescriptionsUrl = 'https://hutchinsonautoteam.com/gmcmodels/gmccanyondescriptions.csv';
        console.log('Loading Canyon feature descriptions from:', canyonDescriptionsUrl);
        
        fetch(canyonDescriptionsUrl)
        .then(function(response) {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(function(csvText) {
            console.log('Raw Canyon descriptions CSV:', csvText);
            canyonFeatureDescriptions = {};
            
            // Parse CSV text line by line
            var lines = csvText.split('\n');
            lines.forEach(function(line) {
                if (line.trim() && line.includes('{') && line.includes('}')) {
                    // Find the closing brace
                    var closingBraceIndex = line.indexOf('}');
                    if (closingBraceIndex !== -1) {
                        var feature = line.substring(1, closingBraceIndex);
                        var description = line.substring(closingBraceIndex + 2);
                        if (feature && description) {
                            canyonFeatureDescriptions[feature] = description;
                        }
                    }
                }
            });
            
            console.log('Parsed Canyon feature descriptions:', canyonFeatureDescriptions);
            
            if (Object.keys(canyonFeatureDescriptions).length === 0) {
                console.warn('WARNING: No Canyon feature descriptions loaded!');
            } else {
                console.log('SUCCESS: GMC Canyon descriptions loaded successfully!');
            }
        }).catch(function(error) {
            console.error('Fetch error for GMC Canyon Feature Descriptions:', error.message);
            canyonFeatureDescriptions = {};
        });
    }

    // Fuzzy matching function with exact matching for K4 and validation
    function fuzzyMatch(str1, str2, model, feature) {
        if (!str1 || !str2 || typeof str1 !== 'string' || typeof str2 !== 'string' || str1.trim() === '' || str2.trim() === '') {
            console.warn(`Fuzzy match aborted: invalid inputs for ${model} feature`, {
                str1: str1,
                str2: str2,
                feature: feature
            });
            return false;
        }

        str1 = str1.toLowerCase().replace(/[^a-z0-9]/g, '');
        str2 = str2.toLowerCase().replace(/[^a-z0-9]/g, '');

        var colorKeywords = ['white', 'gray', 'black', 'red', 'blue', 'haze', 'silver', 'chrome', 'paint', 'pearl'];
        var isColorFeature = colorKeywords.some(function(keyword) {
            return str1.includes(keyword) || str2.includes(keyword);
        });
        if (model === 'K4' && !isColorFeature && colorKeywords.some(function(keyword) { return str2.includes(keyword); })) {
            console.log(`Skipping color comparison for ${model} feature "${str1}" vs "${str2}"`);
            return false;
        }

        if (model === 'K4') {
            console.log(`Exact match for ${model} feature "${str1}" vs "${str2}"`);
            return str1 === str2;
        }

        var threshold = 0.8;

        function levenshtein(a, b) {
            var matrix = [];
            for (var i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }
            for (var j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }
            for (i = 1; i <= b.length; i++) {
                for (j = 1; j <= a.length; j++) {
                    if (b.charAt(i-1) === a.charAt(j-1)) {
                        matrix[i][j] = matrix[i-1][j-1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i-1][j-1] + 1,
                            matrix[i][j-1] + 1,
                            matrix[i-1][j] + 1
                        );
                    }
                }
            }
            return matrix[b.length][a.length];
        }

        if (str1 === str2) return true;
        var distance = levenshtein(str1, str2);
        var maxLength = Math.max(str1.length, str2.length);
        var similarity = 1 - distance / maxLength;
        console.log(`Fuzzy match for ${model} feature "${str1}" vs "${str2}": similarity=${similarity}, threshold=${threshold}`);
        return similarity >= threshold;
    }

    // Function to show feature description popup
    function showFeatureDescription(feature, description) {
        $('#featurePopup, #featureOverlay').remove();

        var popupHtml = '\
            <div id="featurePopup">\
                <div id="featurePopupContent">\
                    <div class="feature-header">\
                        <h2>' + feature + '</h2>\
                    </div>\
                    <p class="feature-description">' + description + '</p>\
                </div>\
                <button type="button" class="feature-close-popup">Close</button>\
            </div>\
            <div id="featureOverlay"></div>';

        $('body').append(popupHtml);

        var popup = $('#featurePopup');
        var overlay = $('#featureOverlay');

        console.log('Feature popup created for: ' + feature);

        overlay.on('click', function(e) {
            if (e.target.id === 'featureOverlay') {
                console.log('Feature overlay clicked, closing popup');
                $('#featurePopup, #featureOverlay').remove();
            }
        });

        popup.find('.feature-close-popup').on('click', function() {
            console.log('Feature close button clicked, closing popup');
            $('#featurePopup, #featureOverlay').remove();
        });
    }

    // Comments for Part 1/5
    /*
     * This is the updated Part 1/5 of the vehicle form script, extended to support dynamic population of GMC Terrain features in Field 129 when "GMC Cadillac" is selected in Field 11 and "TERRAIN" in Field 107, as requested.
     * Opens the jQuery(document).ready wrapper, to be closed in Part 5/5.
     * Loads external libraries (PapaParse 5.4.1, Swiper 8) synchronously.
     * Includes Swiper CSS for vehicle image galleries.
     * Updates CSS with .feature-groups { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; } and .feature-column h4 { text-align: center; font-size: 16px; margin-bottom: 10px; } for 5-column layout in Field 129, with media query for mobile.
     * Defines field IDs, including gmcModelFieldId (107) and terrainCheckboxFieldId (129).
     * Initializes global variables, adding terrainPopulated = false to track if Field 129 has been populated.
     * modelConfigs includes 'TERRAIN' with isGmc: true.
     * emailMappings unchanged.
     * fetchCsvWithRetry for CSV fetching with retries.
     * loadFeatureDescriptions for Kia features (GMC to be added later).
     * fuzzyMatch with exact for K4, fuzzy for others including Terrain.
     * showFeatureDescription for popups (prepared for GMC).
     * The new functionality dynamically populates Field 129 checkboxes from Terrain CSV, grouping into 5 columns (Exterior, Interior, Mechanical, Safety, Packages), replacing existing checkboxes, and enables trim level matching for Field 69.
     * Preserves original functionality: NHTSA API for trade-ins, conditional fields, trim popups, etc.
     * Uses the same UUID (249bbf27-292a-4f64-b802-771d4ded64e1) for continuity.
     * Title: 'scripts.js'
     * ContentType: text/javascript
     * Syntax verified with linter.
     * Ends with open brace for Part 2/5.
     * Meets minimum line requirement.
     */
	function populateTerrainFeatures() {
    console.log('=== populateTerrainFeatures called ===');
    console.log('Current terrainPopulated flag:', terrainPopulated);
    console.log('Form ID:', formId);
    console.log('terrainHtmlBlockFieldId:', terrainHtmlBlockFieldId);
    
    if (terrainPopulated) {
        console.log('Terrain features already populated, skipping');
        return;
    }

    var config = modelConfigs['TERRAIN'];
    if (!config) {
        console.warn('Terrain configuration not found');
        console.log('Available modelConfigs:', Object.keys(modelConfigs));
        return;
    }
    console.log('Terrain config found:', config);

    // Try multiple selectors to find the HTML block field
    console.log('Searching for HTML block field with multiple selectors...');
    var htmlBlock = $('#field_' + formId + '_' + terrainHtmlBlockFieldId);
    console.log('Selector 1 (#field_' + formId + '_' + terrainHtmlBlockFieldId + '):', htmlBlock.length);
    
    if (!htmlBlock.length) {
        htmlBlock = $('#field_' + formId + '_137');
        console.log('Selector 2 (#field_' + formId + '_137):', htmlBlock.length);
    }
    if (!htmlBlock.length) {
        htmlBlock = $('#input_' + formId + '_137');
        console.log('Selector 3 (#input_' + formId + '_137):', htmlBlock.length);
    }
    if (!htmlBlock.length) {
        htmlBlock = $('[id*="137"]').filter(function() {
            return $(this).attr('id').includes('field') || $(this).attr('id').includes('input');
        });
        console.log('Selector 4 (wildcard [id*="137"]):', htmlBlock.length);
    }
    
    // Log all elements with 137 in ID
    var all137Elements = $('[id*="137"]');
    console.log('All elements with 137 in ID:');
    all137Elements.each(function(i) {
        console.log('  ' + i + ': ' + this.id + ' (tag: ' + this.tagName + ', class: ' + $(this).attr('class') + ')');
    });
    
    console.log('HTML Block field (ID: 137) debug:', {
        selector: '#field_' + formId + '_' + terrainHtmlBlockFieldId,
        exists: htmlBlock.length > 0,
        visible: htmlBlock.length ? htmlBlock.is(':visible') : false,
        content: htmlBlock.length ? htmlBlock.html().substring(0, 200) : 'N/A',
        actualId: htmlBlock.length ? htmlBlock.attr('id') : 'N/A',
        allFields137: $('[id*="137"]').map(function() { return this.id; }).get()
    });
    
    if (!htmlBlock.length) {
        console.warn('Terrain HTML block field (ID: 137) not found with any selector');
        console.log('All form fields:', $('#gform_fields_' + formId).find('.gfield').map(function() { 
            return { id: $(this).attr('id'), class: $(this).attr('class') }; 
        }).get());
        
        // Try to find any HTML block field
        var allHtmlFields = $('[id*="field"][id*="' + formId + '"]').filter(function() {
            return $(this).find('.gfield_html').length > 0 || $(this).hasClass('gfield_html');
        });
        console.log('All HTML block fields found:', allHtmlFields.map(function() { return this.id; }).get());
        return;
    }

    console.log('Fetching terrain CSV from:', config.csvUrl);
    fetchCsvWithRetry(config.csvUrl, 'Terrain', 3, 1000).then(function(csvText) {
        console.log('Terrain CSV fetched successfully, length:', csvText.length);
        console.log('CSV preview (first 500 chars):', csvText.substring(0, 500));
        
        Papa.parse(csvText, {
            skipEmptyLines: true,
            complete: function(results) {
                console.log('Terrain CSV parsed for population, rows: ' + results.data.length);
                console.log('First few rows:', results.data.slice(0, 3));
                
                var categories = ['EXTERIOR', 'INTERIOR', 'MECHANICAL', 'SAFETY', 'PACKAGES'];
                var featureGroups = {};
                var currentCategory = null;
                var features = [];

                results.data.forEach(function(row, rowIndex) {
                    if (row.length > 0) {
                        var firstCell = row[0] ? row[0].trim() : '';
                        if (firstCell.startsWith('TRIM LEVELS FOR {')) {
                            if (currentCategory && features.length > 0) {
                                featureGroups[currentCategory] = features;
                                console.log('Stored category: ' + currentCategory + ' with ' + features.length + ' features');
                            }
                            currentCategory = firstCell.match(/\{(.+)\}/)[1];
                            // Clean up features by removing extra quotes and trimming
                            features = row.slice(1).filter(function(f) { return f && f.trim() !== ''; }).map(function(f) {
                                // Remove surrounding quotes if present
                                var cleaned = f.trim();
                                if (cleaned.startsWith('"') && cleaned.endsWith('"')) {
                                    cleaned = cleaned.slice(1, -1);
                                }
                                // Handle double quotes inside the string (CSV escape format)
                                cleaned = cleaned.replace(/""/g, '"');
                                return cleaned;
                            });
                            console.log('Row ' + rowIndex + ': Parsed category: ' + currentCategory + ', features: ' + features.length);
                            console.log('Features for ' + currentCategory + ':', features.slice(0, 5)); // Show first 5 features
                            console.log('Raw features before cleaning:', row.slice(1, 6)); // Show raw features
                        }
                    }
                });
                if (currentCategory && features.length > 0) {
                    featureGroups[currentCategory] = features;
                    console.log('Final stored category: ' + currentCategory + ' with ' + features.length + ' features');
                }

                console.log('Feature groups summary:', Object.keys(featureGroups).map(function(cat) {
                    return cat + ': ' + featureGroups[cat].length + ' features';
                }));

                if (Object.keys(featureGroups).length !== 5) {
                    console.error('Expected 5 categories, found: ' + Object.keys(featureGroups).length);
                    console.error('Found categories:', Object.keys(featureGroups));
                    return;
                }

                console.log('Building HTML for terrain features...');
                var html = '<div class="feature-groups">';
                var globalIndex = 0;
                categories.forEach(function(category) {
                    var catFeatures = featureGroups[category] || [];
                    console.log('Building HTML for category: ' + category + ' with ' + catFeatures.length + ' features');
                    html += '<div class="feature-column"><h4>' + category + '</h4><div class="gfield_checkbox">';
                    catFeatures.forEach(function(feature, index) {
                        var uniqueId = 'choice_3_terrain_' + globalIndex;
                        var inputName = 'input_terrain_' + globalIndex;
                        var simpleValue = 'terrain_feature_' + globalIndex;
                        
                        // Initialize global feature mapping
                        if (!window.terrainFeatureMap) {
                            window.terrainFeatureMap = {};
                        }
                        window.terrainFeatureMap[simpleValue] = feature;
                        
                        // Build HTML using simple string concatenation to avoid any quote issues
                        var divStart = '<div class="gchoice gchoice_terrain_' + globalIndex + '">';
                        var inputTag = '<input name="' + inputName + '" type="checkbox" value="' + simpleValue + '" data-category="' + category + '" id="' + uniqueId + '">';
                        var labelTag = '<label for="' + uniqueId + '" id="label_terrain_' + globalIndex + '">' + feature + '</label>';
                        // Add feature info icon for terrain features
                        var infoIcon = '<span class="feature-info-icon terrain-info-icon" data-feature="' + feature + '" style="margin-left: 8px; cursor: pointer; color: #007cba; font-weight: bold; font-size: 16px; border: 1px solid #007cba; border-radius: 50%; width: 20px; height: 20px; display: inline-block; text-align: center; line-height: 18px; background-color: #f0f8ff;" title="Click for GMC Terrain feature description">‚Ñπ</span>';
                        var divEnd = '</div>';
                        
                        html += divStart + inputTag + labelTag + infoIcon + divEnd;
                        globalIndex++;
                    });
                    html += '</div></div>';
                });
                html += '</div>';
                
                console.log('üî® Generated HTML length:', html.length);
                console.log('üî® Generated HTML preview:', html.substring(0, 300));
                console.log('üî® Total checkboxes to create:', globalIndex);

                // COMPREHENSIVE DEBUG: Check HTML block state
                console.log('üîç HTML BLOCK DEBUG BEFORE REPLACEMENT:');
                console.log('  - HTML Block exists:', htmlBlock.length > 0);
                console.log('  - HTML Block ID:', htmlBlock.attr('id'));
                console.log('  - HTML Block visible:', htmlBlock.is(':visible'));
                console.log('  - HTML Block parent visible:', htmlBlock.parent().is(':visible'));
                console.log('  - HTML Block display style:', htmlBlock.css('display'));
                console.log('  - HTML Block current content length:', htmlBlock.html().length);

                // Replace {terrain feature checkboxes} placeholder in field 137
                var htmlContent = htmlBlock.html();
                console.log('üìù HTML Block content before replacement (length: ' + htmlContent.length + '):', htmlContent);
                console.log('üîç Looking for placeholder: {terrain feature checkboxes}');
                console.log('üîç Placeholder found:', htmlContent.indexOf('{terrain feature checkboxes}') !== -1);
                
                // FORCE REPLACEMENT REGARDLESS OF PLACEHOLDER
                console.log('üîß FORCING HTML REPLACEMENT...');
                if (htmlContent.indexOf('{terrain feature checkboxes}') !== -1) {
                    htmlContent = htmlContent.replace('{terrain feature checkboxes}', html);
                    htmlBlock.html(htmlContent);
                    console.log('‚úÖ Replaced {terrain feature checkboxes} placeholder in field 137');
                } else {
                    // If no placeholder found, try to find a suitable container or replace entire content
                    var targetContainer = htmlBlock.find('.ginput_container, .gfield_html_formatted').first();
                    if (targetContainer.length) {
                        console.log('üéØ Found container, replacing its content');
                        targetContainer.html(html);
                        console.log('‚úÖ Replaced content in container within field 137');
                    } else {
                        console.log('‚ö†Ô∏è No container found, replacing entire HTML block content');
                        htmlBlock.html(html);
                        console.log('‚úÖ Replaced entire content of field 137 (no placeholder or container found)');
                    }
                }
                
                // COMPREHENSIVE DEBUG: Check HTML block state after replacement
                console.log('üîç HTML BLOCK DEBUG AFTER REPLACEMENT:');
                console.log('  - HTML Block content length after replacement:', htmlBlock.html().length);
                console.log('  - HTML Block content preview:', htmlBlock.html().substring(0, 300));
                
                // FORCE CHECK FOR CHECKBOXES
                console.log('üîç SEARCHING FOR CREATED CHECKBOXES...');
                var createdCheckboxes = htmlBlock.find('input[type="checkbox"]');
                console.log('‚úÖ Checkboxes found in HTML block:', createdCheckboxes.length);
                
                // Also check in the entire document
                var allTerrainCheckboxes = $('input[type="checkbox"][id*="terrain"]');
                console.log('‚úÖ All terrain checkboxes in document:', allTerrainCheckboxes.length);
                
                // Check for checkboxes with data-category attribute
                var categoryCheckboxes = $('input[type="checkbox"][data-category]');
                console.log('‚úÖ Checkboxes with data-category:', categoryCheckboxes.length);
                
                // Log first few checkboxes for verification
                createdCheckboxes.slice(0, 3).each(function(i) {
                    console.log('Checkbox ' + i + ':', {
                        id: $(this).attr('id'),
                        name: $(this).attr('name'),
                        value: $(this).attr('value'),
                        category: $(this).attr('data-category')
                    });
                });

                terrainPopulated = true;
                console.log('Terrain features populated into 5 columns in field 137');

                // Bind change events and add info icons
                htmlBlock.find('input[type="checkbox"]').off('change.TERRAINFeatures').on('change.TERRAINFeatures', function() {
                    console.log('TERRAIN checkbox changed, updating trim levels');
                    updateTrimLevels('TERRAIN');
                });

                htmlBlock.find('.gchoice').each(function() {
                    var $div = $(this);
                    var $input = $div.find('input[type="checkbox"]');
                    var $label = $div.find('label');
                    var feature = $label.text().trim();
                    if (feature) {
                        var matchedFeature = Object.keys(featureDescriptions).find(function(key) {
                            return fuzzyMatch(key, feature, 'TERRAIN', feature);
                        });
                        if (matchedFeature && !$div.find('.feature-info-icon[data-feature="' + matchedFeature + '"]').length) {
                            $label.prepend('<span class="feature-info-icon" data-feature="' + matchedFeature + '">i</span>');
                            console.log('Prepended info icon for feature: ' + feature);
                        }
                    }
                });

                htmlBlock.find('.feature-info-icon').off('click.featureInfo').on('click.featureInfo', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    var feature = $(this).data('feature');
                    console.log('=== TERRAIN FEATURE INFO ICON CLICKED ===');
                    console.log('Feature clicked:', feature);
                    console.log('Feature type:', typeof feature);
                    console.log('Feature length:', feature ? feature.length : 'undefined');
                    console.log('Available terrain descriptions:', Object.keys(terrainFeatureDescriptions));
                    console.log('Total descriptions available:', Object.keys(terrainFeatureDescriptions).length);
                    console.log('All descriptions:', terrainFeatureDescriptions);
                    
                    // Handle case where feature might be undefined or not a string
                    if (!feature || typeof feature !== 'string') {
                        console.error('Invalid feature:', feature);
                        showFeatureDescription('Unknown Feature', 'Feature information not available');
                        return;
                    }
                    
                                console.log('Looking for feature (uppercase):', feature.toUpperCase());
            // Use GMC Terrain descriptions with fuzzy matching for typos
            var description = terrainFeatureDescriptions[feature.toUpperCase()];
            if (!description) {
                // Try fuzzy matching for typos
                var bestMatch = findBestDescriptionMatch(feature.toUpperCase(), terrainFeatureDescriptions);
                if (bestMatch) {
                    description = bestMatch;
                    console.log('‚úÖ Found terrain description via fuzzy matching for:', feature);
                } else {
                    description = 'No GMC Terrain description available for ' + feature;
                }
            }
                    console.log('Found description:', description);
                    console.log('=== END TERRAIN FEATURE INFO DEBUG ===');
                    showFeatureDescription(feature, description);
                });
            },
            error: function(error) {
                console.error('Papa Parse error for Terrain population: ' + error);
            }
        });
    }).catch(function(error) {
        console.error('Fetch error for Terrain population: ' + error.message);
    });
}

// Global variables to track population state
var acadiaPopulated = false;

function populateAcadiaFeatures() {
    console.log('=== populateAcadiaFeatures called ===');
    console.log('üî• ACADIA FUNCTION CALLED - THIS IS THE ENTRY POINT');
    console.log('Current acadiaPopulated flag:', acadiaPopulated);
    console.log('Form ID:', formId);
    console.log('acadiaHtmlBlockFieldId:', acadiaHtmlBlockFieldId);
    
    if (acadiaPopulated) {
        console.log('Acadia features already populated, skipping');
        return;
    }

    var config = modelConfigs['ACADIA'];
    if (!config) {
        console.warn('Acadia configuration not found');
        console.log('Available modelConfigs:', Object.keys(modelConfigs));
        return;
    }
    console.log('Acadia config found:', config);

    // Try multiple selectors to find the HTML block field
    console.log('Searching for HTML block field with multiple selectors...');
    var htmlBlock = $('#field_' + formId + '_' + acadiaHtmlBlockFieldId);
    console.log('Selector 1 (#field_' + formId + '_' + acadiaHtmlBlockFieldId + '):', htmlBlock.length);
    
    if (!htmlBlock.length) {
        htmlBlock = $('#field_' + formId + '_138');
        console.log('Selector 2 (#field_' + formId + '_138):', htmlBlock.length);
    }
    if (!htmlBlock.length) {
        htmlBlock = $('#input_' + formId + '_138');
        console.log('Selector 3 (#input_' + formId + '_138):', htmlBlock.length);
    }
    if (!htmlBlock.length) {
        htmlBlock = $('[id*="138"]').filter(function() {
            return $(this).attr('id').includes('field') || $(this).attr('id').includes('input');
        });
        console.log('Selector 4 (wildcard [id*="138"]):', htmlBlock.length);
    }
    
    // Log all elements with 138 in ID
    var all138Elements = $('[id*="138"]');
    console.log('All elements with 138 in ID:');
    all138Elements.each(function(i) {
        console.log('  ' + i + ': ' + this.id + ' (tag: ' + this.tagName + ', class: ' + $(this).attr('class') + ')');
    });
    
    console.log('HTML Block field (ID: 138) debug:', {
        selector: '#field_' + formId + '_' + acadiaHtmlBlockFieldId,
        exists: htmlBlock.length > 0,
        visible: htmlBlock.length ? htmlBlock.is(':visible') : false,
        content: htmlBlock.length ? htmlBlock.html().substring(0, 200) : 'N/A',
        actualId: htmlBlock.length ? htmlBlock.attr('id') : 'N/A',
        allFields138: $('[id*="138"]').map(function() { return this.id; }).get()
    });
    
    if (!htmlBlock.length) {
        console.warn('Acadia HTML block field (ID: 138) not found with any selector');
        console.log('All form fields:', $('#gform_fields_' + formId).find('.gfield').map(function() { 
            return { id: $(this).attr('id'), class: $(this).attr('class') }; 
        }).get());
        
        // Try to find any HTML block field
        var allHtmlFields = $('[id*="field"][id*="' + formId + '"]').filter(function() {
            return $(this).find('.gfield_html').length > 0 || $(this).hasClass('gfield_html');
        });
        console.log('All HTML block fields found:', allHtmlFields.map(function() { return this.id; }).get());
        return;
    }

    console.log('Fetching acadia CSV from:', config.csvUrl);
    fetchCsvWithRetry(config.csvUrl, 'Acadia', 3, 1000).then(function(csvText) {
        console.log('Acadia CSV fetched successfully, length:', csvText.length);
        console.log('CSV preview (first 500 chars):', csvText.substring(0, 500));
        
        Papa.parse(csvText, {
            skipEmptyLines: true,
            complete: function(results) {
                console.log('Acadia CSV parsed for population, rows: ' + results.data.length);
                console.log('First few rows:', results.data.slice(0, 3));
                
                var categories = ['EXTERIOR', 'INTERIOR', 'MECHANICAL', 'SAFETY', 'PACKAGES'];
                var featureGroups = {};
                var currentCategory = null;
                var features = [];

                results.data.forEach(function(row, rowIndex) {
                    if (row.length > 0) {
                        var firstCell = row[0] ? row[0].trim() : '';
                        if (firstCell.startsWith('TRIM LEVELS FOR {')) {
                            if (currentCategory && features.length > 0) {
                                featureGroups[currentCategory] = features;
                                console.log('Stored category: ' + currentCategory + ' with ' + features.length + ' features');
                            }
                            currentCategory = firstCell.match(/\{(.+)\}/)[1];
                            // Clean up features by removing extra quotes and trimming
                            features = row.slice(1).filter(function(f) { return f && f.trim() !== ''; }).map(function(f) {
                                // Remove surrounding quotes if present
                                var cleaned = f.trim();
                                if (cleaned.startsWith('"') && cleaned.endsWith('"')) {
                                    cleaned = cleaned.slice(1, -1);
                                }
                                // Handle double quotes inside the string (CSV escape format)
                                cleaned = cleaned.replace(/""/g, '"');
                                return cleaned;
                            });
                            console.log('Row ' + rowIndex + ': Parsed category: ' + currentCategory + ', features: ' + features.length);
                            console.log('Features for ' + currentCategory + ':', features.slice(0, 5)); // Show first 5 features
                            console.log('Raw features before cleaning:', row.slice(1, 6)); // Show raw features
                        }
                    }
                });
                if (currentCategory && features.length > 0) {
                    featureGroups[currentCategory] = features;
                    console.log('Final stored category: ' + currentCategory + ' with ' + features.length + ' features');
                }

                console.log('Feature groups summary:', Object.keys(featureGroups).map(function(cat) {
                    return cat + ': ' + featureGroups[cat].length + ' features';
                }));

                if (Object.keys(featureGroups).length !== 5) {
                    console.error('Expected 5 categories, found: ' + Object.keys(featureGroups).length);
                    console.error('Found categories:', Object.keys(featureGroups));
                    return;
                }

                console.log('Building HTML for acadia features...');
                var html = '<div class="feature-groups">';
                var globalIndex = 0;
                categories.forEach(function(category) {
                    var catFeatures = featureGroups[category] || [];
                    console.log('Building HTML for category: ' + category + ' with ' + catFeatures.length + ' features');
                    html += '<div class="feature-column"><h4>' + category + '</h4><div class="gfield_checkbox">';
                    catFeatures.forEach(function(feature, index) {
                        var uniqueId = 'choice_3_acadia_' + globalIndex;
                        var inputName = 'input_acadia_' + globalIndex;
                        var simpleValue = 'acadia_feature_' + globalIndex;
                        
                        // Initialize global feature mapping
                        if (!window.acadiaFeatureMap) {
                            window.acadiaFeatureMap = {};
                        }
                        window.acadiaFeatureMap[simpleValue] = feature;
                        
                        // Build HTML using simple string concatenation to avoid any quote issues
                        var divStart = '<div class="gchoice gchoice_acadia_' + globalIndex + '">';
                        var inputTag = '<input name="' + inputName + '" type="checkbox" value="' + simpleValue + '" data-category="' + category + '" id="' + uniqueId + '">';
                        var labelTag = '<label for="' + uniqueId + '" id="label_acadia_' + globalIndex + '">' + feature + '</label>';
                        // Add feature info icon for acadia features
                        var infoIcon = '<span class="feature-info-icon acadia-info-icon" data-feature="' + feature + '" style="margin-left: 8px; cursor: pointer; color: #007cba; font-weight: bold; font-size: 16px; border: 1px solid #007cba; border-radius: 50%; width: 20px; height: 20px; display: inline-block; text-align: center; line-height: 18px; background-color: #f0f8ff;" title="Click for GMC Acadia feature description">‚Ñπ</span>';
                        var divEnd = '</div>';
                        
                        html += divStart + inputTag + labelTag + infoIcon + divEnd;
                        globalIndex++;
                    });
                    html += '</div></div>';
                });
                html += '</div>';
                
                console.log('üî® Generated HTML length:', html.length);
                console.log('üî® Generated HTML preview:', html.substring(0, 300));
                console.log('üî® Total checkboxes to create:', globalIndex);

                // COMPREHENSIVE DEBUG: Check HTML block state
                console.log('üîç HTML BLOCK DEBUG BEFORE REPLACEMENT:');
                console.log('  - HTML Block exists:', htmlBlock.length > 0);
                console.log('  - HTML Block ID:', htmlBlock.attr('id'));
                console.log('  - HTML Block visible:', htmlBlock.is(':visible'));
                console.log('  - HTML Block parent visible:', htmlBlock.parent().is(':visible'));
                console.log('  - HTML Block display style:', htmlBlock.css('display'));
                console.log('  - HTML Block current content length:', htmlBlock.html().length);

                // Replace {acadia feature checkboxes} placeholder in field 138
                var htmlContent = htmlBlock.html();
                console.log('üìù HTML Block content before replacement (length: ' + htmlContent.length + '):', htmlContent);
                console.log('üîç Looking for placeholder: {acadia feature checkboxes}');
                console.log('üîç Placeholder found:', htmlContent.indexOf('{acadia feature checkboxes}') !== -1);
                
                // FORCE REPLACEMENT REGARDLESS OF PLACEHOLDER
                console.log('üîß FORCING HTML REPLACEMENT...');
                if (htmlContent.indexOf('{acadia feature checkboxes}') !== -1) {
                    htmlContent = htmlContent.replace('{acadia feature checkboxes}', html);
                    htmlBlock.html(htmlContent);
                    console.log('‚úÖ Replaced {acadia feature checkboxes} placeholder in field 138');
                } else {
                    // If no placeholder found, try to find a suitable container or replace entire content
                    var targetContainer = htmlBlock.find('.ginput_container, .gfield_html_formatted').first();
                    if (targetContainer.length) {
                        console.log('üéØ Found container, replacing its content');
                        targetContainer.html(html);
                        console.log('‚úÖ Replaced content in container within field 138');
                    } else {
                        console.log('‚ö†Ô∏è No container found, replacing entire HTML block content');
                        htmlBlock.html(html);
                        console.log('‚úÖ Replaced entire content of field 138 (no placeholder or container found)');
                    }
                }
                
                // COMPREHENSIVE DEBUG: Check HTML block state after replacement
                console.log('üîç HTML BLOCK DEBUG AFTER REPLACEMENT:');
                console.log('  - HTML Block content length after replacement:', htmlBlock.html().length);
                console.log('  - HTML Block content preview:', htmlBlock.html().substring(0, 300));
                
                // FORCE CHECK FOR CHECKBOXES
                console.log('üîç SEARCHING FOR CREATED CHECKBOXES...');
                var createdCheckboxes = htmlBlock.find('input[type="checkbox"]');
                console.log('‚úÖ Checkboxes found in HTML block:', createdCheckboxes.length);
                
                // Also check in the entire document
                var allAcadiaCheckboxes = $('input[type="checkbox"][id*="acadia"]');
                console.log('‚úÖ All acadia checkboxes in document:', allAcadiaCheckboxes.length);
                
                // Check for checkboxes with data-category attribute
                var categoryCheckboxes = $('input[type="checkbox"][data-category]');
                console.log('‚úÖ Checkboxes with data-category:', categoryCheckboxes.length);
                
                // Log first few checkboxes for verification
                createdCheckboxes.slice(0, 3).each(function(i) {
                    console.log('Checkbox ' + i + ':', {
                        id: $(this).attr('id'),
                        name: $(this).attr('name'),
                        value: $(this).attr('value'),
                        category: $(this).attr('data-category')
                    });
                });

                acadiaPopulated = true;
                console.log('Acadia features populated into 5 columns in field 138');

                // Bind change events and add info icons
                htmlBlock.find('input[type="checkbox"]').off('change.ACADIAFeatures').on('change.ACADIAFeatures', function() {
                    console.log('ACADIA checkbox changed, updating trim levels');
                    updateTrimLevels('ACADIA');
                });

                htmlBlock.find('.gchoice').each(function() {
                    var $div = $(this);
                    var $input = $div.find('input[type="checkbox"]');
                    var $label = $div.find('label');
                    var feature = $label.text().trim();
                    if (feature) {
                        var matchedFeature = Object.keys(featureDescriptions).find(function(key) {
                            return fuzzyMatch(key, feature, 'ACADIA', feature);
                        });
                        if (matchedFeature && !$div.find('.feature-info-icon[data-feature="' + matchedFeature + '"]').length) {
                            $label.prepend('<span class="feature-info-icon" data-feature="' + matchedFeature + '">i</span>');
                            console.log('Prepended info icon for feature: ' + feature);
                        }
                    }
                });

                htmlBlock.find('.feature-info-icon').off('click.featureInfo').on('click.featureInfo', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    var feature = $(this).data('feature');
                    console.log('=== ACADIA FEATURE INFO ICON CLICKED ===');
                    console.log('Feature clicked:', feature);
                    console.log('Feature type:', typeof feature);
                    console.log('Feature length:', feature ? feature.length : 'undefined');
                    console.log('Available acadia descriptions:', Object.keys(acadiaFeatureDescriptions));
                    console.log('Total descriptions available:', Object.keys(acadiaFeatureDescriptions).length);
                    console.log('All descriptions:', acadiaFeatureDescriptions);
                    
                    // Handle case where feature might be undefined or not a string
                    if (!feature || typeof feature !== 'string') {
                        console.error('Invalid feature:', feature);
                        showFeatureDescription('Unknown Feature', 'Feature information not available');
                        return;
                    }
                    
                    console.log('Looking for feature (uppercase):', feature.toUpperCase());
                    // Use GMC Acadia descriptions with fuzzy matching for typos
                    var description = acadiaFeatureDescriptions[feature.toUpperCase()];
                    if (!description) {
                        // Try fuzzy matching for typos
                        var bestMatch = findBestDescriptionMatch(feature.toUpperCase(), acadiaFeatureDescriptions);
                        if (bestMatch) {
                            description = bestMatch;
                            console.log('‚úÖ Found acadia description via fuzzy matching for:', feature);
                        } else {
                            description = 'No GMC Acadia description available for ' + feature;
                        }
                    }
                    console.log('Found description:', description);
                    console.log('=== END ACADIA FEATURE INFO DEBUG ===');
                    showFeatureDescription(feature, description);
                });
            },
            error: function(error) {
                console.error('Papa Parse error for Acadia population: ' + error);
            }
        });
    }).catch(function(error) {
        console.error('Fetch error for Acadia population: ' + error.message);
    });
}

var yukonPopulated = false;

function populateYukonFeatures() {
    console.log('=== populateYukonFeatures called ===');
    console.log('Current yukonPopulated flag:', yukonPopulated);
    console.log('Form ID:', formId);
    console.log('yukonHtmlBlockFieldId:', yukonHtmlBlockFieldId);
    
    if (yukonPopulated) {
        console.log('Yukon features already populated, skipping');
        return;
    }

    var config = modelConfigs['YUKON'];
    if (!config) {
        console.warn('Yukon configuration not found');
        console.log('Available modelConfigs:', Object.keys(modelConfigs));
        return;
    }
    console.log('Yukon config found:', config);

    // Try multiple selectors to find the HTML block field
    console.log('Searching for HTML block field with multiple selectors...');
    var htmlBlock = $('#field_' + formId + '_' + yukonHtmlBlockFieldId);
    console.log('Selector 1 (#field_' + formId + '_' + yukonHtmlBlockFieldId + '):', htmlBlock.length);
    
    if (!htmlBlock.length) {
        htmlBlock = $('#field_' + formId + '_139');
        console.log('Selector 2 (#field_' + formId + '_139):', htmlBlock.length);
    }
    if (!htmlBlock.length) {
        htmlBlock = $('#input_' + formId + '_139');
        console.log('Selector 3 (#input_' + formId + '_139):', htmlBlock.length);
    }
    if (!htmlBlock.length) {
        htmlBlock = $('[id*="139"]').filter(function() {
            return $(this).attr('id').includes('field') || $(this).attr('id').includes('input');
        });
        console.log('Selector 4 (wildcard [id*="139"]):', htmlBlock.length);
    }
    
    // Log all elements with 139 in ID
    var all139Elements = $('[id*="139"]');
    console.log('All elements with 139 in ID:');
    all139Elements.each(function(i) {
        console.log('  ' + i + ': ' + this.id + ' (tag: ' + this.tagName + ', class: ' + $(this).attr('class') + ')');
    });
    
    console.log('HTML Block field (ID: 139) debug:', {
        selector: '#field_' + formId + '_' + yukonHtmlBlockFieldId,
        exists: htmlBlock.length > 0,
        visible: htmlBlock.length ? htmlBlock.is(':visible') : false,
        content: htmlBlock.length ? htmlBlock.html().substring(0, 200) : 'N/A',
        actualId: htmlBlock.length ? htmlBlock.attr('id') : 'N/A',
        allFields139: $('[id*="139"]').map(function() { return this.id; }).get()
    });
    
    if (!htmlBlock.length) {
        console.warn('Yukon HTML block field (ID: 139) not found with any selector');
        console.log('All form fields:', $('#gform_fields_' + formId).find('.gfield').map(function() { 
            return { id: $(this).attr('id'), class: $(this).attr('class') }; 
        }).get());
        
        // Try to find any HTML block field
        var allHtmlFields = $('[id*="field"][id*="' + formId + '"]').filter(function() {
            return $(this).find('.gfield_html').length > 0 || $(this).hasClass('gfield_html');
        });
        console.log('All HTML block fields found:', allHtmlFields.map(function() { return this.id; }).get());
        return;
    }

    console.log('Fetching yukon CSV from:', config.csvUrl);
    fetchCsvWithRetry(config.csvUrl, 'Yukon', 3, 1000).then(function(csvText) {
        console.log('Yukon CSV fetched successfully, length:', csvText.length);
        console.log('CSV preview (first 500 chars):', csvText.substring(0, 500));
        
        Papa.parse(csvText, {
            skipEmptyLines: true,
            complete: function(results) {
                console.log('Yukon CSV parsed for population, rows: ' + results.data.length);
                console.log('First few rows:', results.data.slice(0, 3));
                
                var categories = ['EXTERIOR', 'INTERIOR', 'MECHANICAL', 'SAFETY', 'PACKAGES'];
                var featureGroups = {};
                var currentCategory = null;
                var features = [];

                results.data.forEach(function(row, rowIndex) {
                    if (row.length > 0) {
                        var firstCell = row[0] ? row[0].trim() : '';
                        if (firstCell.startsWith('TRIM LEVELS FOR {')) {
                            if (currentCategory && features.length > 0) {
                                featureGroups[currentCategory] = features;
                                console.log('Stored category: ' + currentCategory + ' with ' + features.length + ' features');
                            }
                            currentCategory = firstCell.match(/\{(.+)\}/)[1];
                            // Clean up features by removing extra quotes and trimming
                            features = row.slice(1).filter(function(f) { return f && f.trim() !== ''; }).map(function(f) {
                                // Remove surrounding quotes if present
                                var cleaned = f.trim();
                                if (cleaned.startsWith('"') && cleaned.endsWith('"')) {
                                    cleaned = cleaned.slice(1, -1);
                                }
                                // Handle double quotes inside the string (CSV escape format)
                                cleaned = cleaned.replace(/""/g, '"');
                                return cleaned;
                            });
                            console.log('Row ' + rowIndex + ': Parsed category: ' + currentCategory + ', features: ' + features.length);
                            console.log('Features for ' + currentCategory + ':', features.slice(0, 5)); // Show first 5 features
                            console.log('Raw features before cleaning:', row.slice(1, 6)); // Show raw features
                        }
                    }
                });
                if (currentCategory && features.length > 0) {
                    featureGroups[currentCategory] = features;
                    console.log('Final stored category: ' + currentCategory + ' with ' + features.length + ' features');
                }

                console.log('Feature groups summary:', Object.keys(featureGroups).map(function(cat) {
                    return cat + ': ' + featureGroups[cat].length + ' features';
                }));

                if (Object.keys(featureGroups).length !== 5) {
                    console.error('Expected 5 categories, found: ' + Object.keys(featureGroups).length);
                    console.error('Found categories:', Object.keys(featureGroups));
                    return;
                }

                console.log('Building HTML for yukon features...');
                var html = '<div class="feature-groups">';
                var globalIndex = 0;
                categories.forEach(function(category) {
                    var catFeatures = featureGroups[category] || [];
                    console.log('Building HTML for category: ' + category + ' with ' + catFeatures.length + ' features');
                    html += '<div class="feature-column"><h4>' + category + '</h4><div class="gfield_checkbox">';
                    catFeatures.forEach(function(feature, index) {
                        var uniqueId = 'choice_3_yukon_' + globalIndex;
                        var inputName = 'input_yukon_' + globalIndex;
                        var simpleValue = 'yukon_feature_' + globalIndex;
                        
                        // Initialize global feature mapping
                        if (!window.yukonFeatureMap) {
                            window.yukonFeatureMap = {};
                        }
                        window.yukonFeatureMap[simpleValue] = feature;
                        
                        // Build HTML using simple string concatenation to avoid any quote issues
                        var divStart = '<div class="gchoice gchoice_yukon_' + globalIndex + '">';
                        var inputTag = '<input name="' + inputName + '" type="checkbox" value="' + simpleValue + '" data-category="' + category + '" id="' + uniqueId + '">';
                        var labelTag = '<label for="' + uniqueId + '" id="label_yukon_' + globalIndex + '">' + feature + '</label>';
                        // Add feature info icon for yukon features
                        var infoIcon = '<span class="feature-info-icon yukon-info-icon" data-feature="' + feature + '" style="margin-left: 8px; cursor: pointer; color: #007cba; font-weight: bold; font-size: 16px; border: 1px solid #007cba; border-radius: 50%; width: 20px; height: 20px; display: inline-block; text-align: center; line-height: 18px; background-color: #f0f8ff;" title="Click for GMC Yukon feature description">‚Ñπ</span>';
                        var divEnd = '</div>';
                        
                        html += divStart + inputTag + labelTag + infoIcon + divEnd;
                        globalIndex++;
                    });
                    html += '</div></div>';
                });
                html += '</div>';
                
                console.log('üî® Generated HTML length:', html.length);
                console.log('üî® Generated HTML preview:', html.substring(0, 300));
                console.log('üî® Total checkboxes to create:', globalIndex);

                // COMPREHENSIVE DEBUG: Check HTML block state
                console.log('üîç HTML BLOCK DEBUG BEFORE REPLACEMENT:');
                console.log('  - HTML Block exists:', htmlBlock.length > 0);
                console.log('  - HTML Block ID:', htmlBlock.attr('id'));
                console.log('  - HTML Block visible:', htmlBlock.is(':visible'));
                console.log('  - HTML Block parent visible:', htmlBlock.parent().is(':visible'));
                console.log('  - HTML Block display style:', htmlBlock.css('display'));
                console.log('  - HTML Block current content length:', htmlBlock.html().length);

                // Replace {yukon feature checkboxes} placeholder in field 139
                var htmlContent = htmlBlock.html();
                console.log('üìù HTML Block content before replacement (length: ' + htmlContent.length + '):', htmlContent);
                console.log('üîç Looking for placeholder: {yukon feature checkboxes}');
                console.log('üîç Placeholder found:', htmlContent.indexOf('{yukon feature checkboxes}') !== -1);
                
                // FORCE REPLACEMENT REGARDLESS OF PLACEHOLDER
                console.log('üîß FORCING HTML REPLACEMENT...');
                if (htmlContent.indexOf('{yukon feature checkboxes}') !== -1) {
                    htmlContent = htmlContent.replace('{yukon feature checkboxes}', html);
                    htmlBlock.html(htmlContent);
                    console.log('‚úÖ Replaced {yukon feature checkboxes} placeholder in field 139');
                } else {
                    // If no placeholder found, try to find a suitable container or replace entire content
                    var targetContainer = htmlBlock.find('.ginput_container, .gfield_html_formatted').first();
                    if (targetContainer.length) {
                        console.log('üéØ Found container, replacing its content');
                        targetContainer.html(html);
                        console.log('‚úÖ Replaced content in container within field 139');
                    } else {
                        console.log('‚ö†Ô∏è No container found, replacing entire HTML block content');
                        htmlBlock.html(html);
                        console.log('‚úÖ Replaced entire content of field 139 (no placeholder or container found)');
                    }
                }
                
                // COMPREHENSIVE DEBUG: Check HTML block state after replacement
                console.log('üîç HTML BLOCK DEBUG AFTER REPLACEMENT:');
                console.log('  - HTML Block content length after replacement:', htmlBlock.html().length);
                console.log('  - HTML Block content preview:', htmlBlock.html().substring(0, 300));
                
                // FORCE CHECK FOR CHECKBOXES
                console.log('üîç SEARCHING FOR CREATED CHECKBOXES...');
                var createdCheckboxes = htmlBlock.find('input[type="checkbox"]');
                console.log('‚úÖ Checkboxes found in HTML block:', createdCheckboxes.length);
                
                // Also check in the entire document
                var allYukonCheckboxes = $('input[type="checkbox"][id*="yukon"]');
                console.log('‚úÖ All yukon checkboxes in document:', allYukonCheckboxes.length);
                
                // Check for checkboxes with data-category attribute
                var categoryCheckboxes = $('input[type="checkbox"][data-category]');
                console.log('‚úÖ Checkboxes with data-category:', categoryCheckboxes.length);
                
                // Log first few checkboxes for verification
                createdCheckboxes.slice(0, 3).each(function(i) {
                    console.log('Checkbox ' + i + ':', {
                        id: $(this).attr('id'),
                        name: $(this).attr('name'),
                        value: $(this).attr('value'),
                        category: $(this).attr('data-category')
                    });
                });

                yukonPopulated = true;
                console.log('Yukon features populated into 5 columns in field 139');

                // Bind change events and add info icons
                htmlBlock.find('input[type="checkbox"]').off('change.YUKONFeatures').on('change.YUKONFeatures', function() {
                    console.log('YUKON checkbox changed, updating trim levels');
                    updateTrimLevels('YUKON');
                });

                htmlBlock.find('.feature-info-icon').off('click.featureInfo').on('click.featureInfo', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    var feature = $(this).data('feature');
                    console.log('=== YUKON FEATURE INFO ICON CLICKED ===');
                    console.log('Feature clicked:', feature);
                    console.log('Feature type:', typeof feature);
                    console.log('Feature length:', feature ? feature.length : 'undefined');
                    console.log('Available yukon descriptions:', Object.keys(yukonFeatureDescriptions));
                    console.log('Total descriptions available:', Object.keys(yukonFeatureDescriptions).length);
                    console.log('All descriptions:', yukonFeatureDescriptions);
                    
                    // Handle case where feature might be undefined or not a string
                    if (!feature || typeof feature !== 'string') {
                        console.error('Invalid feature:', feature);
                        showFeatureDescription('Unknown Feature', 'Feature information not available');
                        return;
                    }
                    
                    console.log('Looking for feature (uppercase):', feature.toUpperCase());
                    // Use GMC Yukon descriptions with fuzzy matching for typos
                    var description = yukonFeatureDescriptions[feature.toUpperCase()];
                    if (!description) {
                        // Try fuzzy matching for typos
                        var bestMatch = findBestDescriptionMatch(feature.toUpperCase(), yukonFeatureDescriptions);
                        if (bestMatch) {
                            description = bestMatch;
                            console.log('‚úÖ Found yukon description via fuzzy matching for:', feature);
                        } else {
                            description = 'No GMC Yukon description available for ' + feature;
                        }
                    }
                    console.log('Found description:', description);
                    console.log('=== END YUKON FEATURE INFO DEBUG ===');
                    showFeatureDescription(feature, description);
                });
            },
            error: function(error) {
                console.error('Papa Parse error for Yukon population: ' + error);
            }
        });
    }).catch(function(error) {
        console.error('Fetch error for Yukon population: ' + error.message);
    });
}

function populateCanyonFeatures() {
    console.log('=== populateCanyonFeatures called ===');
    var canyonPopulated = false;
    
    console.log('Current canyonPopulated flag:', canyonPopulated);
    
    // Check if already populated
    if (canyonPopulated) {
        console.log('Canyon features already populated, skipping');
        return;
    }
    
    console.log('canyonHtmlBlockFieldId:', canyonHtmlBlockFieldId);
    
    // Get the HTML block field for Canyon
    var htmlBlock = $('#field_' + formId + '_' + canyonHtmlBlockFieldId);
    console.log('Selector 1 (#field_' + formId + '_' + canyonHtmlBlockFieldId + '):', htmlBlock.length);
    
    if (!htmlBlock.length) {
        htmlBlock = $('#field_' + formId + '_' + canyonHtmlBlockFieldId + '_container');
        console.log('Selector 2 (#field_' + formId + '_' + canyonHtmlBlockFieldId + '_container):', htmlBlock.length);
        
        if (!htmlBlock.length) {
            htmlBlock = $('[data-fieldid="' + canyonHtmlBlockFieldId + '"]');
            console.log('Selector 3 ([data-fieldid="' + canyonHtmlBlockFieldId + '"]):', htmlBlock.length);
        }
    }
    
    if (!htmlBlock.length) {
        console.error('Could not find Canyon HTML block field');
        return;
    }
    
    console.log('Successfully found Canyon HTML block field');
    
    // Debug selectors
    console.log('Testing selectors for Canyon HTML block field:');
    [
        '#field_' + formId + '_' + canyonHtmlBlockFieldId,
        '#field_' + formId + '_' + canyonHtmlBlockFieldId + '_container',
        '[data-fieldid="' + canyonHtmlBlockFieldId + '"]'
    ].forEach(function(selector, index) {
        var element = $(selector);
        console.log('Selector ' + (index + 1) + ' (' + selector + '):', element.length);
    });
    
    // Define the URL for the Canyon CSV file
    var canyonCsvUrl = 'https://hutchinsonautoteam.com/gmcmodels/canyon.csv';
    console.log('Fetching Canyon CSV from:', canyonCsvUrl);
    
    // Fetch the CSV file
    fetch(canyonCsvUrl).then(function(response) {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.text();
    }).then(function(csvText) {
        console.log('Raw Canyon CSV text:', csvText);
        
        // Parse the CSV using Papa Parse
        Papa.parse(csvText, {
            complete: function(results) {
                console.log('Papa Parse results for Canyon:', results);
                
                var csvData = results.data;
                var features = [];
                var categories = ['EXTERIOR', 'INTERIOR', 'MECHANICAL', 'SAFETY', 'PACKAGES'];
                
                // Process each category
                categories.forEach(function(category) {
                    var categoryFound = false;
                    
                    csvData.forEach(function(row) {
                        if (row && row.length > 0 && row[0] && row[0].includes('TRIM LEVELS FOR {' + category + '}')) {
                            categoryFound = true;
                            console.log('Found category:', category);
                            
                            // Extract features from the row (skip the first column which contains the category)
                            for (var i = 1; i < row.length; i++) {
                                var feature = row[i];
                                if (feature && feature.trim() !== '') {
                                    features.push({
                                        name: feature.trim(),
                                        category: category
                                    });
                                }
                            }
                        }
                    });
                    
                    if (!categoryFound) {
                        console.warn('Category not found in CSV:', category);
                    }
                });
                
                console.log('Processed Canyon features:', features);
                
                // Create HTML content for checkboxes
                var htmlContent = '<div class="feature-groups" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px;">';
                
                features.forEach(function(feature, index) {
                    var checkboxId = 'canyon_feature_' + index;
                    var cleanFeatureName = feature.name.replace(/[^a-zA-Z0-9\s]/g, '').trim();
                    var displayName = cleanFeatureName || feature.name;
                    
                    htmlContent += '<div class="feature-item" style="display: flex; align-items: center; margin-bottom: 10px;">' +
                                  '<input type="checkbox" id="' + checkboxId + '" name="canyon_features" value="' + feature.name + '" data-category="' + feature.category + '" style="margin-right: 8px;">' +
                                  '<label for="' + checkboxId + '" style="font-size: 12px; line-height: 1.3; cursor: pointer; flex: 1;">' + displayName + '</label>' +
                                  '<span class="feature-info-icon" data-feature="' + feature.name + '" style="margin-left: 5px; cursor: pointer; color: #007cba; font-weight: bold; font-size: 14px; user-select: none;" title="Click for feature information">‚ÑπÔ∏è</span>' +
                                  '</div>';
                });
                
                htmlContent += '</div>';
                
                // Replace the placeholder with the checkbox HTML
                var currentHtml = htmlBlock.html();
                var updatedHtml = currentHtml.replace(/{canyon feature checkboxes}/g, htmlContent);
                htmlBlock.html(updatedHtml);
                
                // Verify the replacement was successful
                var createdCheckboxes = htmlBlock.find('input[name="canyon_features"]');
                var categoryCheckboxes = htmlBlock.find('input[data-category]');
                
                console.log('‚úÖ Total Canyon checkboxes created:', createdCheckboxes.length);
                console.log('‚úÖ Checkboxes with data-category:', categoryCheckboxes.length);
                
                // Log first few checkboxes for verification
                createdCheckboxes.slice(0, 3).each(function(i) {
                    console.log('Checkbox ' + i + ':', {
                        id: $(this).attr('id'),
                        name: $(this).attr('name'),
                        value: $(this).attr('value'),
                        category: $(this).attr('data-category')
                    });
                });

                canyonPopulated = true;
                console.log('Canyon features populated into 5 columns in field 140');

                // Bind change events and add info icons
                htmlBlock.find('input[type="checkbox"]').off('change.CANYONFeatures').on('change.CANYONFeatures', function() {
                    console.log('CANYON checkbox changed, updating trim levels');
                    updateTrimLevels('CANYON');
                });

                htmlBlock.find('.feature-info-icon').off('click.featureInfo').on('click.featureInfo', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    var feature = $(this).data('feature');
                    console.log('=== CANYON FEATURE INFO ICON CLICKED ===');
                    console.log('Feature clicked:', feature);
                    console.log('Feature type:', typeof feature);
                    console.log('Feature length:', feature ? feature.length : 'undefined');
                    console.log('Available canyon descriptions:', Object.keys(canyonFeatureDescriptions));
                    console.log('Total descriptions available:', Object.keys(canyonFeatureDescriptions).length);
                    console.log('All descriptions:', canyonFeatureDescriptions);
                    
                    // Handle case where feature might be undefined or not a string
                    if (!feature || typeof feature !== 'string') {
                        console.error('Invalid feature:', feature);
                        showFeatureDescription('Unknown Feature', 'Feature information not available');
                        return;
                    }
                    
                    console.log('Looking for feature (uppercase):', feature.toUpperCase());
                    // Use GMC Canyon descriptions with fuzzy matching for typos
                    var description = canyonFeatureDescriptions[feature.toUpperCase()];
                    if (!description) {
                        // Try fuzzy matching for typos
                        var bestMatch = findBestDescriptionMatch(feature.toUpperCase(), canyonFeatureDescriptions);
                        if (bestMatch) {
                            description = bestMatch;
                            console.log('‚úÖ Found canyon description via fuzzy matching for:', feature);
                        } else {
                            description = 'No GMC Canyon description available for ' + feature;
                        }
                    }
                    console.log('Found description:', description);
                    console.log('=== END CANYON FEATURE INFO DEBUG ===');
                    showFeatureDescription(feature, description);
                });
            },
            error: function(error) {
                console.error('Papa Parse error for Canyon population: ' + error);
            }
        });
    }).catch(function(error) {
        console.error('Fetch error for Canyon population: ' + error.message);
    });
}

	function processTerrainTrimLevels(csvData, selectedFeatures, htmlBlock, trimLevelsButtonBlock, model) {
		console.log('Processing TERRAIN trim levels for selected features:', selectedFeatures);
		
		var trimLevels = ['ELEVATION', 'AT4', 'DENALI'];
		var matchingTrimLevels = [];
		var categories = ['EXTERIOR', 'INTERIOR', 'MECHANICAL', 'SAFETY', 'PACKAGES'];
		var featureToColumnMap = {};
		var featureToCategoryMap = {};
		var trimLevelRows = {};
		var trimLevelRowsByCategory = {};
		var currentCategory = null;
		
		// Parse the CSV data to map features to columns and find trim level rows
		csvData.forEach(function(row, rowIndex) {
			if (row.length > 0) {
				var firstCell = row[0] ? row[0].trim() : '';
				
				// Check if this is a category header row
				if (firstCell.startsWith('TRIM LEVELS FOR {')) {
					var category = firstCell.match(/\{(.+)\}/)[1];
					currentCategory = category;
					console.log('Found category:', category);
					
					// Initialize category storage if not exists
					if (!trimLevelRowsByCategory[category]) {
						trimLevelRowsByCategory[category] = {};
					}
					
					// Map features to their column indices
					for (var i = 1; i < row.length; i++) {
						var feature = row[i] ? row[i].trim() : '';
						if (feature && feature !== '') {
							// Clean up the feature name the same way as in populateTerrainFeatures
							var cleanedFeature = feature;
							if (cleanedFeature.startsWith('"') && cleanedFeature.endsWith('"')) {
								cleanedFeature = cleanedFeature.slice(1, -1);
							}
							cleanedFeature = cleanedFeature.replace(/""/g, '"');
							
							featureToColumnMap[cleanedFeature] = i;
							featureToCategoryMap[cleanedFeature] = category;
							console.log('Mapped feature "' + cleanedFeature + '" (raw: "' + feature + '") to column ' + i + ' in category ' + category);
						}
					}
				}
				// Check if this is a trim level row
				else if (trimLevels.includes(firstCell) && currentCategory) {
					// Store in both global and category-specific storage
					trimLevelRows[firstCell] = row;
					trimLevelRowsByCategory[currentCategory][firstCell] = row;
					console.log('Found trim level row for:', firstCell, 'in category:', currentCategory);
					
					// Debug specific trim level data for SAFETY section
					if (currentCategory === 'SAFETY') {
						console.log('=== SAFETY TRIM LEVEL DATA FOR ' + firstCell + ' ===');
						console.log('Full row:', row);
						console.log('Row length:', row.length);
						for (var i = 0; i < Math.min(row.length, 15); i++) {
							console.log('Column ' + i + ': "' + row[i] + '"');
						}
						console.log('=== END SAFETY TRIM LEVEL DATA ===');
					}
				}
			}
		});
		
		console.log('Feature to column mapping:', featureToColumnMap);
		console.log('Feature to category mapping:', featureToCategoryMap);
		console.log('Trim level rows:', Object.keys(trimLevelRows));
		console.log('Trim level rows by category:', trimLevelRowsByCategory);
		
		// Check which trim levels have all selected features
		trimLevels.forEach(function(trimLevel) {
			if (trimLevelRows[trimLevel]) {
				var hasAllFeatures = true;
				var featureResults = [];
				
				selectedFeatures.forEach(function(feature) {
					var columnIndex = featureToColumnMap[feature];
					var matchedFeature = feature;
					
					// If exact match not found, try fuzzy matching
					if (columnIndex === undefined) {
						console.log('Feature "' + feature + '" not found in column mapping, trying fuzzy matching...');
						var bestMatch = null;
						var bestScore = 0;
						var threshold = 0.3; // Lower threshold for partial matches
						
						// Try to find partial matches
						Object.keys(featureToColumnMap).forEach(function(csvFeature) {
							var score = 0;
							
							// Check if the selected feature is contained in the CSV feature
							if (csvFeature.toLowerCase().includes(feature.toLowerCase())) {
								score = 0.8; // High score for containment
							}
							// Check if CSV feature starts with the selected feature
							else if (csvFeature.toLowerCase().startsWith(feature.toLowerCase())) {
								score = 0.7;
							}
							// Check if selected feature is a significant part of CSV feature
							else if (feature.length >= 3 && csvFeature.toLowerCase().includes(feature.toLowerCase())) {
								score = 0.6;
							}
							// Fuzzy string matching as fallback
							else {
								var featureNorm = feature.toLowerCase().replace(/[^a-z0-9]/g, '');
								var csvFeatureNorm = csvFeature.toLowerCase().replace(/[^a-z0-9]/g, '');
								if (featureNorm.length > 0 && csvFeatureNorm.length > 0) {
									var commonLength = 0;
									var maxLength = Math.max(featureNorm.length, csvFeatureNorm.length);
									for (var i = 0; i < Math.min(featureNorm.length, csvFeatureNorm.length); i++) {
										if (featureNorm[i] === csvFeatureNorm[i]) {
											commonLength++;
										} else {
											break;
										}
									}
									score = commonLength / maxLength;
								}
							}
							
							console.log('Fuzzy match attempt: "' + feature + '" vs "' + csvFeature + '": score=' + score);
							
							if (score > bestScore && score >= threshold) {
								bestScore = score;
								bestMatch = csvFeature;
							}
						});
						
						if (bestMatch) {
							console.log('Found fuzzy match for "' + feature + '": "' + bestMatch + '" (score: ' + bestScore + ')');
							columnIndex = featureToColumnMap[bestMatch];
							matchedFeature = bestMatch;
						}
					}
					
					if (columnIndex !== undefined) {
						// Get the category for this feature
						var featureCategory = featureToCategoryMap[matchedFeature];
						var value = null;
						
						// Use category-specific trim level data if available
						if (featureCategory && trimLevelRowsByCategory[featureCategory] && trimLevelRowsByCategory[featureCategory][trimLevel]) {
							value = trimLevelRowsByCategory[featureCategory][trimLevel][columnIndex];
							console.log('Using category-specific data for ' + trimLevel + ' in category ' + featureCategory + ', column ' + columnIndex + ': "' + value + '"');
						} else {
							// Fallback to global trim level data
							value = trimLevelRows[trimLevel][columnIndex];
							console.log('Using global data for ' + trimLevel + ', column ' + columnIndex + ': "' + value + '"');
						}
						// Clean up the value and check for YES (handle edge cases like "YNO" -> "NO")
						var cleanedValue = value ? value.trim().toLowerCase() : '';
						var hasFeature = false;
						
						if (cleanedValue === 'yes') {
							hasFeature = true;
						} else if (cleanedValue === 'no') {
							hasFeature = false;
						} else if (cleanedValue.startsWith('y') && cleanedValue.length <= 4) {
							// Handle cases like "YNO" which should be "NO"
							hasFeature = false;
							console.warn('Found malformed value "' + value + '" for feature "' + matchedFeature + '" in trim level "' + trimLevel + '", treating as NO');
						} else {
							// Default to false for any other value
							hasFeature = false;
							if (cleanedValue !== '') {
								console.warn('Unknown value "' + value + '" for feature "' + matchedFeature + '" in trim level "' + trimLevel + '", treating as NO');
							}
						}
						
						featureResults.push({
							feature: feature,
							matchedFeature: matchedFeature,
							value: value,
							cleanedValue: cleanedValue,
							hasFeature: hasFeature
						});
						
						console.log('Feature check for ' + trimLevel + ': "' + feature + '" -> "' + matchedFeature + '" = "' + value + '" (' + cleanedValue + ') -> ' + hasFeature);
						
						if (!hasFeature) {
							hasAllFeatures = false;
						}
					} else {
						console.log('Feature "' + feature + '" not found in column mapping even with fuzzy matching');
						hasAllFeatures = false;
					}
				});
				
				console.log('Trim level ' + trimLevel + ' feature check:', featureResults);
				console.log('Has all features:', hasAllFeatures);
				
				if (hasAllFeatures) {
					matchingTrimLevels.push(trimLevel);
				}
			}
		});
		
		console.log('Matching trim levels for ' + model + ':', matchingTrimLevels);
		
		// Update the HTML block with results
		var resultText = '';
		if (matchingTrimLevels.length > 0) {
			resultText = 'Available trim levels with your selected features: ' + matchingTrimLevels.join(', ');
		} else {
			resultText = 'No trim levels have all your selected features. Please adjust your selections.';
		}
		
		if (htmlBlock.length) {
			htmlBlock.find('p').text(resultText);
		}
		
		// Update the trim levels button
		if (trimLevelsButtonBlock.length) {
			var buttonText = matchingTrimLevels.length > 0 ? 
				'View Available Trim Levels (' + matchingTrimLevels.length + ')' : 
				'No Matching Trim Levels';
			
			trimLevelsButtonBlock.html('<button type="button" id="viewTrimLevelsButton" class="button">' + buttonText + '</button>');
			
			$('#viewTrimLevelsButton').off('click.trimLevels').on('click.trimLevels', function(e) {
				e.preventDefault();
				if (matchingTrimLevels.length > 0) {
					var detailsHtml = '<h2>Available Trim Levels for ' + model + '</h2>';
					detailsHtml += '<p>Based on your selected features, the following trim levels are available:</p>';
					detailsHtml += '<ul>';
					matchingTrimLevels.forEach(function(trimLevel) {
						detailsHtml += '<li><strong>' + trimLevel + '</strong></li>';
					});
					detailsHtml += '</ul>';
					detailsHtml += '<p>Selected features: ' + selectedFeatures.join(', ') + '</p>';
					
					// Show matched features for debugging
					if (matchingTrimLevels.length > 0) {
						detailsHtml += '<h3>Feature Matching Details:</h3>';
						matchingTrimLevels.forEach(function(trimLevel) {
							if (trimLevelRows[trimLevel]) {
								detailsHtml += '<h4>' + trimLevel + '</h4><ul>';
								selectedFeatures.forEach(function(feature) {
									var columnIndex = featureToColumnMap[feature];
									var matchedFeature = feature;
									
									// Try fuzzy matching if exact match not found
									if (columnIndex === undefined) {
										Object.keys(featureToColumnMap).forEach(function(csvFeature) {
											if (csvFeature.toLowerCase().includes(feature.toLowerCase())) {
												columnIndex = featureToColumnMap[csvFeature];
												matchedFeature = csvFeature;
											}
										});
									}
									
									if (columnIndex !== undefined) {
										var value = trimLevelRows[trimLevel][columnIndex];
										detailsHtml += '<li>' + feature + (matchedFeature !== feature ? ' (matched: ' + matchedFeature + ')' : '') + ': ' + value + '</li>';
									}
								});
								detailsHtml += '</ul>';
							}
						});
					}
					
					// Call the proper showTrimLevelsPopup function like other models
					showTrimLevelsPopup(model, matchingTrimLevels, model);
				} else {
					alert('No trim levels match your selected features. Please adjust your selections.');
				}
			});
		}
		
		// Store the results
		trimLevelsData[model] = matchingTrimLevels;
	}

	function processAcadiaTrimLevels(csvData, selectedFeatures, htmlBlock, trimLevelsButtonBlock, model) {
		console.log('Processing ACADIA trim levels for selected features:', selectedFeatures);
		
		var trimLevels = ['SL', 'SLE', 'SLT', 'DENALI', 'AT4']; // Common Acadia trim levels
		var matchingTrimLevels = [];
		var categories = ['EXTERIOR', 'INTERIOR', 'MECHANICAL', 'SAFETY', 'PACKAGES'];
		var featureToColumnMap = {};
		var featureToCategoryMap = {};
		var trimLevelRows = {};
		var trimLevelRowsByCategory = {};
		var currentCategory = null;
		
		// Parse the CSV data to map features to columns and find trim level rows
		csvData.forEach(function(row, rowIndex) {
			if (row.length > 0) {
				var firstCell = row[0] ? row[0].trim() : '';
				
				// Check if this is a category header row
				if (firstCell.startsWith('TRIM LEVELS FOR {')) {
					var category = firstCell.match(/\{(.+)\}/)[1];
					currentCategory = category;
					console.log('Found category:', category);
					
					// Initialize category storage if not exists
					if (!trimLevelRowsByCategory[category]) {
						trimLevelRowsByCategory[category] = {};
					}
					
					// Map features to their column indices
					for (var i = 1; i < row.length; i++) {
						var feature = row[i] ? row[i].trim() : '';
						if (feature && feature !== '') {
							// Clean up the feature name the same way as in populateAcadiaFeatures
							var cleanedFeature = feature;
							if (cleanedFeature.startsWith('"') && cleanedFeature.endsWith('"')) {
								cleanedFeature = cleanedFeature.slice(1, -1);
							}
							cleanedFeature = cleanedFeature.replace(/""/g, '"');
							
							featureToColumnMap[cleanedFeature] = i;
							featureToCategoryMap[cleanedFeature] = category;
							console.log('Mapped feature "' + cleanedFeature + '" (raw: "' + feature + '") to column ' + i + ' in category ' + category);
						}
					}
				}
				// Check if this is a trim level row
				else if (trimLevels.includes(firstCell) && currentCategory) {
					// Store in both global and category-specific storage
					trimLevelRows[firstCell] = row;
					trimLevelRowsByCategory[currentCategory][firstCell] = row;
					console.log('Found trim level row for:', firstCell, 'in category:', currentCategory);
				}
			}
		});
		
		console.log('Feature to column mapping:', featureToColumnMap);
		console.log('Feature to category mapping:', featureToCategoryMap);
		console.log('Trim level rows:', Object.keys(trimLevelRows));
		console.log('Trim level rows by category:', trimLevelRowsByCategory);
		
		// Check which trim levels have all selected features
		trimLevels.forEach(function(trimLevel) {
			if (trimLevelRows[trimLevel]) {
				var hasAllFeatures = true;
				var featureResults = [];
				
				selectedFeatures.forEach(function(feature) {
					var columnIndex = featureToColumnMap[feature];
					var matchedFeature = feature;
					
					// If exact match not found, try fuzzy matching
					if (columnIndex === undefined) {
						console.log('Feature "' + feature + '" not found in column mapping, trying fuzzy matching...');
						var bestMatch = null;
						var bestScore = 0;
						var threshold = 0.3; // Lower threshold for partial matches
						
						// Try to find partial matches
						Object.keys(featureToColumnMap).forEach(function(csvFeature) {
							var score = 0;
							
							// Check if the selected feature is contained in the CSV feature
							if (csvFeature.toLowerCase().includes(feature.toLowerCase())) {
								score = 0.8; // High score for containment
							}
							// Check if CSV feature starts with the selected feature
							else if (csvFeature.toLowerCase().startsWith(feature.toLowerCase())) {
								score = 0.7;
							}
							// Check if selected feature is a significant part of CSV feature
							else if (feature.length >= 3 && csvFeature.toLowerCase().includes(feature.toLowerCase())) {
								score = 0.6;
							}
							// Fuzzy string matching as fallback
							else {
								var featureNorm = feature.toLowerCase().replace(/[^a-z0-9]/g, '');
								var csvFeatureNorm = csvFeature.toLowerCase().replace(/[^a-z0-9]/g, '');
								if (featureNorm.length > 0 && csvFeatureNorm.length > 0) {
									var commonLength = 0;
									var maxLength = Math.max(featureNorm.length, csvFeatureNorm.length);
									for (var i = 0; i < Math.min(featureNorm.length, csvFeatureNorm.length); i++) {
										if (featureNorm[i] === csvFeatureNorm[i]) {
											commonLength++;
										} else {
											break;
										}
									}
									score = commonLength / maxLength;
								}
							}
							
							console.log('Fuzzy match attempt: "' + feature + '" vs "' + csvFeature + '": score=' + score);
							
							if (score > bestScore && score >= threshold) {
								bestScore = score;
								bestMatch = csvFeature;
							}
						});
						
						if (bestMatch) {
							console.log('Found fuzzy match for "' + feature + '": "' + bestMatch + '" (score: ' + bestScore + ')');
							columnIndex = featureToColumnMap[bestMatch];
							matchedFeature = bestMatch;
						}
					}
					
					if (columnIndex !== undefined) {
						// Get the category for this feature
						var featureCategory = featureToCategoryMap[matchedFeature];
						var value = null;
						
						// Use category-specific trim level data if available
						if (featureCategory && trimLevelRowsByCategory[featureCategory] && trimLevelRowsByCategory[featureCategory][trimLevel]) {
							value = trimLevelRowsByCategory[featureCategory][trimLevel][columnIndex];
							console.log('Using category-specific data for ' + trimLevel + ' in category ' + featureCategory + ', column ' + columnIndex + ': "' + value + '"');
						} else {
							// Fallback to global trim level data
							value = trimLevelRows[trimLevel][columnIndex];
							console.log('Using global data for ' + trimLevel + ', column ' + columnIndex + ': "' + value + '"');
						}
						
						// Clean up the value and check for YES
						var cleanedValue = value ? value.trim().toLowerCase() : '';
						var hasFeature = cleanedValue === 'yes';
						
						featureResults.push({
							feature: feature,
							matchedFeature: matchedFeature,
							value: value,
							cleanedValue: cleanedValue,
							hasFeature: hasFeature
						});
						
						console.log('Feature check for ' + trimLevel + ': "' + feature + '" -> "' + matchedFeature + '" = "' + value + '" (' + cleanedValue + ') -> ' + hasFeature);
						
						if (!hasFeature) {
							hasAllFeatures = false;
						}
					} else {
						console.log('Feature "' + feature + '" not found in column mapping even with fuzzy matching');
						hasAllFeatures = false;
					}
				});
				
				console.log('Trim level ' + trimLevel + ' feature check:', featureResults);
				console.log('Has all features:', hasAllFeatures);
				
				if (hasAllFeatures) {
					matchingTrimLevels.push(trimLevel);
				}
			}
		});
		
		console.log('Matching trim levels for ' + model + ':', matchingTrimLevels);
		
		// Update the HTML block with results
		var resultText = '';
		if (matchingTrimLevels.length > 0) {
			resultText = 'Available trim levels with your selected features: ' + matchingTrimLevels.join(', ');
		} else {
			resultText = 'No trim levels have all your selected features. Please adjust your selections.';
		}
		
		if (htmlBlock.length) {
			htmlBlock.find('p').text(resultText);
		}
		
		// Update the trim levels button
		if (trimLevelsButtonBlock.length) {
			var buttonText = matchingTrimLevels.length > 0 ? 
				'View Available Trim Levels (' + matchingTrimLevels.length + ')' : 
				'No Matching Trim Levels';
			
			trimLevelsButtonBlock.html('<button type="button" id="viewTrimLevelsButton" class="button">' + buttonText + '</button>');
			
			$('#viewTrimLevelsButton').off('click.trimLevels').on('click.trimLevels', function(e) {
				e.preventDefault();
				if (matchingTrimLevels.length > 0) {
					var detailsHtml = '<h2>Available Trim Levels for ' + model + '</h2>';
					detailsHtml += '<p>Based on your selected features, the following trim levels are available:</p>';
					detailsHtml += '<ul>';
					matchingTrimLevels.forEach(function(trimLevel) {
						detailsHtml += '<li><strong>' + trimLevel + '</strong></li>';
					});
					detailsHtml += '</ul>';
					detailsHtml += '<p>Selected features: ' + selectedFeatures.join(', ') + '</p>';
					
					// Show matched features for debugging
					if (matchingTrimLevels.length > 0) {
						detailsHtml += '<h3>Feature Matching Details:</h3>';
						matchingTrimLevels.forEach(function(trimLevel) {
							if (trimLevelRows[trimLevel]) {
								detailsHtml += '<h4>' + trimLevel + '</h4><ul>';
								selectedFeatures.forEach(function(feature) {
									var columnIndex = featureToColumnMap[feature];
									var matchedFeature = feature;
									
									// Try fuzzy matching if exact match not found
									if (columnIndex === undefined) {
										Object.keys(featureToColumnMap).forEach(function(csvFeature) {
											if (csvFeature.toLowerCase().includes(feature.toLowerCase())) {
												columnIndex = featureToColumnMap[csvFeature];
												matchedFeature = csvFeature;
											}
										});
									}
									
									if (columnIndex !== undefined) {
										var value = trimLevelRows[trimLevel][columnIndex];
										detailsHtml += '<li>' + feature + (matchedFeature !== feature ? ' (matched: ' + matchedFeature + ')' : '') + ': ' + value + '</li>';
									}
								});
								detailsHtml += '</ul>';
							}
						});
					}
					
					// Call the proper showTrimLevelsPopup function like other models
					showTrimLevelsPopup(model, matchingTrimLevels, model);
				} else {
					alert('No trim levels match your selected features. Please adjust your selections.');
				}
			});
		}
		
		// Store the results
		trimLevelsData[model] = matchingTrimLevels;
	}

	function processYukonTrimLevels(csvData, selectedFeatures, htmlBlock, trimLevelsButtonBlock, model) {
		console.log('Processing YUKON trim levels for selected features:', selectedFeatures);
		
		var trimLevels = ['AT4', 'DENALI', 'ELEVATION', 'AT4 ULTIMATE', 'DENALI ULTIMATE'];
		var matchingTrimLevels = [];
		var categories = ['EXTERIOR', 'INTERIOR', 'MECHANICAL', 'SAFETY', 'PACKAGES'];
		var featureToColumnMap = {};
		var featureToCategoryMap = {};
		var trimLevelRows = {};
		var trimLevelRowsByCategory = {};
		var currentCategory = null;
		
		// Parse the CSV data to map features to columns and find trim level rows
		csvData.forEach(function(row, rowIndex) {
			if (row.length > 0) {
				var firstCell = row[0] ? row[0].trim() : '';
				
				// Check if this is a category header row
				if (firstCell.startsWith('TRIM LEVELS FOR {')) {
					var category = firstCell.match(/\{(.+)\}/)[1];
					currentCategory = category;
					console.log('Found category:', category);
					
					// Initialize category storage if not exists
					if (!trimLevelRowsByCategory[category]) {
						trimLevelRowsByCategory[category] = {};
					}
					
					// Map features to their column indices
					for (var i = 1; i < row.length; i++) {
						var feature = row[i] ? row[i].trim() : '';
						if (feature && feature !== '') {
							// Clean up the feature name the same way as in populateYukonFeatures
							var cleanedFeature = feature;
							if (cleanedFeature.startsWith('"') && cleanedFeature.endsWith('"')) {
								cleanedFeature = cleanedFeature.slice(1, -1);
							}
							cleanedFeature = cleanedFeature.replace(/""/g, '"');
							
							featureToColumnMap[cleanedFeature] = i;
							featureToCategoryMap[cleanedFeature] = category;
							console.log('Mapped feature "' + cleanedFeature + '" (raw: "' + feature + '") to column ' + i + ' in category ' + category);
						}
					}
				}
				// Check if this is a trim level row
				else if (trimLevels.some(function(trim) { return firstCell.startsWith(trim); }) && currentCategory) {
					var trimLevel = firstCell.split(' ')[0] === 'AT4' && firstCell.indexOf('ULTIMATE') !== -1 ? 'AT4 ULTIMATE' : 
									firstCell.split(' ')[0] === 'DENALI' && firstCell.indexOf('ULTIMATE') !== -1 ? 'DENALI ULTIMATE' : 
									firstCell.split(' ')[0];
					
					// Store in both global and category-specific storage
					trimLevelRows[trimLevel] = row;
					trimLevelRowsByCategory[currentCategory][trimLevel] = row;
					console.log('Found trim level row for:', trimLevel, 'in category:', currentCategory);
				}
			}
		});
		
		console.log('Feature to column mapping:', featureToColumnMap);
		console.log('Feature to category mapping:', featureToCategoryMap);
		console.log('Trim level rows:', Object.keys(trimLevelRows));
		console.log('Trim level rows by category:', trimLevelRowsByCategory);
		
		// Check which trim levels have all selected features
		trimLevels.forEach(function(trimLevel) {
			if (trimLevelRows[trimLevel]) {
				var hasAllFeatures = true;
				var featureResults = [];
				
				selectedFeatures.forEach(function(feature) {
					var columnIndex = featureToColumnMap[feature];
					var matchedFeature = feature;
					
					// If exact match not found, try fuzzy matching
					if (columnIndex === undefined) {
						console.log('Feature "' + feature + '" not found in column mapping, trying fuzzy matching...');
						var bestMatch = null;
						var bestScore = 0;
						var threshold = 0.3; // Lower threshold for partial matches
						
						// Try to find partial matches
						Object.keys(featureToColumnMap).forEach(function(csvFeature) {
							var score = 0;
							
							// Check if the selected feature is contained in the CSV feature
							if (csvFeature.toLowerCase().includes(feature.toLowerCase())) {
								score = 0.8; // High score for containment
							}
							// Check if CSV feature starts with the selected feature
							else if (csvFeature.toLowerCase().startsWith(feature.toLowerCase())) {
								score = 0.7;
							}
							// Check if selected feature is a significant part of CSV feature
							else if (feature.length >= 3 && csvFeature.toLowerCase().includes(feature.toLowerCase())) {
								score = 0.6;
							}
							// Fuzzy string matching as fallback
							else {
								var featureNorm = feature.toLowerCase().replace(/[^a-z0-9]/g, '');
								var csvFeatureNorm = csvFeature.toLowerCase().replace(/[^a-z0-9]/g, '');
								if (featureNorm.length > 0 && csvFeatureNorm.length > 0) {
									var commonLength = 0;
									var maxLength = Math.max(featureNorm.length, csvFeatureNorm.length);
									for (var i = 0; i < Math.min(featureNorm.length, csvFeatureNorm.length); i++) {
										if (featureNorm[i] === csvFeatureNorm[i]) {
											commonLength++;
										} else {
											break;
										}
									}
									score = commonLength / maxLength;
								}
							}
							
							console.log('Fuzzy match attempt: "' + feature + '" vs "' + csvFeature + '": score=' + score);
							
							if (score > bestScore && score >= threshold) {
								bestScore = score;
								bestMatch = csvFeature;
							}
						});
						
						if (bestMatch) {
							console.log('Found fuzzy match for "' + feature + '": "' + bestMatch + '" (score: ' + bestScore + ')');
							columnIndex = featureToColumnMap[bestMatch];
							matchedFeature = bestMatch;
						}
					}
					
					if (columnIndex !== undefined) {
						// Get the category for this feature
						var featureCategory = featureToCategoryMap[matchedFeature];
						var value = null;
						
						// Use category-specific trim level data if available
						if (featureCategory && trimLevelRowsByCategory[featureCategory] && trimLevelRowsByCategory[featureCategory][trimLevel]) {
							value = trimLevelRowsByCategory[featureCategory][trimLevel][columnIndex];
							console.log('Using category-specific data for ' + trimLevel + ' in category ' + featureCategory + ', column ' + columnIndex + ': "' + value + '"');
						} else {
							// Fallback to global trim level data
							value = trimLevelRows[trimLevel][columnIndex];
							console.log('Using global data for ' + trimLevel + ', column ' + columnIndex + ': "' + value + '"');
						}
						// Clean up the value and check for YES (handle edge cases like "YNO" -> "NO")
						var cleanedValue = value ? value.trim().toLowerCase() : '';
						var hasFeature = false;
						
						if (cleanedValue === 'yes') {
							hasFeature = true;
						} else if (cleanedValue === 'no') {
							hasFeature = false;
						} else if (cleanedValue.startsWith('y') && cleanedValue.length <= 4) {
							// Handle cases like "YNO" which should be "NO"
							hasFeature = false;
							console.warn('Found malformed value "' + value + '" for feature "' + matchedFeature + '" in trim level "' + trimLevel + '", treating as NO');
						} else {
							// Default to false for any other value
							hasFeature = false;
							if (cleanedValue !== '') {
								console.warn('Unknown value "' + value + '" for feature "' + matchedFeature + '" in trim level "' + trimLevel + '", treating as NO');
							}
						}
						
						featureResults.push({
							feature: feature,
							matchedFeature: matchedFeature,
							value: value,
							cleanedValue: cleanedValue,
							hasFeature: hasFeature
						});
						
						console.log('Feature check for ' + trimLevel + ': "' + feature + '" -> "' + matchedFeature + '" = "' + value + '" (' + cleanedValue + ') -> ' + hasFeature);
						
						if (!hasFeature) {
							hasAllFeatures = false;
						}
					} else {
						console.log('Feature "' + feature + '" not found in column mapping even with fuzzy matching');
						hasAllFeatures = false;
					}
				});
				
				console.log('Trim level ' + trimLevel + ' feature check:', featureResults);
				console.log('Has all features:', hasAllFeatures);
				
				if (hasAllFeatures) {
					matchingTrimLevels.push(trimLevel);
				}
			}
		});
		
		console.log('Matching trim levels for ' + model + ':', matchingTrimLevels);
		
		// Update the HTML block with results
		var resultText = '';
		if (matchingTrimLevels.length > 0) {
			resultText = 'Available trim levels with your selected features: ' + matchingTrimLevels.join(', ');
		} else {
			resultText = 'No trim levels have all your selected features. Please adjust your selections.';
		}
		
		if (htmlBlock.length) {
			htmlBlock.find('p').text(resultText);
		}
		
		// Update the trim levels button
		if (trimLevelsButtonBlock.length) {
			var buttonText = matchingTrimLevels.length > 0 ? 
				'View Available Trim Levels (' + matchingTrimLevels.length + ')' : 
				'No Matching Trim Levels';
			
			trimLevelsButtonBlock.html('<button type="button" id="viewTrimLevelsButton" class="button">' + buttonText + '</button>');
			
			$('#viewTrimLevelsButton').off('click.trimLevels').on('click.trimLevels', function(e) {
				e.preventDefault();
				if (matchingTrimLevels.length > 0) {
					var detailsHtml = '<h2>Available Trim Levels for ' + model + '</h2>';
					detailsHtml += '<p>Based on your selected features, the following trim levels are available:</p>';
					detailsHtml += '<ul>';
					matchingTrimLevels.forEach(function(trimLevel) {
						detailsHtml += '<li><strong>' + trimLevel + '</strong></li>';
					});
					detailsHtml += '</ul>';
					detailsHtml += '<p>Selected features: ' + selectedFeatures.join(', ') + '</p>';
					
					// Show matched features for debugging
					if (matchingTrimLevels.length > 0) {
						detailsHtml += '<h3>Feature Matching Details:</h3>';
						matchingTrimLevels.forEach(function(trimLevel) {
							if (trimLevelRows[trimLevel]) {
								detailsHtml += '<h4>' + trimLevel + '</h4><ul>';
								selectedFeatures.forEach(function(feature) {
									var columnIndex = featureToColumnMap[feature];
									var matchedFeature = feature;
									
									// Try fuzzy matching if exact match not found
									if (columnIndex === undefined) {
										Object.keys(featureToColumnMap).forEach(function(csvFeature) {
											if (csvFeature.toLowerCase().includes(feature.toLowerCase())) {
												columnIndex = featureToColumnMap[csvFeature];
												matchedFeature = csvFeature;
											}
										});
									}
									
									if (columnIndex !== undefined) {
										var value = trimLevelRows[trimLevel][columnIndex];
										detailsHtml += '<li>' + feature + (matchedFeature !== feature ? ' (matched: ' + matchedFeature + ')' : '') + ': ' + value + '</li>';
									}
								});
								detailsHtml += '</ul>';
							}
						});
					}
					
					// Call the proper showTrimLevelsPopup function like other models
					showTrimLevelsPopup(model, matchingTrimLevels, model);
				} else {
					alert('No trim levels match your selected features. Please adjust your selections.');
				}
			});
		}
		
		// Store the results
		trimLevelsData[model] = matchingTrimLevels;
	}

	function processCanyonTrimLevels(csvData, selectedFeatures, htmlBlock, trimLevelsButtonBlock, model) {
		console.log('Processing CANYON trim levels for selected features:', selectedFeatures);
		
		var trimLevels = ['AT4', 'DENALI', 'ELEVATION'];
		var matchingTrimLevels = [];
		var categories = ['EXTERIOR', 'INTERIOR', 'MECHANICAL', 'SAFETY', 'PACKAGES'];
		var featureToColumnMap = {};
		var featureToCategoryMap = {};
		var trimLevelRows = {};
		var trimLevelRowsByCategory = {};
		var currentCategory = null;
		
		// Parse the CSV data to map features to columns and find trim level rows
		csvData.forEach(function(row, rowIndex) {
			if (row && row.length > 0) {
				var firstCell = row[0];
				
				// Check if this is a category header
				if (firstCell && firstCell.includes('TRIM LEVELS FOR {')) {
					currentCategory = categories.find(function(cat) {
						return firstCell.includes(cat);
					});
					
					if (currentCategory) {
						console.log('Found category:', currentCategory);
						
						// Map features to their column indices for this category
						for (var i = 1; i < row.length; i++) {
							var feature = row[i];
							if (feature && feature.trim() !== '') {
								var featureKey = feature.trim();
								featureToColumnMap[featureKey] = i;
								featureToCategoryMap[featureKey] = currentCategory;
								console.log('Mapped feature:', featureKey, 'to column:', i, 'category:', currentCategory);
							}
						}
						
						// Initialize trim level rows for this category
						trimLevelRowsByCategory[currentCategory] = {};
					}
				}
				// Check if this is a trim level row
				else if (firstCell && trimLevels.includes(firstCell)) {
					var trimLevel = firstCell;
					trimLevelRows[trimLevel] = row;
					
					if (currentCategory) {
						trimLevelRowsByCategory[currentCategory][trimLevel] = row;
					}
					
					console.log('Found trim level row:', trimLevel, 'in category:', currentCategory);
				}
			}
		});
		
		console.log('Feature to column mapping:', featureToColumnMap);
		console.log('Trim level rows:', trimLevelRows);
		
		// For each trim level, check if it matches ALL selected features
		trimLevels.forEach(function(trimLevel) {
			var trimLevelRow = trimLevelRows[trimLevel];
			if (!trimLevelRow) {
				console.log('No row found for trim level:', trimLevel);
				return;
			}
			
			var matchesAll = true;
			var matchedFeatures = [];
			
			selectedFeatures.forEach(function(feature) {
				var columnIndex = featureToColumnMap[feature];
				
				// Clean up the feature name the same way as in populateCanyonFeatures
				var cleanFeatureName = feature.replace(/[^a-zA-Z0-9\s]/g, '').trim();
				
				// If exact match not found, try fuzzy matching
				if (columnIndex === undefined) {
					console.log('Exact match not found for feature:', feature, 'trying fuzzy matching...');
					
					// Try with cleaned feature name
					if (cleanFeatureName && cleanFeatureName !== feature) {
						columnIndex = featureToColumnMap[cleanFeatureName];
						console.log('Cleaned feature name match:', cleanFeatureName, 'column:', columnIndex);
					}
					
					// If still not found, try fuzzy matching
					if (columnIndex === undefined) {
						var bestMatch = null;
						var bestScore = 0;
						var threshold = 0.3; // Lower threshold for partial matches
						
						// Try to find partial matches
						Object.keys(featureToColumnMap).forEach(function(csvFeature) {
							var score = 0;
							
							// Check if the selected feature is contained in the CSV feature
							if (csvFeature.toLowerCase().includes(feature.toLowerCase())) {
								score = 0.8; // High score for containment
							}
							// Check if CSV feature starts with the selected feature
							else if (csvFeature.toLowerCase().startsWith(feature.toLowerCase())) {
								score = 0.7;
							}
							// Check if selected feature is a significant part of CSV feature
							else if (feature.length >= 3 && csvFeature.toLowerCase().includes(feature.toLowerCase())) {
								score = 0.6;
							}
							// Fuzzy string matching as fallback
							else {
								var similarity = calculateSimilarity(feature.toLowerCase(), csvFeature.toLowerCase());
								if (similarity > threshold) {
									score = similarity;
								}
							}
							
							if (score > bestScore) {
								bestScore = score;
								bestMatch = csvFeature;
							}
						});
						
						if (bestMatch) {
							columnIndex = featureToColumnMap[bestMatch];
							console.log('Fuzzy match found for:', feature, '-> matched:', bestMatch, 'column:', columnIndex, 'score:', bestScore);
						}
					}
				}
				
				if (columnIndex !== undefined) {
					var value = trimLevelRow[columnIndex];
					console.log('Checking feature:', feature, 'column:', columnIndex, 'value:', value, 'for trim level:', trimLevel);
					
					if (value && value.toUpperCase() === 'YES') {
						matchedFeatures.push(feature);
					} else {
						matchesAll = false;
						console.log('Feature', feature, 'not available for trim level:', trimLevel, '(value:', value, ')');
					}
				} else {
					matchesAll = false;
					console.log('Feature', feature, 'not found in CSV for trim level:', trimLevel);
				}
			});
			
			if (matchesAll) {
				matchingTrimLevels.push(trimLevel);
				console.log('‚úÖ Trim level', trimLevel, 'matches all selected features');
			} else {
				console.log('‚ùå Trim level', trimLevel, 'does not match all selected features');
			}
		});
		
		console.log('Matching trim levels for Canyon:', matchingTrimLevels);
		
		// Display results
		if (trimLevelsButtonBlock && trimLevelsButtonBlock.length) {
			var buttonText = matchingTrimLevels.length > 0 ? 
				'View Available Trim Levels (' + matchingTrimLevels.length + ')' : 
				'No Matching Trim Levels';
			
			trimLevelsButtonBlock.html('<button type="button" id="viewTrimLevelsButton" class="button">' + buttonText + '</button>');
			
			$('#viewTrimLevelsButton').off('click.trimLevels').on('click.trimLevels', function(e) {
				e.preventDefault();
				if (matchingTrimLevels.length > 0) {
					var detailsHtml = '<h2>Available Trim Levels for ' + model + '</h2>';
					detailsHtml += '<p>Based on your selected features, the following trim levels are available:</p>';
					detailsHtml += '<ul>';
					matchingTrimLevels.forEach(function(trimLevel) {
						detailsHtml += '<li><strong>' + trimLevel + '</strong></li>';
					});
					detailsHtml += '</ul>';
					detailsHtml += '<p>Selected features: ' + selectedFeatures.join(', ') + '</p>';
					
					// Show matched features for debugging
					if (matchingTrimLevels.length > 0) {
						detailsHtml += '<h3>Feature Matching Details:</h3>';
						matchingTrimLevels.forEach(function(trimLevel) {
							if (trimLevelRows[trimLevel]) {
								detailsHtml += '<h4>' + trimLevel + '</h4><ul>';
								selectedFeatures.forEach(function(feature) {
									var columnIndex = featureToColumnMap[feature];
									var matchedFeature = feature;
									
									// Try fuzzy matching if exact match not found
									if (columnIndex === undefined) {
										Object.keys(featureToColumnMap).forEach(function(csvFeature) {
											if (csvFeature.toLowerCase().includes(feature.toLowerCase())) {
												columnIndex = featureToColumnMap[csvFeature];
												matchedFeature = csvFeature;
											}
										});
									}
									
									if (columnIndex !== undefined) {
										var value = trimLevelRows[trimLevel][columnIndex];
										detailsHtml += '<li>' + feature + (matchedFeature !== feature ? ' (matched: ' + matchedFeature + ')' : '') + ': ' + value + '</li>';
									}
								});
								detailsHtml += '</ul>';
							}
						});
					}
					
					showFeatureDescription('Available Trim Levels', detailsHtml);
				} else {
					alert('No trim levels match your selected features. Please adjust your selections.');
				}
			});
		}
		
		// Store the results
		trimLevelsData[model] = matchingTrimLevels;
	}

	function updateTrimLevels(model) {
    var config = modelConfigs[model];
    if (!config) {
        console.warn('Model configuration not found for: ' + model);
        return;
    }
    var checkboxField, htmlBlock, trimLevelsButtonBlock;
    
    if (model === 'TERRAIN') {
        // For TERRAIN, checkboxes are in field 137 (HTML block)
        checkboxField = $('#field_' + formId + '_' + terrainHtmlBlockFieldId);
        if (!checkboxField.length) {
            checkboxField = $('#field_' + formId + '_137');
        }
        if (!checkboxField.length) {
            checkboxField = $('[id*="137"]').filter(function() {
                return $(this).attr('id').includes('field') || $(this).attr('id').includes('input');
            });
        }
        
        console.log('TERRAIN checkboxField debug:', {
            terrainHtmlBlockFieldId: terrainHtmlBlockFieldId,
            selector1: '#field_' + formId + '_' + terrainHtmlBlockFieldId,
            selector2: '#field_' + formId + '_137',
            found: checkboxField.length,
            actualId: checkboxField.attr('id'),
            hasCheckboxes: checkboxField.find('input[type="checkbox"]').length
        });
        
        htmlBlock = $('#field_' + formId + '_' + htmlBlockFieldId);
        trimLevelsButtonBlock = $('#field_' + formId + '_' + trimLevelsButtonFieldId);
    } else if (model === 'ACADIA') {
        // For ACADIA, checkboxes are in field 138 (HTML block)
        checkboxField = $('#field_' + formId + '_' + acadiaHtmlBlockFieldId);
        if (!checkboxField.length) {
            checkboxField = $('#field_' + formId + '_138');
        }
        if (!checkboxField.length) {
            checkboxField = $('[id*="138"]').filter(function() {
                return $(this).attr('id').includes('field') || $(this).attr('id').includes('input');
            });
        }
        
        console.log('ACADIA checkboxField debug:', {
            acadiaHtmlBlockFieldId: acadiaHtmlBlockFieldId,
            selector1: '#field_' + formId + '_' + acadiaHtmlBlockFieldId,
            selector2: '#field_' + formId + '_138',
            found: checkboxField.length,
            actualId: checkboxField.attr('id'),
            hasCheckboxes: checkboxField.find('input[type="checkbox"]').length
        });
        
        htmlBlock = $('#field_' + formId + '_' + htmlBlockFieldId);
        trimLevelsButtonBlock = $('#field_' + formId + '_' + trimLevelsButtonFieldId);
    } else if (model === 'YUKON') {
        // For YUKON, checkboxes are in field 139 (HTML block)
        checkboxField = $('#field_' + formId + '_' + yukonHtmlBlockFieldId);
        if (!checkboxField.length) {
            checkboxField = $('#field_' + formId + '_139');
        }
        if (!checkboxField.length) {
            checkboxField = $('[id*="139"]').filter(function() {
                return $(this).attr('id').includes('field') || $(this).attr('id').includes('input');
            });
        }
        
        console.log('YUKON checkboxField debug:', {
            yukonHtmlBlockFieldId: yukonHtmlBlockFieldId,
            selector1: '#field_' + formId + '_' + yukonHtmlBlockFieldId,
            selector2: '#field_' + formId + '_139',
            found: checkboxField.length,
            actualId: checkboxField.attr('id'),
            hasCheckboxes: checkboxField.find('input[type="checkbox"]').length
        });
        
        htmlBlock = $('#field_' + formId + '_' + htmlBlockFieldId);
        trimLevelsButtonBlock = $('#field_' + formId + '_' + trimLevelsButtonFieldId);
    } else if (model === 'CANYON') {
        // For CANYON, checkboxes are in field 140 (HTML block)
        checkboxField = $('#field_' + formId + '_' + canyonHtmlBlockFieldId);
        if (!checkboxField.length) {
            checkboxField = $('#field_' + formId + '_140');
        }
        if (!checkboxField.length) {
            checkboxField = $('[id*="140"]').filter(function() {
                return $(this).attr('id').includes('field') || $(this).attr('id').includes('input');
            });
        }
        
        console.log('CANYON checkboxField debug:', {
            canyonHtmlBlockFieldId: canyonHtmlBlockFieldId,
            selector1: '#field_' + formId + '_' + canyonHtmlBlockFieldId,
            selector2: '#field_' + formId + '_140',
            found: checkboxField.length,
            actualId: checkboxField.attr('id'),
            hasCheckboxes: checkboxField.find('input[type="checkbox"]').length
        });
        
        htmlBlock = $('#field_' + formId + '_' + htmlBlockFieldId);
        trimLevelsButtonBlock = $('#field_' + formId + '_' + trimLevelsButtonFieldId);
    } else {
        // For other models, checkboxes are in their respective fields
        checkboxField = $('#field_' + formId + '_' + config.fieldId);
        htmlBlock = $('#field_' + formId + '_' + htmlBlockFieldId);
        trimLevelsButtonBlock = $('#field_' + formId + '_' + trimLevelsButtonFieldId);
    }
    
    var defaultText = 'Wonderful, it sounds like the {TRIM LEVELS} would be the best fit, which has all of these features and it is available! One moment while I plug this car in.';
    var defaultButtonText = '<button id="viewTrimLevelsButton">View Trim Levels</button>';
    var noMatchText = 'No matching trim levels found. Please adjust your feature selections or contact support.';

    console.log('Checking ' + model + ' checkbox field (ID: ' + (model === 'TERRAIN' ? terrainHtmlBlockFieldId : model === 'ACADIA' ? acadiaHtmlBlockFieldId : model === 'YUKON' ? yukonHtmlBlockFieldId : model === 'CANYON' ? canyonHtmlBlockFieldId : config.fieldId) + '):', {
        fieldExists: checkboxField.length > 0,
        fieldVisible: checkboxField.is(':visible'),
        fieldClasses: checkboxField.attr('class'),
        fieldStyle: checkboxField.attr('style'),
        checkboxCount: checkboxField.find('input[type="checkbox"]').length,
        domStructure: checkboxField.html().substring(0, 500)
    });

    // Ensure feature info icons are prepended before feature labels
    if (model === 'TERRAIN') {
        // For TERRAIN, handle the different structure
        checkboxField.find('.gchoice').each(function() {
            var $div = $(this);
            var $input = $div.find('input[type="checkbox"]');
            var $label = $div.find('label');
            var feature = $input.attr('value') || '';
            
            if (!feature || !$input.length) {
                console.warn('Invalid TERRAIN checkbox structure in field (ID: ' + terrainHtmlBlockFieldId + ')', {
                    feature: feature,
                    inputExists: $input.length > 0,
                    labelExists: $label.length > 0,
                    divHtml: $div.html(),
                    inputId: $input.attr('id'),
                    labelClasses: $label.attr('class'),
                    parentClasses: $div.attr('class')
                });
                return;
            }
            
            var matchedFeature = Object.keys(featureDescriptions).find(function(key) {
                return fuzzyMatch(key, feature, model, feature);
            });
            if (matchedFeature && !$div.find('.feature-info-icon[data-feature="' + matchedFeature + '"]').length) {
                $label.prepend('<span class="feature-info-icon" data-feature="' + matchedFeature + '">i</span>');
                console.log('Prepended info icon before TERRAIN feature: ' + feature + ', matched: ' + matchedFeature);
            }
        });
    } else if (model === 'ACADIA') {
        // For ACADIA, handle the different structure
        checkboxField.find('.gchoice').each(function() {
            var $div = $(this);
            var $input = $div.find('input[type="checkbox"]');
            var $label = $div.find('label');
            var feature = $input.attr('value') || '';
            
            if (!feature || !$input.length) {
                console.warn('Invalid ACADIA checkbox structure in field (ID: ' + acadiaHtmlBlockFieldId + ')', {
                    feature: feature,
                    inputExists: $input.length > 0,
                    labelExists: $label.length > 0,
                    divHtml: $div.html(),
                    inputId: $input.attr('id'),
                    labelClasses: $label.attr('class'),
                    parentClasses: $div.attr('class')
                });
                return;
            }
            
            var matchedFeature = Object.keys(featureDescriptions).find(function(key) {
                return fuzzyMatch(key, feature, model, feature);
            });
            if (matchedFeature && !$div.find('.feature-info-icon[data-feature="' + matchedFeature + '"]').length) {
                $label.prepend('<span class="feature-info-icon" data-feature="' + matchedFeature + '">i</span>');
                console.log('Prepended info icon before ACADIA feature: ' + feature + ', matched: ' + matchedFeature);
            }
        });
    } else if (model === 'YUKON') {
        // For YUKON, handle the different structure
        checkboxField.find('.gchoice').each(function() {
            var $div = $(this);
            var $input = $div.find('input[type="checkbox"]');
            var $label = $div.find('label');
            var feature = $input.attr('value') || '';
            
            if (!feature || !$input.length) {
                console.warn('Invalid YUKON checkbox structure in field (ID: ' + yukonHtmlBlockFieldId + ')', {
                    feature: feature,
                    inputExists: $input.length > 0,
                    labelExists: $label.length > 0,
                    divHtml: $div.html(),
                    inputId: $input.attr('id'),
                    labelClasses: $label.attr('class'),
                    parentClasses: $div.attr('class')
                });
                return;
            }
            
            var matchedFeature = Object.keys(featureDescriptions).find(function(key) {
                return fuzzyMatch(key, feature, model, feature);
            });
            if (matchedFeature && !$div.find('.feature-info-icon[data-feature="' + matchedFeature + '"]').length) {
                $label.prepend('<span class="feature-info-icon" data-feature="' + matchedFeature + '">i</span>');
                console.log('Prepended info icon before YUKON feature: ' + feature + ', matched: ' + matchedFeature);
            }
        });
    } else if (model === 'CANYON') {
        // For CANYON, handle the different structure
        checkboxField.find('.feature-item').each(function() {
            var $div = $(this);
            var $input = $div.find('input[type="checkbox"]');
            var $label = $div.find('label');
            var feature = $input.attr('value') || '';
            
            if (!feature || !$input.length) {
                console.warn('Invalid CANYON checkbox structure in field (ID: ' + canyonHtmlBlockFieldId + ')', {
                    feature: feature,
                    inputExists: $input.length > 0,
                    labelExists: $label.length > 0,
                    divHtml: $div.html(),
                    inputId: $input.attr('id'),
                    labelClasses: $label.attr('class'),
                    parentClasses: $div.attr('class')
                });
                return;
            }
            
            // Icons are already added in populateCanyonFeatures function
            console.log('CANYON feature item processed:', feature);
        });
    } else {
        // For other models, use existing logic
        checkboxField.find('.gfield_checkbox > div, .gfield-choice-wrapper').each(function() {
            var $div = $(this);
            var $input = $div.find('input[type="checkbox"]');
            var $label = $div.find('label, .gfield-choice-label');
            var feature = '';
            if ($label.length) {
                feature = $label.contents().filter(function() {
                    return this.nodeType === 3; // Text nodes only, excludes .feature-info-icon
                }).text().trim();
            }
            if (!feature || !$input.length) {
                console.warn('Invalid checkbox structure in field (ID: ' + config.fieldId + ')', {
                    feature: feature,
                    inputExists: $input.length > 0,
                    labelExists: $label.length > 0,
                    divHtml: $div.html(),
                    inputId: $input.attr('id'),
                    labelClasses: $label.attr('class'),
                    parentClasses: $div.attr('class'),
                    parentHtml: $div.parent().html().substring(0, 500)
                });
                return;
            }
            var matchedFeature = Object.keys(featureDescriptions).find(function(key) {
                return model === 'K4' ? key.toUpperCase() === feature.toUpperCase() : fuzzyMatch(key, feature, model, feature);
            });
            if (matchedFeature && !$div.find('.feature-info-icon[data-feature="' + matchedFeature + '"]').length) {
                $label.prepend('<span class="feature-info-icon" data-feature="' + matchedFeature + '">i</span>');
                console.log('Prepended info icon before feature: ' + feature + ', matched: ' + matchedFeature);
            }
        });
    }

    // Bind click events for feature info icons with explicit propagation stop
    checkboxField.find('.feature-info-icon').off('click.featureInfo').on('click.featureInfo', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var feature = $(this).data('feature');
        // Use GMC Terrain descriptions for TERRAIN model, GMC Yukon descriptions for YUKON model, otherwise use KIA descriptions
        var description;
        if (model === 'TERRAIN') {
            console.log('TERRAIN model detected, using GMC descriptions');
            console.log('Feature to lookup:', feature);
            console.log('Feature uppercase:', feature.toUpperCase());
            console.log('Available terrain descriptions:', Object.keys(terrainFeatureDescriptions));
            description = terrainFeatureDescriptions[feature.toUpperCase()];
            if (!description) {
                var bestMatch = findBestDescriptionMatch(feature.toUpperCase(), terrainFeatureDescriptions);
                description = bestMatch || 'No description available for ' + feature;
            }
            console.log('Found description:', description);
        } else if (model === 'ACADIA') {
            console.log('ACADIA model detected, using GMC descriptions');
            console.log('Feature to lookup:', feature);
            console.log('Feature uppercase:', feature.toUpperCase());
            console.log('Available acadia descriptions:', Object.keys(acadiaFeatureDescriptions));
            description = acadiaFeatureDescriptions[feature.toUpperCase()];
            if (!description) {
                var bestMatch = findBestDescriptionMatch(feature.toUpperCase(), acadiaFeatureDescriptions);
                description = bestMatch || 'No description available for ' + feature;
            }
            console.log('Found description:', description);
        } else if (model === 'YUKON') {
            console.log('YUKON model detected, using GMC descriptions');
            console.log('Feature to lookup:', feature);
            console.log('Feature uppercase:', feature.toUpperCase());
            console.log('Available yukon descriptions:', Object.keys(yukonFeatureDescriptions));
            description = yukonFeatureDescriptions[feature.toUpperCase()];
            if (!description) {
                var bestMatch = findBestDescriptionMatch(feature.toUpperCase(), yukonFeatureDescriptions);
                description = bestMatch || 'No description available for ' + feature;
            }
            console.log('Found description:', description);
        } else if (model === 'CANYON') {
            console.log('CANYON model detected, using GMC descriptions');
            console.log('Feature to lookup:', feature);
            console.log('Feature uppercase:', feature.toUpperCase());
            console.log('Available canyon descriptions:', Object.keys(canyonFeatureDescriptions));
            description = canyonFeatureDescriptions[feature.toUpperCase()];
            if (!description) {
                var bestMatch = findBestDescriptionMatch(feature.toUpperCase(), canyonFeatureDescriptions);
                description = bestMatch || 'No description available for ' + feature;
            }
            console.log('Found description:', description);
        } else {
            description = featureDescriptions[feature] || 'No description available for ' + feature;
        }
        console.log('Feature info icon clicked for: ' + feature, {
            eventTarget: e.target,
            featureData: feature,
            description: description,
            model: model
        });
        showFeatureDescription(feature, description);
    });

    if (!checkboxField.length || (model !== 'K5' && model !== 'TERRAIN' && model !== 'ACADIA' && model !== 'YUKON' && model !== 'CANYON' && !checkboxField.is(':visible'))) {
        console.log(model + ' checkbox field not found or not visible, resetting HTML block');
        if (htmlBlock.length) {
            htmlBlock.find('p').text(defaultText);
        }
        if (trimLevelsButtonBlock.length) {
            trimLevelsButtonBlock.html(defaultButtonText);
            $('#viewTrimLevelsButton').off('click.trimLevels').on('click.trimLevels', function(e) {
                e.preventDefault();
                console.log('View Trim Levels button clicked, no trim levels available');
                alert('No trim levels selected. Please select features to view available trim levels.');
            });
        }
        if (model === 'K5') {
            console.warn('K5 checkbox field (ID: 85) not found or not visible, checking form structure');
            var formFields = $('#gform_fields_' + formId).find('.gfield').map(function() { return $(this).attr('id'); }).get();
            console.log('All form field IDs:', formFields);
        }
        if (model === 'TERRAIN') {
            console.warn('TERRAIN HTML block field (ID: 137) not found or not visible, checking form structure');
            var formFields = $('#gform_fields_' + formId).find('.gfield').map(function() { return $(this).attr('id'); }).get();
            console.log('All form field IDs:', formFields);
        }
        if (model === 'ACADIA') {
            console.warn('ACADIA HTML block field (ID: 138) not found or not visible, checking form structure');
            var formFields = $('#gform_fields_' + formId).find('.gfield').map(function() { return $(this).attr('id'); }).get();
            console.log('All form field IDs:', formFields);
        }
        trimLevelsData[model] = [];
        return;
    }

    // Debug checkbox field contents
    console.log('=== CHECKBOX FIELD DEBUG ===');
    console.log('Model:', model);
    console.log('Checkbox field exists:', checkboxField.length > 0);
    console.log('Checkbox field selector used:', checkboxField.selector || 'N/A');
    console.log('Checkbox field HTML preview:', checkboxField.html() ? checkboxField.html().substring(0, 500) : 'N/A');
    
    var allCheckboxes = checkboxField.find('input[type="checkbox"]');
    console.log('Total checkboxes found:', allCheckboxes.length);
    
    var checkedCheckboxes = checkboxField.find('input[type="checkbox"]:checked');
    console.log('Checked checkboxes found:', checkedCheckboxes.length);
    
    // Debug all checkboxes
    allCheckboxes.each(function(index) {
        var $input = $(this);
        console.log('Checkbox ' + index + ':', {
            id: $input.attr('id'),
            name: $input.attr('name'),
            value: $input.attr('value') ? $input.attr('value').substring(0, 50) + '...' : 'N/A',
            checked: $input.is(':checked'),
            type: $input.attr('type'),
            parentClass: $input.parent().attr('class')
        });
    });
    
    var selectedFeatures = checkboxField.find('input[type="checkbox"]:checked').map(function() {
        var $input = $(this);
        var feature = '';
        
        if (model === 'TERRAIN') {
            // For TERRAIN, get feature from the global mapping using the checkbox value
            var checkboxValue = $input.attr('value') || '';
            feature = window.terrainFeatureMap && window.terrainFeatureMap[checkboxValue] ? window.terrainFeatureMap[checkboxValue] : '';
            // No need to unescape since we're not storing escaped values anymore
            
            console.log('TERRAIN checkbox debug:', {
                id: $input.attr('id'),
                checkboxValue: checkboxValue,
                mappedFeature: feature,
                featureLength: feature.length,
                name: $input.attr('name'),
                checked: $input.is(':checked'),
                labelText: $input.next('label').text().substring(0, 100)
            });
        } else if (model === 'YUKON') {
            // For YUKON, get feature from the global mapping using the checkbox value
            var checkboxValue = $input.attr('value') || '';
            feature = window.yukonFeatureMap && window.yukonFeatureMap[checkboxValue] ? window.yukonFeatureMap[checkboxValue] : '';
            // No need to unescape since we're not storing escaped values anymore
            
            console.log('YUKON checkbox debug:', {
                id: $input.attr('id'),
                checkboxValue: checkboxValue,
                mappedFeature: feature,
                featureLength: feature.length,
                name: $input.attr('name'),
                checked: $input.is(':checked'),
                labelText: $input.next('label').text().substring(0, 100)
            });
        } else if (model === 'CANYON') {
            // For CANYON, get feature from the checkbox value directly
            feature = $input.attr('value') || '';
            
            console.log('CANYON checkbox debug:', {
                id: $input.attr('id'),
                checkboxValue: feature,
                featureLength: feature.length,
                name: $input.attr('name'),
                checked: $input.is(':checked'),
                labelText: $input.next('label').text().substring(0, 100)
            });
        } else {
            // For other models, use the existing logic
            var $div = $input.closest('.gfield_checkbox > div, .gfield-choice-wrapper');
            var $label = $div.find('label, .gfield-choice-label');
            if ($label.length) {
                feature = $label.contents().filter(function() {
                    return this.nodeType === 3; // Text nodes only, excludes .feature-info-icon
                }).text().trim();
            }
            if (!feature) {
                feature = $input.attr('value') || $input.attr('name') || '';
                console.warn('Empty or invalid feature label for checked checkbox in field (ID: ' + config.fieldId + '), using fallback', {
                    checkboxId: $input.attr('id'),
                    value: $input.attr('value'),
                    name: $input.attr('name'),
                    divHtml: $div.html(),
                    labelExists: $label.length > 0,
                    parentClasses: $div.attr('class'),
                    parentHtml: $div.parent().html().substring(0, 500)
                });
            }
        }
        
        if (!feature) {
            return null;
        }
        console.log(`${model} checkbox checked: ${feature}`);
        return feature;
    }).get().filter(function(feature) { return feature !== null; });

    console.log('Selected ' + model + ' features:', selectedFeatures);

    if (selectedFeatures.length === 0) {
        console.log('No ' + model + ' features selected, resetting HTML block');
        if (htmlBlock.length) {
            htmlBlock.find('p').text(defaultText);
        }
        if (trimLevelsButtonBlock.length) {
            trimLevelsButtonBlock.html(defaultButtonText);
            $('#viewTrimLevelsButton').off('click.trimLevels').on('click.trimLevels', function(e) {
                e.preventDefault();
                console.log('View Trim Levels button clicked, no trim levels available');
                alert('No trim levels selected. Please select features to view available trim levels.');
            });
        }
        trimLevelsData[model] = [];
        return;
    }

    fetchCsvWithRetry(config.csvUrl, model, 3, 1000).then(function(csvText) {
        // Special handling for TERRAIN model
        if (model === 'TERRAIN') {
            // Log the full CSV content to debug data issues
            console.log('=== FULL TERRAIN CSV CONTENT ===');
            console.log(csvText);
            console.log('=== END TERRAIN CSV CONTENT ===');
            
            Papa.parse(csvText, {
                skipEmptyLines: true,
                complete: function(results) {
                    console.log(model + ' CSV parsed, rows: ' + results.data.length);
                    console.log('First 10 rows of parsed data:', results.data.slice(0, 10));
                    processTerrainTrimLevels(results.data, selectedFeatures, htmlBlock, trimLevelsButtonBlock, model);
                }
            });
            return;
        }
        
        // Special handling for ACADIA model
        if (model === 'ACADIA') {
            // Log the full CSV content to debug data issues
            console.log('=== FULL ACADIA CSV CONTENT ===');
            console.log(csvText);
            console.log('=== END ACADIA CSV CONTENT ===');
            
            Papa.parse(csvText, {
                skipEmptyLines: true,
                complete: function(results) {
                    console.log(model + ' CSV parsed, rows: ' + results.data.length);
                    console.log('First 10 rows of parsed data:', results.data.slice(0, 10));
                    processAcadiaTrimLevels(results.data, selectedFeatures, htmlBlock, trimLevelsButtonBlock, model);
                }
            });
            return;
        }
        
        // Special handling for YUKON model
        if (model === 'YUKON') {
            // Log the full CSV content to debug data issues
            console.log('=== FULL YUKON CSV CONTENT ===');
            console.log(csvText);
            console.log('=== END YUKON CSV CONTENT ===');
            
            Papa.parse(csvText, {
                skipEmptyLines: true,
                complete: function(results) {
                    console.log(model + ' CSV parsed, rows: ' + results.data.length);
                    console.log('First 10 rows of parsed data:', results.data.slice(0, 10));
                    processYukonTrimLevels(results.data, selectedFeatures, htmlBlock, trimLevelsButtonBlock, model);
                }
            });
            return;
        }
        
        // Special handling for CANYON model
        if (model === 'CANYON') {
            // Log the full CSV content to debug data issues
            console.log('=== FULL CANYON CSV CONTENT ===');
            console.log(csvText);
            console.log('=== END CANYON CSV CONTENT ===');
            
            Papa.parse(csvText, {
                skipEmptyLines: true,
                complete: function(results) {
                    console.log(model + ' CSV parsed, rows: ' + results.data.length);
                    console.log('First 10 rows of parsed data:', results.data.slice(0, 10));
                    processCanyonTrimLevels(results.data, selectedFeatures, htmlBlock, trimLevelsButtonBlock, model);
                }
            });
            return;
        }
        
        // Standard handling for other models
        Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                console.log(model + ' CSV parsed, rows: ' + results.data.length);
                if (results.data.length === 0 || !results.meta.fields.includes('TRIM LEVELS')) {
                    console.error(`${model} CSV parsed with 0 rows or missing TRIM LEVELS column`, {
                        headers: results.meta.fields || [],
                        firstRow: results.data[0] || 'None',
                        rawContent: csvText.substring(0, 500)
                    });
                    if (htmlBlock.length) {
                        htmlBlock.find('p').text(noMatchText);
                    }
                    if (trimLevelsButtonBlock.length) {
                        trimLevelsButtonBlock.html(defaultButtonText);
                        $('#viewTrimLevelsButton').off('click.trimLevels').on('click.trimLevels', function(e) {
                            e.preventDefault();
                            console.log('View Trim Levels button clicked, no trim levels available');
                            alert('No matching trim levels found. Please adjust selected features.');
                        });
                    }
                    trimLevelsData[model] = [];
                    if (model === 'SELTOS' || model === 'TERRAIN') {
                        console.warn(`${model} CSV empty or malformed, raw content (up to 500 chars): ` + csvText.substring(0, 500));
                        alert('Error: ' + model + ' configuration data is empty or malformed. Please verify the CSV file at ' + config.csvUrl + ' or contact support.');
                    }
                    return;
                }

                var trimLevels = [];
                var categories = config.isGmc ? ['EXTERIOR', 'INTERIOR', 'MECHANICAL', 'SAFETY', 'PACKAGES'] : null;
                var featureGroups = {};

                if (config.isGmc) {
                    // Parse GMC Terrain CSV with categorized features
                    var currentCategory = null;
                    var categoryFeatures = [];
                    var trimRows = [];
                    results.data.forEach(function(row) {
                        var firstColumn = Object.keys(row)[0];
                        if (firstColumn.startsWith('TRIM LEVELS FOR')) {
                            if (currentCategory && categoryFeatures.length > 0) {
                                featureGroups[currentCategory] = { features: categoryFeatures, rows: trimRows };
                            }
                            currentCategory = firstColumn.match(/TRIM LEVELS FOR \{(.+)\}/)[1];
                            categoryFeatures = Object.keys(row).slice(1).filter(function(key) { return row[key] && key !== '' && !key.startsWith(','); });
                            trimRows = [];
                            console.log('Detected category: ' + currentCategory + ', features: ', categoryFeatures);
                        } else if (currentCategory && row['TRIM LEVELS']) {
                            trimRows.push(row);
                        }
                    });
                    if (currentCategory && categoryFeatures.length > 0) {
                        featureGroups[currentCategory] = { features: categoryFeatures, rows: trimRows };
                    }
                    console.log('Feature groups for ' + model + ': ', featureGroups);

                    // Match selected features to trim levels across categories
                    var trimLevelSet = new Set(['ELEVATION', 'AT4', 'DENALI']);
                    selectedFeatures.forEach(function(feature) {
                        var matchedTrims = new Set();
                        categories.forEach(function(category) {
                            var group = featureGroups[category];
                            if (!group) return;
                            var matchedFeature = group.features.find(function(f) {
                                return fuzzyMatch(f, feature, model, feature);
                            });
                            if (matchedFeature) {
                                group.rows.forEach(function(row) {
                                    var trimLevel = row['TRIM LEVELS'] ? row['TRIM LEVELS'].trim().toUpperCase() : '';
                                    if (trimLevel && row[matchedFeature] && row[matchedFeature].trim().toUpperCase() === 'YES') {
                                        matchedTrims.add(trimLevel);
                                    }
                                });
                            }
                        });
                        if (matchedTrims.size > 0) {
                            trimLevelSet = new Set([...trimLevelSet].filter(function(trim) { return matchedTrims.has(trim); }));
                        }
                    });
                    trimLevels = [...trimLevelSet];
                    console.log('Matched trim levels for ' + model + ': ', trimLevels);
                } else {
                    // Original Kia model processing
                    results.data.forEach(function(row) {
                        var trimLevel = row['TRIM LEVELS'] ? row['TRIM LEVELS'].trim() : '';
                        if (!trimLevel) {
                            console.warn('Skipping row with empty TRIM LEVELS:', row);
                            return;
                        }
                        var featureMatches = {};
                        var hasAllFeatures = selectedFeatures.every(function(feature) {
                            var normalizedFeature = feature.trim().toUpperCase();
                            var matchedKey = Object.keys(row).find(function(key) {
                                return model === 'K4' ? key.toUpperCase() === normalizedFeature : fuzzyMatch(key, feature, model, feature);
                            });
                            var hasFeature = matchedKey && row[matchedKey] && row[matchedKey].trim().toUpperCase() === 'YES';
                            featureMatches[feature] = {
                                matchedKey: matchedKey || 'None',
                                value: matchedKey ? row[matchedKey] ? row[matchedKey].trim() : 'N/A' : 'N/A',
                                matches: hasFeature
                            };
                            return hasFeature;
                        });

                        console.log(model + ' trim ' + trimLevel + ' check:', {
                            hasAllFeatures: hasAllFeatures,
                            featureMatches: featureMatches,
                            rowData: row
                        });

                        if (hasAllFeatures) {
                            trimLevels.push(trimLevel);
                        }
                    });
                }

                console.log('Matching trim levels for ' + model + ':', trimLevels);
                trimLevelsData[model] = trimLevels;

                if (trimLevels.length > 0) {
                    var trimText = trimLevels.length > 2
                        ? trimLevels.slice(0, -1).join(', ') + ', and ' + trimLevels[trimLevels.length - 1]
                        : trimLevels.join(' and ');
                    var updatedText = defaultText.replace('{TRIM LEVELS}', trimText);
                    if (htmlBlock.length) {
                        htmlBlock.find('p').text(updatedText);
                        console.log('HTML block (ID: 69) updated for ' + model + ' with: ' + updatedText);
                    } else {
                        console.warn('HTML block (ID: ' + htmlBlockFieldId + ') not found');
                    }
                    if (trimLevelsButtonBlock.length) {
                        trimLevelsButtonBlock.html(defaultButtonText);
                        $('#viewTrimLevelsButton').off('click.trimLevels').on('click.trimLevels', function(e) {
                            e.preventDefault();
                            console.log('View Trim Levels button clicked for ' + model);
                            console.log('Trim levels being passed:', trimLevels);
                            console.log('Model filter being passed:', model);
                            
                            // Ensure trimLevels is defined and is an array
                            var safeTrimLevels = Array.isArray(trimLevels) ? trimLevels : [];
                            if (safeTrimLevels.length === 0) {
                                console.warn('No trim levels available for ' + model);
                                alert('No trim levels available for ' + model + '. Please select some features first.');
                                return;
                            }
                            
                            showTrimLevelsPopup(model, safeTrimLevels, model);
                        });
                        console.log('View Trim Levels button initialized for ' + model);
                    } else {
                        console.warn('Trim Levels button block (ID: ' + trimLevelsButtonFieldId + ') not found');
                    }
                } else {
                    console.log('No matching trim levels found for ' + model + ', setting no-match message');
                    if (htmlBlock.length) {
                        htmlBlock.find('p').text(noMatchText);
                    }
                    if (trimLevelsButtonBlock.length) {
                        trimLevelsButtonBlock.html(defaultButtonText);
                        $('#viewTrimLevelsButton').off('click.trimLevels').on('click.trimLevels', function(e) {
                            e.preventDefault();
                            console.log('View Trim Levels button clicked, no trim levels available');
                            alert('No matching trim levels found. Please adjust selected features.');
                        });
                    }
                    trimLevelsData[model] = [];
                }
            },
            error: function(error) {
                console.error('Papa Parse error for ' + model + ' CSV: ' + error);
                if (htmlBlock.length) {
                    htmlBlock.find('p').text(noMatchText);
                }
                if (trimLevelsButtonBlock.length) {
                    trimLevelsButtonBlock.html(defaultButtonText);
                    $('#viewTrimLevelsButton').off('click.trimLevels').on('click.trimLevels', function(e) {
                        e.preventDefault();
                        console.log('View Trim Levels button clicked, no trim levels available');
                        alert('Error loading trim levels. Please try again or contact support.');
                    });
                }
                trimLevelsData[model] = [];
                if (model === 'K5' || model === 'SELTOS' || model === 'TERRAIN') {
                    alert('Error: Failed to parse ' + model + ' configuration data. Please contact support.');
                }
            }
        });
    }).catch(function(error) {
        console.error('Fetch error for ' + model + ': ' + error.message);
        if (htmlBlock.length) {
            htmlBlock.find('p').text(noMatchText);
        }
        if (trimLevelsButtonBlock.length) {
            trimLevelsButtonBlock.html(defaultButtonText);
            $('#viewTrimLevelsButton').off('click.trimLevels').on('click.trimLevels', function(e) {
                e.preventDefault();
                console.log('View Trim Levels button clicked, no trim levels available');
                alert('Error loading trim levels. Please try again or contact support.');
            });
        }
        trimLevelsData[model] = [];
        if (model === 'K5' || model === 'SELTOS' || model === 'TERRAIN') {
            alert('Error: Unable to load ' + model + ' configuration data. Please check the CSV file at ' + config.csvUrl + ' or contact support.');
        }
    });
}

function debugDropdownStyles(fieldId, dropdownId) {
    var dropdown = $('#input_' + formId + '_' + dropdownId);
    if (dropdown.length && dropdown.is('select')) {
        var selectedOption = dropdown.find('option:selected');
        var computedStyle = window.getComputedStyle(dropdown[0]);
        console.log('Dropdown ' + fieldId + ' styles:', {
            color: computedStyle.color,
            background: computedStyle.background,
            selectedText: selectedOption.text(),
            selectedColor: selectedOption.length ? window.getComputedStyle(selectedOption[0]).color : 'N/A',
            selectedBackground: selectedOption.length ? window.getComputedStyle(selectedOption[0]).background : 'N/A'
        });
    } else {
        console.warn('Dropdown ' + fieldId + ' not found or not a select element', {
            exists: dropdown.length > 0,
            tag: dropdown.length ? dropdown[0].tagName : 'Not found'
        });
    }
}

function updateSelectedName() {
    var managerName = ($('#input_' + formId + '_' + managerFieldId).val() || '').trim();
    var salespersonName = ($('#input_' + formId + '_' + salespersonFieldId).val() || '').trim();
    var bdcRepName = ($('#input_' + formId + '_' + bdcRepFieldId).val() || '').trim();
    var gmcManagerName = ($('#input_' + formId + '_' + gmcManagerFieldId).val() || '').trim();
    var gmcSalespersonName = ($('#input_' + formId + '_' + gmcSalespersonFieldId).val() || '').trim();
    var gmcBdcRepName = ($('#input_' + formId + '_' + gmcBdcRepFieldId).val() || '').trim();

    var selectedName = '';
    if (managerName && managerName !== 'Select Manager') {
        selectedName = managerName;
    } else if (gmcManagerName && gmcManagerName !== 'Select Manager') {
        selectedName = gmcManagerName;
    } else if (salespersonName && salespersonName !== 'Select Salesperson') {
        selectedName = salespersonName;
    } else if (gmcSalespersonName && gmcSalespersonName !== 'Select Salesperson') {
        selectedName = gmcSalespersonName;
    } else if (bdcRepName && bdcRepName !== 'Select BDC Rep') {
        selectedName = bdcRepName;
    } else if (gmcBdcRepName && gmcBdcRepName !== 'Select BDC Rep') {
        selectedName = gmcBdcRepName;
    }

    $('#input_' + formId + '_' + hiddenFieldId).val(selectedName || 'BDC Agent');
    console.log('Hidden field updated:', {
        selectedName: selectedName || 'BDC Agent',
        managerName: managerName,
        salespersonName: salespersonName,
        bdcRepName: bdcRepName,
        gmcManagerName: gmcManagerName,
        gmcSalespersonName: gmcSalespersonName,
        gmcBdcRepName: gmcBdcRepName
    });

    var radioLabel = 'It sounds like you\'re looking for availability, pricing, and programs‚Äîis that right? Perfect, you have the right person and I can help you with that. My name is ' + (selectedName || 'BDC Agent') + '. In order to be efficient with your time, would it be okay if I asked you some questions and take some notes?';
    $('#field_' + formId + '_' + radioFieldId + ' .gfield_label').text(radioLabel);
    console.log('Radio button label updated: ' + radioLabel);

    debugDropdownStyles('Manager', managerFieldId);
    debugDropdownStyles('Salesperson', salespersonFieldId);
    debugDropdownStyles('BDC Rep', bdcRepFieldId);
    debugDropdownStyles('GMC Manager', gmcManagerFieldId);
    debugDropdownStyles('GMC Salesperson', gmcSalespersonFieldId);
    debugDropdownStyles('GMC BDC Rep', gmcBdcRepFieldId);
}

function initFormBindings() {
    var stockInput = $('#input_' + formId + '_' + stockFieldId);
    var stockKiaInput = $('#input_' + formId + '_' + stockKiaFieldId);

    if (stockInput.length) {
        stockInput.off('input.lookupStockNumber').on('input.lookupStockNumber', function() {
            debounce(lookupStockNumber, 300)(stockFieldId);
        });
        console.log('Initialized stock number input binding (ID: ' + stockFieldId + ')');
    } else {
        console.warn('Stock number input not found: #input_' + formId + '_' + stockFieldId);
    }

    if (stockKiaInput.length) {
        stockKiaInput.off('input.lookupStockNumberKia').on('input.lookupStockNumberKia', function() {
            debounce(lookupStockNumber, 300)(stockKiaFieldId);
        });
        console.log('Initialized Kia stock number input binding (ID: ' + stockKiaFieldId + ')');
    } else {
        console.warn('Kia stock number input not found: #input_' + formId + '_' + stockKiaFieldId);
    }

    var dropdowns = [
        { id: managerFieldId, name: 'Manager' },
        { id: salespersonFieldId, name: 'Salesperson' },
        { id: bdcRepFieldId, name: 'BDC Rep' },
        { id: gmcManagerFieldId, name: 'GMC Manager' },
        { id: gmcSalespersonFieldId, name: 'GMC Salesperson' },
        { id: gmcBdcRepFieldId, name: 'GMC BDC Rep' }
    ];
    dropdowns.forEach(function(d) {
        var dropdown = $('#input_' + formId + '_' + d.id);
        if (dropdown.length && dropdown.is('select')) {
            dropdown.off('change.updateSelectedName').on('change.updateSelectedName', function() {
                console.log(d.name + ' dropdown changed: ' + $(this).val());
                updateSelectedName();
                debugDropdownStyles(d.name, d.id);
                checkCustomerInfo();
            });
            console.log('Initialized ' + d.name + ' dropdown binding');
        } else {
            console.warn(d.name + ' dropdown not found or not a select element: #input_' + formId + '_' + d.id);
        }
    });

    var tradeInQuestionField = $('#field_' + formId + '_' + tradeInQuestionFieldId);
    console.log('Trade-in question field exists: ' + (tradeInQuestionField.length > 0));
    if (tradeInQuestionField.length) {
        $('#field_' + formId + '_' + tradeInQuestionFieldId + ' input[type="radio"]').off('change.tradeInQuestion').on('change.tradeInQuestion', function() {
            var selectedValue = $(this).val();
            console.log('Trade-in question changed, selected: ' + selectedValue);
            if (selectedValue.toLowerCase() === 'has trade-in') {
                var yearDropdown = $('#input_' + formId + '_' + tradeInYearFieldId);
                var makeDropdown = $('#input_' + formId + '_' + tradeInMakeFieldId);
                var modelDropdown = $('#input_' + formId + '_' + tradeInModelFieldId);
                var yearAltDropdown = $('#input_' + formId + '_' + tradeInAltYearFieldId);
                var makeAltDropdown = $('#input_' + formId + '_' + tradeInAltMakeFieldId);
                var modelAltDropdown = $('#input_' + formId + '_' + tradeInAltModelFieldId);
                console.log('Trade-in fields status:', {
                    yearExists: yearDropdown.length > 0,
                    yearIsDropdown: yearDropdown.is('select'),
                    makeExists: makeDropdown.length > 0,
                    makeIsDropdown: makeDropdown.is('select'),
                    modelExists: modelDropdown.length > 0,
                    modelIsDropdown: modelDropdown.is('select'),
                    yearAltExists: yearAltDropdown.length > 0,
                    yearAltIsDropdown: yearAltDropdown.is('select'),
                    makeAltExists: makeAltDropdown.length > 0,
                    makeAltIsDropdown: makeAltDropdown.is('select'),
                    modelAltExists: modelAltDropdown.length > 0,
                    modelAltIsDropdown: modelAltDropdown.is('select'),
                    yearVisible: $('#field_' + formId + '_' + tradeInYearFieldId).is(':visible'),
                    makeVisible: $('#field_' + formId + '_' + tradeInMakeFieldId).is(':visible'),
                    modelVisible: $('#field_' + formId + '_' + tradeInModelFieldId).is(':visible'),
                    yearAltVisible: $('#field_' + formId + '_' + tradeInAltYearFieldId).is(':visible'),
                    makeAltVisible: $('#field_' + formId + '_' + tradeInAltMakeFieldId).is(':visible'),
                    modelAltVisible: $('#field_' + formId + '_' + tradeInAltModelFieldId).is(':visible')
                });
                if (yearDropdown.length && makeDropdown.length && modelDropdown.length &&
                    yearAltDropdown.length && makeAltDropdown.length && modelAltDropdown.length) {
                    loadTradeInYears(false);
                    loadTradeInYears(true);
                    yearDropdown.off('change.tradeInYear').on('change.tradeInYear', function() {
                        serviceData.trade.year = $(this).val();
                        console.log('Trade-in year selected: ' + serviceData.trade.year);
                        debugDropdownStyles('Trade-In Year', tradeInYearFieldId);
                        loadTradeInMakes(false);
                    });
                    makeDropdown.off('change.tradeInMake').on('change.tradeInMake', function() {
                        serviceData.trade.make = $(this).val();
                        console.log('Trade-in make selected: ' + serviceData.trade.make);
                        debugDropdownStyles('Trade-In Make', tradeInMakeFieldId);
                        loadTradeInModels(false);
                    });
                    modelDropdown.off('change.tradeInModel').on('change.tradeInModel', function() {
                        serviceData.trade.model = $(this).val();
                        console.log('Trade-in model selected: ' + serviceData.trade.model);
                        debugDropdownStyles('Trade-In Model', tradeInModelFieldId);
                    });
                    yearAltDropdown.off('change.tradeInAltYear').on('change.tradeInAltYear', function() {
                        serviceData.tradeAlt.year = $(this).val();
                        console.log('Alternate trade-in year selected: ' + serviceData.tradeAlt.year);
                        debugDropdownStyles('Trade-In Alt Year', tradeInAltYearFieldId);
                        loadTradeInMakes(true);
                    });
                    makeAltDropdown.off('change.tradeInAltMake').on('change.tradeInAltMake', function() {
                        serviceData.tradeAlt.make = $(this).val();
                        console.log('Alternate trade-in make selected: ' + serviceData.tradeAlt.make);
                        debugDropdownStyles('Trade-In Alt Make', tradeInAltMakeFieldId);
                        loadTradeInModels(true);
                    });
                    modelAltDropdown.off('change.tradeInAltModel').on('change.tradeInAltModel', function() {
                        serviceData.tradeAlt.model = $(this).val();
                        console.log('Alternate trade-in model selected: ' + serviceData.tradeAlt.model);
                        debugDropdownStyles('Trade-In Alt Model', tradeInAltModelFieldId);
                    });
                    console.log('Initialized trade-in and alternate trade-in dropdown bindings for Has Trade-In');
                } else {
                    console.warn('Trade-in or alternate trade-in fields not found, proceeding without bindings:', {
                        yearTag: yearDropdown.length ? yearDropdown[0].tagName : 'Not found',
                        makeTag: makeDropdown.length ? makeDropdown[0].tagName : 'Not found',
                        modelTag: modelDropdown.length ? modelDropdown[0].tagName : 'Not found',
                        yearAltTag: yearAltDropdown.length ? yearAltDropdown[0].tagName : 'Not found',
                        makeAltTag: makeAltDropdown.length ? makeAltDropdown[0].tagName : 'Not found',
                        modelAltTag: modelAltDropdown.length ? modelAltDropdown[0].tagName : 'Not found'
                    });
                }
            }
        });
    }

    // Comments for Part 2/5
    /*
     * This is the updated Part 2/5, continuing from updated Part 1/5, with GMC Terrain population for Field 129 in 5 columns from CSV when "TERRAIN" selected in Field 107.
     * Adds populateTerrainFeatures to fetch/parse CSV, group features into categories, and render checkboxes in .feature-groups grid, replacing existing ones, with change bindings and info icons.
     * updateTrimLevels unchanged, works with new checkboxes for trim matching.
     * debugDropdownStyles and updateSelectedName unchanged.
     * Starts initFormBindings with stock and dropdown bindings.
     * Preserves original functionality.
     * Syntax verified.
     * Ends with open brace for Part 3/5.
     * Meets line requirement.
     */
	var tradeInYearField = $('#field_' + formId + '_' + tradeInYearFieldId);
        var tradeInAltYearField = $('#field_' + formId + '_' + tradeInAltYearFieldId);
        if (tradeInYearField.length) {
            var observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.attributeName === 'style' && tradeInYearField.is(':visible')) {
                        var yearDropdown = $('#input_' + formId + '_' + tradeInYearFieldId);
                        var makeDropdown = $('#input_' + formId + '_' + tradeInMakeFieldId);
                        var modelDropdown = $('#input_' + formId + '_' + tradeInModelFieldId);
                        console.log('Trade-in year field visible, fields status:', {
                            yearExists: yearDropdown.length > 0,
                            yearIsDropdown: yearDropdown.is('select'),
                            makeExists: makeDropdown.length > 0,
                            makeIsDropdown: makeDropdown.is('select'),
                            modelExists: modelDropdown.length > 0,
                            modelIsDropdown: modelDropdown.is('select')
                        });
                        if (yearDropdown.length && makeDropdown.length && modelDropdown.length) {
                            loadTradeInYears(false);
                            yearDropdown.off('change.tradeInYear').on('change.tradeInYear', function() {
                                serviceData.trade.year = $(this).val();
                                console.log('Trade-in year selected: ' + serviceData.trade.year);
                                debugDropdownStyles('Trade-In Year', tradeInYearFieldId);
                                loadTradeInMakes(false);
                            });
                            makeDropdown.off('change.tradeInMake').on('change.tradeInMake', function() {
                                serviceData.trade.make = $(this).val();
                                console.log('Trade-in make selected: ' + serviceData.trade.make);
                                debugDropdownStyles('Trade-In Make', tradeInMakeFieldId);
                                loadTradeInModels(false);
                            });
                            modelDropdown.off('change.tradeInModel').on('change.tradeInModel', function() {
                                serviceData.trade.model = $(this).val();
                                console.log('Trade-in model selected: ' + serviceData.trade.model);
                                debugDropdownStyles('Trade-In Model', tradeInModelFieldId);
                            });
                            console.log('Trade-in dropdowns became visible, bindings initialized');
                        } else {
                            console.warn('Trade-in fields (Year, Make, or Model) not found:', {
                                yearTag: yearDropdown.length ? yearDropdown[0].tagName : 'Not found',
                                makeTag: makeDropdown.length ? makeDropdown[0].tagName : 'Not found',
                                modelTag: modelDropdown.length ? modelDropdown[0].tagName : 'Not found'
                            });
                        }
                    }
                });
            });
            observer.observe(tradeInYearField[0], { attributes: true });
        } else {
            console.warn('Trade-in year field not found for MutationObserver');
        }

        if (tradeInAltYearField.length) {
            var observerAlt = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.attributeName === 'style' && tradeInAltYearField.is(':visible')) {
                        var yearAltDropdown = $('#input_' + formId + '_' + tradeInAltYearFieldId);
                        var makeAltDropdown = $('#input_' + formId + '_' + tradeInAltMakeFieldId);
                        var modelAltDropdown = $('#input_' + formId + '_' + tradeInAltModelFieldId);
                        console.log('Alternate trade-in year field visible, fields status:', {
                            yearAltExists: yearAltDropdown.length > 0,
                            yearAltIsDropdown: yearAltDropdown.is('select'),
                            makeAltExists: makeAltDropdown.length > 0,
                            makeAltIsDropdown: makeAltDropdown.is('select'),
                            modelAltExists: modelAltDropdown.length > 0,
                            modelAltIsDropdown: modelAltDropdown.is('select')
                        });
                        if (yearAltDropdown.length && makeAltDropdown.length && modelAltDropdown.length) {
                            loadTradeInYears(true);
                            yearAltDropdown.off('change.tradeInAltYear').on('change.tradeInAltYear', function() {
                                serviceData.tradeAlt.year = $(this).val();
                                console.log('Alternate trade-in year selected: ' + serviceData.tradeAlt.year);
                                debugDropdownStyles('Trade-In Alt Year', tradeInAltYearFieldId);
                                loadTradeInMakes(true);
                            });
                            makeAltDropdown.off('change.tradeInAltMake').on('change.tradeInAltMake', function() {
                                serviceData.tradeAlt.make = $(this).val();
                                console.log('Alternate trade-in make selected: ' + serviceData.tradeAlt.make);
                                debugDropdownStyles('Trade-In Alt Make', tradeInAltMakeFieldId);
                                loadTradeInModels(true);
                            });
                            modelAltDropdown.off('change.tradeInAltModel').on('change.tradeInAltModel', function() {
                                serviceData.tradeAlt.model = $(this).val();
                                console.log('Alternate trade-in model selected: ' + serviceData.tradeAlt.model);
                                debugDropdownStyles('Trade-In Alt Model', tradeInAltModelFieldId);
                            });
                            console.log('Alternate trade-in dropdowns became visible, bindings initialized');
                        } else {
                            console.warn('Alternate trade-in fields (Year, Make, or Model) not found:', {
                                yearAltTag: yearAltDropdown.length ? yearAltDropdown[0].tagName : 'Not found',
                                makeAltTag: makeAltDropdown.length ? makeAltDropdown[0].tagName : 'Not found',
                                modelAltTag: modelAltDropdown.length ? modelAltDropdown[0].tagName : 'Not found'
                            });
                        }
                    }
                });
            });
            observerAlt.observe(tradeInAltYearField[0], { attributes: true });
        } else {
            console.warn('Alternate trade-in year field not found for MutationObserver');
        }

        var htmlField2 = $('#gform_fields_' + formId + '_' + buttonContainerFieldId2);
        var htmlContent2 = $('#pushToDriveCentricContainer2');
        console.log('HTML block (ID: 127) debug:', {
            fieldExists: htmlField2.length > 0,
            fieldVisible: htmlField2.is(':visible'),
            containerExists: htmlContent2.length > 0,
            containerVisible: htmlContent2.is(':visible'),
            fieldStyles: htmlField2.length ? window.getComputedStyle(htmlField2[0]) : 'Not found',
            containerStyles: htmlContent2.length ? window.getComputedStyle(htmlContent2[0]) : 'Not found',
            containerHtml: htmlContent2.length ? htmlContent2.html() : 'Not found'
        });

        if (htmlField2.length) {
            var observer2 = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.attributeName === 'style' && htmlField2.is(':visible')) {
                        console.log('HTML block (ID: 127) became visible, checking customer info');
                        console.log('HTML block container content:', htmlContent2.length ? htmlContent2.html() : 'Not found');
                        checkCustomerInfo();
                    }
                });
            });
            observer2.observe(htmlField2[0], { attributes: true });
            console.log('Initialized MutationObserver for HTML block (ID: 127)');
        } else {
            console.warn('HTML block (ID: 127) not found for MutationObserver');
        }

        function initCustomerInfoBindings() {
            var nameSubfieldFirst = $('#input_' + formId + '_' + nameFieldId + '_3');
            var nameSubfieldLast = $('#input_' + formId + '_' + nameFieldId + '_6');
            var phoneInput = $('#input_' + formId + '_' + phoneFieldId);
            var emailInput = $('#input_' + formId + '_' + emailFieldId);
            var appointmentInput = $('#input_' + formId + '_' + appointmentConfirmationFieldId);
            var dateInput = $('#input_' + formId + '_' + dateFieldId);
            var timePeriodField = $('#field_' + formId + '_' + timePeriodFieldId);
            var customerCommentInput = $('#input_' + formId + '_' + customerCommentFieldId);
            var nameSubfieldFirst2 = $('#input_' + formId + '_' + nameFieldId2 + '_3');
            var nameSubfieldLast2 = $('#input_' + formId + '_' + nameFieldId2 + '_6');
            var phoneInput2 = $('#input_' + formId + '_' + phoneFieldId2);
            var emailInput2 = $('#input_' + formId + '_' + emailFieldId2);
            var gmcModelInput = $('#input_' + formId + '_' + gmcModelFieldId);

            console.log('Customer info fields detection:', {
                nameSubfieldFirstExists: nameSubfieldFirst.length > 0,
                nameSubfieldLastExists: nameSubfieldLast.length > 0,
                phoneFieldExists: phoneInput.length > 0,
                emailFieldExists: emailInput.length > 0,
                appointmentFieldExists: appointmentInput.length > 0,
                dateFieldExists: dateInput.length > 0,
                timePeriodFieldExists: timePeriodField.length > 0,
                customerCommentExists: customerCommentInput.length > 0,
                nameSubfieldFirst2Exists: nameSubfieldFirst2.length > 0,
                nameSubfieldLast2Exists: nameSubfieldLast2.length > 0,
                phoneField2Exists: phoneInput2.length > 0,
                emailField2Exists: emailInput2.length > 0,
                gmcModelExists: gmcModelInput.length > 0,
                nameSubfieldFirstSelector: '#input_' + formId + '_' + nameFieldId + '_3',
                nameSubfieldLastSelector: '#input_' + formId + '_' + nameFieldId + '_6',
                phoneFieldSelector: '#input_' + formId + '_' + phoneFieldId,
                emailFieldSelector: '#input_' + formId + '_' + emailFieldId,
                appointmentFieldSelector: '#input_' + formId + '_' + appointmentConfirmationFieldId,
                dateFieldSelector: '#input_' + formId + '_' + dateFieldId,
                timePeriodFieldSelector: '#field_' + formId + '_' + timePeriodFieldId,
                customerCommentSelector: '#input_' + formId + '_' + customerCommentFieldId,
                nameSubfieldFirst2Selector: '#input_' + formId + '_' + nameFieldId2 + '_3',
                nameSubfieldLast2Selector: '#input_' + formId + '_' + nameFieldId2 + '_6',
                phoneField2Selector: '#input_' + formId + '_' + phoneFieldId2,
                emailField2Selector: '#input_' + formId + '_' + emailFieldId2,
                gmcModelSelector: '#input_' + formId + '_' + gmcModelFieldId
            });

            var inputs = [];
            if (nameSubfieldFirst.length) inputs.push(nameSubfieldFirst);
            if (nameSubfieldLast.length) inputs.push(nameSubfieldLast);
            if (phoneInput.length) inputs.push(phoneInput);
            if (emailInput.length) inputs.push(emailInput);
            if (appointmentInput.length) inputs.push(appointmentInput);
            if (dateInput.length) inputs.push(dateInput);
            if (timePeriodField.length) {
                timePeriodField.find('input[type="radio"]').each(function() {
                    inputs.push($(this));
                });
            }
            if (customerCommentInput.length) inputs.push(customerCommentInput);
            if (nameSubfieldFirst2.length) inputs.push(nameSubfieldFirst2);
            if (nameSubfieldLast2.length) inputs.push(nameSubfieldLast2);
            if (phoneInput2.length) inputs.push(phoneInput2);
            if (emailInput2.length) inputs.push(emailInput2);
            if (gmcModelInput.length) inputs.push(gmcModelInput);

            if (inputs.length >= 6) {
                inputs.forEach(function(input) {
                    input.off('input.checkCustomerInfo change.checkCustomerInfo keyup.checkCustomerInfo').on('input.checkCustomerInfo change.checkCustomerInfo keyup.checkCustomerInfo', function(e) {
                        console.log(`[${new Date().toISOString()}] Input changed: ${input.attr('id')} = ${input.val()}`);
                        if (input.attr('id') === 'input_' + formId + '_' + appointmentConfirmationFieldId) {
                            console.log('Field 57 input event:', {
                                value: input.val(),
                                readonly: input.prop('readonly'),
                                disabled: input.prop('disabled'),
                                styles: window.getComputedStyle(input[0]),
                                events: $._data(input[0], 'events')
                            });
                        }
                        input.attr('data-last-value', input.val());
                        input.attr('data-last-checked', new Date().toISOString());
                        if (input.attr('id') !== 'input_' + formId + '_' + appointmentConfirmationFieldId) {
                            debounceCheckCustomerInfo();
                                                    if (input.attr('id') === 'input_' + formId + '_' + dateFieldId || input.is('input[type="radio"]') || input.attr('id') === 'input_' + formId + '_' + gmcModelFieldId) {
                            updateAppointmentConfirmationField();
                            // Check for GMC model selection (radio buttons)
                            if (input.is('input[type="radio"]') && input.attr('id') && input.attr('id').indexOf('choice_' + formId + '_' + gmcModelFieldId) !== -1) {
                                console.log('üéØ GMC model radio button detected:', {
                                    id: input.attr('id'),
                                    value: input.val(),
                                    checked: input.is(':checked'),
                                    name: input.attr('name')
                                });
                                if (input.val() === 'TERRAIN' && input.is(':checked')) {
                                    console.log('üöó TERRAIN selected via radio button - calling populateTerrainFeatures');
                                    console.log('Current time:', new Date().toISOString());
                                    console.log('terrainPopulated before call:', terrainPopulated);
                                    populateTerrainFeatures();
                                    console.log('terrainPopulated after call:', terrainPopulated);
                                    updateTrimLevels('TERRAIN');
                                } else if (input.val() === 'YUKON' && input.is(':checked')) {
                                    console.log('üöó YUKON selected via radio button - calling populateYukonFeatures');
                                    console.log('Current time:', new Date().toISOString());
                                    console.log('yukonPopulated before call:', yukonPopulated);
                                    populateYukonFeatures();
                                    console.log('yukonPopulated after call:', yukonPopulated);
                                    updateTrimLevels('YUKON');
                                } else if (input.val() === 'CANYON' && input.is(':checked')) {
                                    console.log('üöó CANYON selected via radio button - calling populateCanyonFeatures');
                                    console.log('Current time:', new Date().toISOString());
                                    console.log('canyonPopulated before call:', canyonPopulated);
                                    populateCanyonFeatures();
                                    console.log('canyonPopulated after call:', canyonPopulated);
                                    updateTrimLevels('CANYON');
                                } else if (input.is(':checked')) {
                                    console.log('Non-TERRAIN/YUKON/CANYON GMC model selected: ' + input.val());
                                    terrainPopulated = false;
                                    yukonPopulated = false;
                                    canyonPopulated = false;
                                }
                            }
                        }
                        }
                    });
                    console.log('Events on #' + input.attr('id') + ':', $._data(input[0], 'events'));
                });
                console.log('Initialized customer info input bindings with ' + inputs.length + ' inputs, including Field 57, 52, 53, 113, 117, 118, 119, and 107');
            } else {
                console.warn('Customer info fields not found:', {
                    nameSubfieldFirst: nameSubfieldFirst.length > 0,
                    nameSubfieldLast: nameSubfieldLast.length > 0,
                    phone: phoneInput.length > 0,
                    email: emailInput.length > 0,
                    appointment: appointmentInput.length > 0,
                    date: dateInput.length > 0,
                    timePeriod: timePeriodField.length > 0,
                    customerComment: customerCommentInput.length > 0,
                    nameSubfieldFirst2: nameSubfieldFirst2.length > 0,
                    nameSubfieldLast2: nameSubfieldLast2.length > 0,
                    phone2: phoneInput2.length > 0,
                    email2: emailInput2.length > 0,
                    gmcModel: gmcModelInput.length > 0
                });
            }

            $('#gform_' + formId).off('input.delegateCustomerInfo change.delegateCustomerInfo keyup.delegateCustomerInfo').on('input.delegateCustomerInfo change.delegateCustomerInfo keyup.delegateCustomerInfo', 'input[type="text"], input[type="tel"], input[type="email"], input[type="radio"], textarea, select', function() {
                console.log(`[${new Date().toISOString()}] Delegated input changed: ${$(this).attr('id')} = ${$(this).val()}`);
                $(this).attr('data-last-value', $(this).val());
                $(this).attr('data-last-checked', new Date().toISOString());
                if ($(this).attr('id') !== 'input_' + formId + '_' + appointmentConfirmationFieldId) {
                    debounceCheckCustomerInfo();
                                    if ($(this).attr('id') === 'input_' + formId + '_' + dateFieldId || $(this).is('input[type="radio"]') || $(this).attr('id') === 'input_' + formId + '_' + gmcModelFieldId) {
                    updateAppointmentConfirmationField();
                                         // Check for GMC model selection (radio buttons)
                     if ($(this).is('input[type="radio"]') && $(this).attr('id') && $(this).attr('id').indexOf('choice_' + formId + '_' + gmcModelFieldId) !== -1) {
                         console.log('üéØ GMC model radio button detected (delegated):', {
                             id: $(this).attr('id'),
                             value: $(this).val(),
                             checked: $(this).is(':checked'),
                             name: $(this).attr('name')
                         });
                         if ($(this).val() === 'TERRAIN' && $(this).is(':checked')) {
                             console.log('üöó TERRAIN selected via delegated radio button - calling populateTerrainFeatures');
                             console.log('Current time:', new Date().toISOString());
                             console.log('terrainPopulated before call:', terrainPopulated);
                             populateTerrainFeatures();
                             console.log('terrainPopulated after call:', terrainPopulated);
                             updateTrimLevels('TERRAIN');
                         } else if ($(this).val() === 'ACADIA' && $(this).is(':checked')) {
                             console.log('üöó ACADIA selected via delegated radio button - calling populateAcadiaFeatures');
                             console.log('Current time:', new Date().toISOString());
                             console.log('acadiaPopulated before call:', acadiaPopulated);
                             console.log('üîç DEBUG: ACADIA value match:', $(this).val() === 'ACADIA');
                             console.log('üîç DEBUG: ACADIA is checked:', $(this).is(':checked'));
                             console.log('üîç DEBUG: Radio button value:', $(this).val());
                             populateAcadiaFeatures();
                             console.log('acadiaPopulated after call:', acadiaPopulated);
                             updateTrimLevels('ACADIA');
                         } else if ($(this).val() === 'YUKON' && $(this).is(':checked')) {
                             console.log('üöó YUKON selected via delegated radio button - calling populateYukonFeatures');
                             console.log('Current time:', new Date().toISOString());
                             console.log('yukonPopulated before call:', yukonPopulated);
                             populateYukonFeatures();
                             console.log('yukonPopulated after call:', yukonPopulated);
                             updateTrimLevels('YUKON');
                         } else if ($(this).val() === 'CANYON' && $(this).is(':checked')) {
                             console.log('üöó CANYON selected via delegated radio button - calling populateCanyonFeatures');
                             console.log('Current time:', new Date().toISOString());
                             console.log('canyonPopulated before call:', canyonPopulated);
                             populateCanyonFeatures();
                             console.log('canyonPopulated after call:', canyonPopulated);
                             updateTrimLevels('CANYON');
                         } else if ($(this).is(':checked')) {
                             console.log('Non-TERRAIN/ACADIA/YUKON/CANYON GMC model selected via delegated: ' + $(this).val());
                             terrainPopulated = false;
                             acadiaPopulated = false;
                             yukonPopulated = false;
                             canyonPopulated = false;
                         }
                     }
                }
                }
            });

            var htmlField = $('#gform_fields_' + formId + '_' + buttonContainerFieldId);
            var htmlContent = $('#pushToDriveCentricContainer');
            console.log('HTML block (ID: 49) debug:', {
                fieldExists: htmlField.length > 0,
                fieldVisible: htmlField.is(':visible'),
                containerExists: htmlContent.length > 0,
                containerVisible: htmlContent.is(':visible'),
                fieldStyles: htmlField.length ? window.getComputedStyle(htmlField[0]) : 'Not found',
                containerStyles: htmlContent.length ? window.getComputedStyle(htmlContent[0]) : 'Not found',
                containerHtml: htmlContent.length ? htmlContent.html() : 'Not found'
            });

            if (htmlField.length) {
                var observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'style' && htmlField.is(':visible')) {
                            console.log('HTML block (ID: 49) became visible, checking customer info');
                            console.log('HTML block container content:', htmlContent.length ? htmlContent.html() : 'Not found');
                            checkCustomerInfo();
                        }
                    });
                });
                observer.observe(htmlField[0], { attributes: true });
                console.log('Initialized MutationObserver for HTML block (ID: 49)');
            } else {
                console.warn('HTML block (ID: 49) not found for MutationObserver');
            }

            var generateNoteContainer = $('#generatenote');
            console.log('Generate Note container debug:', {
                containerExists: generateNoteContainer.length > 0,
                containerVisible: generateNoteContainer.is(':visible'),
                containerHtml: generateNoteContainer.length ? generateNoteContainer.html() : 'Not found',
                containerStyles: generateNoteContainer.length ? window.getComputedStyle(generateNoteContainer[0]) : 'Not found'
            });

            if (generateNoteContainer.length) {
                generateNoteContainer.html('<button id="generateNoteButton">Generate Note</button>');
                $('#generateNoteButton').off('click.generateNote').on('click.generateNote', function(e) {
                    e.preventDefault();
                    console.log('Generate Note button clicked');
                    generateNotePopup();
                });
                console.log('Generate Note button initialized in #generatenote');
            } else {
                console.warn('Generate Note container (#generatenote) not found, attempting field-based initialization');
                var generateNoteField = $('#field_' + formId + '_' + generateNoteFieldId);
                console.log('Generate Note field debug:', {
                    fieldExists: generateNoteField.length > 0,
                    fieldVisible: generateNoteField.is(':visible'),
                    fieldStyles: generateNoteField.length ? window.getComputedStyle(generateNoteField[0]) : 'Not found'
                });
                if (generateNoteField.length && generateNoteField.find('#generatenote').length) {
                    generateNoteField.find('#generatenote').html('<button id="generateNoteButton">Generate Note</button>');
                    $('#generateNoteButton').off('click.generateNote').on('click.generateNote', function(e) {
                        e.preventDefault();
                        console.log('Generate Note button clicked (field-based)');
                        generateNotePopup();
                    });
                    console.log('Generate Note button initialized in Field 60');
                } else {
                    console.error('Generate Note field (ID: 60) or #generatenote not found');
                }
            }

            Object.keys(modelConfigs).forEach(function(model) {
                var config = modelConfigs[model];
                var checkboxField = $('#field_' + formId + '_' + config.fieldId);
                var checkboxInputs = checkboxField.find('input[type="checkbox"]');
                console.log(model + ' checkbox field debug:', {
                    fieldExists: checkboxField.length > 0,
                    fieldVisible: checkboxField.is(':visible'),
                    checkboxCount: checkboxInputs.length,
                    checkboxSelector: '#field_' + formId + '_' + config.fieldId,
                    checkboxes: checkboxInputs.map(function() { return $(this).attr('id'); }).get()
                });
                if (checkboxInputs.length) {
                    checkboxInputs.off('change.' + model + 'Features').on('change.' + model + 'Features', function() {
                        console.log(model + ' checkbox changed, updating trim levels');
                        updateTrimLevels(model);
                    });
                    console.log('Initialized ' + model + ' checkbox bindings');
                    if (model === 'K5' || model === 'TERRAIN' || model === 'YUKON') {
                        console.log(model + '-specific binding check:', {
                            fieldId: config.fieldId,
                            checkboxIds: checkboxInputs.map(function() { return $(this).attr('id'); }).get(),
                            eventHandlers: $._data(checkboxInputs[0], 'events')
                        });
                    }
                } else {
                    console.warn(model + ' checkbox inputs not found for Field ID: ' + config.fieldId);
                    if (model === 'K5' || model === 'TERRAIN' || model === 'YUKON') {
                        console.error(model + ' checkbox inputs missing, form structure:', {
                            formFields: $('#gform_fields_' + formId).find('.gfield').map(function() { return $(this).attr('id'); }).get()
                        });
                    }
                }

                if (checkboxField.length) {
                    var observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.attributeName === 'style' || mutation.attributeName === 'class') {
                                console.log(model + ' checkbox field (ID: ' + config.fieldId + ') visibility changed, isVisible: ' + checkboxField.is(':visible'));
                                if (model === 'TERRAIN' && $('#input_' + formId + '_' + gmcModelFieldId).val() === 'TERRAIN') {
                                    updateTrimLevels(model);
                                } else if (model === 'YUKON' && $('#input_' + formId + '_' + gmcModelFieldId).val() === 'YUKON') {
                                    updateTrimLevels(model);
                                } else if (model !== 'TERRAIN' && model !== 'YUKON') {
                                    updateTrimLevels(model);
                                }
                            }
                        });
                    });
                    observer.observe(checkboxField[0], { attributes: true });
                    console.log('Initialized MutationObserver for ' + model + ' checkbox field (ID: ' + config.fieldId + ')');
                    if (model === 'K5' || model === 'TERRAIN' || model === 'YUKON') {
                        console.log(model + '-specific MutationObserver initialized');
                    }
                } else {
                    console.warn(model + ' checkbox field (ID: ' + config.fieldId + ') not found for MutationObserver');
                    if (model === 'K5' || model === 'TERRAIN' || model === 'YUKON') {
                        console.error(model + ' checkbox field (ID: ' + config.fieldId + ') not found for MutationObserver, form structure:', {
                            formFields: $('#gform_fields_' + formId).find('.gfield').map(function() { return $(this).attr('id'); }).get()
                        });
                    }
                }
            });
        }

        initCustomerInfoBindings();

        // Add specific listener for TERRAIN/YUKON radio buttons
        $(document).on('change', '#field_' + formId + '_' + gmcModelFieldId + ' input[type="radio"]', function() {
            console.log('GMC model radio button changed:', {
                id: $(this).attr('id'),
                value: $(this).val(),
                checked: $(this).is(':checked')
            });
            
            if ($(this).val() === 'TERRAIN' && $(this).is(':checked')) {
                console.log('TERRAIN radio button detected, calling populateTerrainFeatures');
                populateTerrainFeatures();
                updateTrimLevels('TERRAIN');
            } else if ($(this).val() === 'YUKON' && $(this).is(':checked')) {
                console.log('YUKON radio button detected, calling populateYukonFeatures');
                populateYukonFeatures();
                updateTrimLevels('YUKON');
            } else if ($(this).val() === 'CANYON' && $(this).is(':checked')) {
                console.log('CANYON radio button detected, calling populateCanyonFeatures');
                populateCanyonFeatures();
                updateTrimLevels('CANYON');
            } else if ($(this).is(':checked')) {
                console.log('Non-TERRAIN/YUKON/CANYON GMC model selected, resetting terrain, yukon, and canyon');
                terrainPopulated = false;
                yukonPopulated = false;
                canyonPopulated = false;
            }
        });

        $(document).off('gform_post_render').on('gform_post_render', function(event, form_id) {
            if (parseInt(form_id) === parseInt(formId)) {
                initFormBindings();
                updateSelectedName();
                $('#field_' + formId + '_' + textReceiptFieldId).hide();
                $('#field_' + formId + '_' + textReceiptFieldId2).hide();
                setTimeout(function() {
                    checkCustomerInfo();
                    Object.keys(modelConfigs).forEach(function(model) {
                        if (model === 'TERRAIN') {
                            // Check if TERRAIN radio button is selected
                            var terrainRadio = $('#field_' + formId + '_' + gmcModelFieldId + ' input[type="radio"][value="TERRAIN"]');
                            if (terrainRadio.length && terrainRadio.is(':checked')) {
                                console.log('TERRAIN radio button is checked, populating features');
                                populateTerrainFeatures();
                                updateTrimLevels(model);
                            } else {
                                console.log('TERRAIN radio button not checked or not found');
                            }
                        } else if (model === 'YUKON') {
                            // Check if YUKON radio button is selected
                            var yukonRadio = $('#field_' + formId + '_' + gmcModelFieldId + ' input[type="radio"][value="YUKON"]');
                            if (yukonRadio.length && yukonRadio.is(':checked')) {
                                console.log('YUKON radio button is checked, populating features');
                                populateYukonFeatures();
                                updateTrimLevels(model);
                            } else {
                                console.log('YUKON radio button not checked or not found');
                            }
                        } else if (model === 'CANYON') {
                            // Check if CANYON radio button is selected
                            var canyonRadio = $('#field_' + formId + '_' + gmcModelFieldId + ' input[type="radio"][value="CANYON"]');
                            if (canyonRadio.length && canyonRadio.is(':checked')) {
                                console.log('CANYON radio button is checked, populating features');
                                populateCanyonFeatures();
                                updateTrimLevels(model);
                            } else {
                                console.log('CANYON radio button not checked or not found');
                            }
                        } else if (model !== 'TERRAIN' && model !== 'YUKON' && model !== 'CANYON') {
                            updateTrimLevels(model);
                        }
                    });
                    updateAppointmentConfirmationField();
                }, 3000);
                console.log('Rebound inputs and updated selected name after AJAX render for form ' + formId);
            }
        });

        $(document).off('gform_confirmation_loaded').on('gform_confirmation_loaded', function(event, form_id) {
            if (parseInt(form_id) === parseInt(formId)) {
                initFormBindings();
                updateSelectedName();
                $('#field_' + formId + '_' + textReceiptFieldId).hide();
                $('#field_' + formId + '_' + textReceiptFieldId2).hide();
                setTimeout(function() {
                    checkCustomerInfo();
                    Object.keys(modelConfigs).forEach(function(model) {
                        if (model === 'TERRAIN') {
                            // Check if TERRAIN radio button is selected
                            var terrainRadio = $('#field_' + formId + '_' + gmcModelFieldId + ' input[type="radio"][value="TERRAIN"]');
                            if (terrainRadio.length && terrainRadio.is(':checked')) {
                                console.log('TERRAIN radio button is checked, populating features');
                                populateTerrainFeatures();
                                updateTrimLevels(model);
                            } else {
                                console.log('TERRAIN radio button not checked or not found');
                            }
                        } else if (model === 'YUKON') {
                            // Check if YUKON radio button is selected
                            var yukonRadio = $('#field_' + formId + '_' + gmcModelFieldId + ' input[type="radio"][value="YUKON"]');
                            if (yukonRadio.length && yukonRadio.is(':checked')) {
                                console.log('YUKON radio button is checked, populating features');
                                populateYukonFeatures();
                                updateTrimLevels(model);
                            } else {
                                console.log('YUKON radio button not checked or not found');
                            }
                        } else if (model === 'CANYON') {
                            // Check if CANYON radio button is selected
                            var canyonRadio = $('#field_' + formId + '_' + gmcModelFieldId + ' input[type="radio"][value="CANYON"]');
                            if (canyonRadio.length && canyonRadio.is(':checked')) {
                                console.log('CANYON radio button is checked, populating features');
                                populateCanyonFeatures();
                                updateTrimLevels(model);
                            } else {
                                console.log('CANYON radio button not checked or not found');
                            }
                        } else if (model !== 'TERRAIN' && model !== 'YUKON' && model !== 'CANYON') {
                            updateTrimLevels(model);
                        }
                    });
                    updateAppointmentConfirmationField();
                }, 3000);
                console.log('Rebound inputs after confirmation loaded for form ' + formId);
            }
        });
    }

    function debounce(func, wait) {
        var timeout;
        return function() {
            var context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function() {
                func.apply(context, args);
            }, wait);
        };
    }

    var debounceTimeout;
    function debounceCheckCustomerInfo() {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(checkCustomerInfo, 300);
    }

    function checkCustomerInfo() {
        checkCustomerInfoCounter++;
        try {
            var nameSubfieldFirst = $('#input_' + formId + '_' + nameFieldId + '_3');
            var nameSubfieldLast = $('#input_' + formId + '_' + nameFieldId + '_6');
            var nameValue = '';
            if (nameSubfieldFirst.length || nameSubfieldLast.length) {
                var firstName = (nameSubfieldFirst.val() || '').trim();
                var lastName = (nameSubfieldLast.val() || '').trim();
                nameValue = (firstName + ' ' + lastName).trim();
                console.log('Name field (Subfields 44_3, 44_6) raw values: First = ' + firstName + ', Last = ' + lastName);
            }

            var phone = ($('#input_' + formId + '_' + phoneFieldId).val() || '').trim().replace(/\D/g, '');
            var email = ($('#input_' + formId + '_' + emailFieldId).val() || '').trim();
            var emailRegex = /.+@.+\..+/;

            var nameSubfieldFirst2 = $('#input_' + formId + '_' + nameFieldId2 + '_3');
            var nameSubfieldLast2 = $('#input_' + formId + '_' + nameFieldId2 + '_6');
            var nameValue2 = '';
            if (nameSubfieldFirst2.length || nameSubfieldLast2.length) {
                var firstName2 = (nameSubfieldFirst2.val() || '').trim();
                var lastName2 = (nameSubfieldLast2.val() || '').trim();
                nameValue2 = (firstName2 + ' ' + lastName2).trim();
                console.log('Name field (Subfields 117_3, 117_6) raw values: First = ' + firstName2 + ', Last = ' + lastName2);
            }

            var phone2 = ($('#input_' + formId + '_' + phoneFieldId2).val() || '').trim().replace(/\D/g, '');
            var email2 = ($('#input_' + formId + '_' + emailFieldId2).val() || '').trim();

            var manager = $('#input_' + formId + '_' + managerFieldId).val() || '';
            var salesperson = $('#input_' + formId + '_' + salespersonFieldId).val() || '';
            var bdcRep = $('#input_' + formId + '_' + bdcRepFieldId).val() || '';
            var gmcManager = $('#input_' + formId + '_' + gmcManagerFieldId).val() || '';
            var gmcSalesperson = $('#input_' + formId + '_' + gmcSalespersonFieldId).val() || '';
            var gmcBdcRep = $('#input_' + formId + '_' + gmcBdcRepFieldId).val() || '';
            var selectedName = manager || gmcManager || salesperson || gmcSalesperson || bdcRep || gmcBdcRep || '';
            var dealership = $('#field_' + formId + '_' + dealershipFieldId + ' input[type="radio"]:checked').val() || '';
            var buttonContainer = $('#pushToDriveCentricContainer');
            var button = $('#pushToDriveCentricButton');
            var buttonContainer2 = $('#pushToDriveCentricContainer2');
            var button2 = $('#pushToDriveCentricButton2');

            var stockKia = ($('#input_' + formId + '_' + stockKiaFieldId).val() || '').trim();
            var stock = ($('#input_' + formId + '_' + stockFieldId).val() || '').trim();
            var yearFound = ($('#input_' + formId + '_' + yearFoundFieldId).val() || '').trim();
            var makeFound = ($('#input_' + formId + '_' + makeFoundFieldId).val() || '').trim();
            var modelFound = ($('#input_' + formId + '_' + modelFoundFieldId).val() || '').trim();
            var customerComment = ($('#input_' + formId + '_' + customerCommentFieldId).val() || '').trim();
            var hasVehicleData = stockKia || stock || (yearFound && makeFound && modelFound) || customerComment;

            console.table({
                checkCounter: checkCustomerInfoCounter,
                nameValue: nameValue,
                phone: phone,
                email: email,
                emailValid: emailRegex.test(email),
                nameValue2: nameValue2,
                phone2: phone2,
                email2Valid: emailRegex.test(email2),
                selectedName: selectedName,
                dealership: dealership,
                buttonContainerExists: buttonContainer.length > 0,
                buttonContainerVisible: buttonContainer.length ? buttonContainer.is(':visible') : 'Not found',
                buttonExists: button.length > 0,
                buttonContainer2Exists: buttonContainer2.length > 0,
                buttonContainer2Visible: buttonContainer2.length ? buttonContainer2.is(':visible') : 'Not found',
                button2Exists: button2.length > 0,
                stockKia: stockKia,
                stock: stock,
                yearFound: yearFound,
                makeFound: makeFound,
                modelFound: modelFound,
                customerComment: customerComment
            });

            console.log('HTML block (ID: 49) container debug:', {
                containerSelector: '#pushToDriveCentricContainer',
                display: buttonContainer.length ? buttonContainer.css('display') : 'Not found',
                visibility: buttonContainer.length ? buttonContainer.css('visibility') : 'Not found',
                isHidden: buttonContainer.length ? buttonContainer.is(':hidden') : 'Not found',
                content: buttonContainer.length ? buttonContainer.html() : 'Not found'
            });

            console.log('HTML block (ID: 127) container debug:', {
                containerSelector: '#pushToDriveCentricContainer2',
                display: buttonContainer2.length ? buttonContainer2.css('display') : 'Not found',
                visibility: buttonContainer2.length ? buttonContainer2.css('visibility') : 'Not found',
                isHidden: buttonContainer2.length ? buttonContainer2.is(':hidden') : 'Not found',
                content: buttonContainer2.length ? buttonContainer2.html() : 'Not found'
            });

            if (button.length) {
                var computedStyles = window.getComputedStyle(button[0]);
                console.log('Button (ID: pushToDriveCentricButton) computed styles:', {
                    display: computedStyles.display,
                    visibility: computedStyles.visibility,
                    zIndex: computedStyles.zIndex,
                    position: computedStyles.position,
                    width: computedStyles.width,
                    height: computedStyles.height
                });
                button.parents().each(function() {
                    var parent = $(this);
                    var parentStyles = window.getComputedStyle(this);
                    console.log('Parent element (Button 1):', {
                        id: parent.attr('id'),
                        class: parent.attr('class'),
                        display: parentStyles.display,
                        visibility: parentStyles.visibility,
                        zIndex: parentStyles.zIndex
                    });
                });
            }

            if (button2.length) {
                var computedStyles2 = window.getComputedStyle(button2[0]);
                console.log('Button (ID: pushToDriveCentricButton2) computed styles:', {
                    display: computedStyles2.display,
                    visibility: computedStyles2.visibility,
                    zIndex: computedStyles2.zIndex,
                    position: computedStyles2.position,
                    width: computedStyles2.width,
                    height: computedStyles2.height
                });
                button2.parents().each(function() {
                    var parent = $(this);
                    var parentStyles = window.getComputedStyle(this);
                    console.log('Parent element (Button 2):', {
                        id: parent.attr('id'),
                        class: parent.attr('class'),
                        display: parentStyles.display,
                        visibility: parentStyles.visibility,
                        zIndex: parentStyles.zIndex
                    });
                });
            }

            if (nameValue && phone.length >= 10 && email && emailRegex.test(email) && selectedName && dealership && buttonContainer.length && buttonContainer.is(':visible') && hasVehicleData) {
                console.log('All inputs valid for HTML block (ID: 49), inserting button into container');
                if (!button.length) {
                    var buttonHtml = '<button id="pushToDriveCentricButton">Push To DriveCentric</button>';
                    buttonContainer.html(buttonHtml);
                    $('#pushToDriveCentricButton').off('click').on('click', function(e) {
                        e.preventDefault();
                        console.log('Push To DriveCentric button (ID: 49) clicked');
                        pushToDriveCentric('original');
                    });
                    console.log('Push To DriveCentric button created and appended to #pushToDriveCentricContainer');
                }
                console.log('HTML block container (ID: 49) content after button insertion:', buttonContainer.html());

                var htmlField = document.querySelector('#gform_fields_' + formId + '_' + buttonContainerFieldId);
                if (htmlField && !htmlField._hasButtonObserver) {
                    new MutationObserver(function(mutations) {
                        if (!$('#pushToDriveCentricButton').length && buttonContainer.is(':visible')) {
                            console.log('Push To DriveCentric button (ID: 49) removed, re-appending');
                            var newButtonHtml = '<button id="pushToDriveCentricButton">Push To DriveCentric</button>';
                            buttonContainer.html(newButtonHtml);
                            $('#pushToDriveCentricButton').off('click').on('click', function(e) {
                                e.preventDefault();
                                console.log('Push To DriveCentric button (ID: 49) clicked');
                                pushToDriveCentric('original');
                            });
                            console.log('Push To DriveCentric button re-appended to #pushToDriveCentricContainer');
                        }
                    }).observe(htmlField, { childList: true, subtree: true });
                    htmlField._hasButtonObserver = true;
                    console.log('Initialized MutationObserver for button in HTML block (ID: 49)');
                }

                var generateNoteContainer = $('#generatenote');
                if (generateNoteContainer.length && !$('#generateNoteButton').length) {
                    generateNoteContainer.html('<button id="generateNoteButton">Generate Note</button>');
                    $('#generateNoteButton').off('click.generateNote').on('click.generateNote', function(e) {
                        e.preventDefault();
                        console.log('Generate Note button clicked (post-customer-info)');
                        generateNotePopup();
                    });
                    console.log('Generate Note button inserted after customer info validation');
                }
            } else {
                console.log('Inputs invalid or HTML block container (ID: 49) hidden, clearing button', {
                    nameValid: !!nameValue,
                    phoneValid: phone.length >= 10,
                    emailValid: email && emailRegex.test(email),
                    selectedNameValid: !!selectedName,
                    dealershipValid: !!dealership,
                    vehicleDataValid: !!hasVehicleData,
                    containerExists: buttonContainer.length > 0,
                    containerVisible: buttonContainer.length ? buttonContainer.is(':visible') : 'Not found'
                });
                if (button.length) {
                    buttonContainer.html('');
                    console.log('Push To DriveCentric button removed from #pushToDriveCentricContainer due to incomplete or invalid inputs or hidden container');
                }
            }

            if (nameValue2 && phone2.length >= 10 && email2 && emailRegex.test(email2) && selectedName && dealership && buttonContainer2.length && buttonContainer2.is(':visible') && $('#field_' + formId + '_' + phoneFieldId2).is(':visible')) {
                console.log('All inputs valid for HTML block (ID: 127), inserting button into container');
                if (!button2.length) {
                    var buttonHtml2 = '<button id="pushToDriveCentricButton2">Push To DriveCentric</button>';
                    buttonContainer2.html(buttonHtml2);
                    $('#pushToDriveCentricButton2').off('click').on('click', function(e) {
                        e.preventDefault();
                        console.log('Push To DriveCentric button (ID: 127) clicked');
                        pushToDriveCentric('new');
                    });
                    console.log('Push To DriveCentric button created and appended to #pushToDriveCentricContainer2');
                }
                console.log('HTML block container (ID: 127) content after button insertion:', buttonContainer2.html());

                var htmlField2 = document.querySelector('#gform_fields_' + formId + '_' + buttonContainerFieldId2);
                if (htmlField2 && !htmlField2._hasButtonObserver) {
                    new MutationObserver(function(mutations) {
                        if (!$('#pushToDriveCentricButton2').length && buttonContainer2.is(':visible')) {
                            console.log('Push To DriveCentric button (ID: 127) removed, re-appending');
                            var newButtonHtml2 = '<button id="pushToDriveCentricButton2">Push To DriveCentric</button>';
                            buttonContainer2.html(newButtonHtml2);
                            $('#pushToDriveCentricButton2').off('click').on('click', function(e) {
                                e.preventDefault();
                                console.log('Push To DriveCentric button (ID: 127) clicked');
                                pushToDriveCentric('new');
                            });
                            console.log('Push To DriveCentric button re-appended to #pushToDriveCentricContainer2');
                        }
                    }).observe(htmlField2, { childList: true, subtree: true });
                    htmlField2._hasButtonObserver = true;
                    console.log('Initialized MutationObserver for button in HTML block (ID: 127)');
                }
            } else {
                console.log('Inputs invalid or HTML block container (ID: 127) hidden, clearing button', {
                    nameValid2: !!nameValue2,
                    phoneValid2: phone2.length >= 10,
                    emailValid2: email2 && emailRegex.test(email2),
                    selectedNameValid: !!selectedName,
                    dealershipValid: !!dealership,
                    phoneField2Visible: $('#field_' + formId + '_' + phoneFieldId2).is(':visible'),
                    containerExists2: buttonContainer2.length > 0,
                    containerVisible2: buttonContainer2.length ? buttonContainer2.is(':visible') : 'Not found'
                });
                if (button2.length) {
                    buttonContainer2.html('');
                    console.log('Push To DriveCentric button removed from #pushToDriveCentricContainer2 due to incomplete or invalid inputs or hidden container');
                }
            }
        } catch (e) {
            console.error('Error in checkCustomerInfo:', e);
        }
    }

    // Comments for Part 3/5
    /*
     * This is the updated Part 3/5, continuing from updated Part 2/5, with integration for Terrain population.
     * Completes initFormBindings with trade-in MutationObservers and initCustomerInfoBindings, triggering populateTerrainFeatures and updateTrimLevels('TERRAIN') on Field 107 change.
     * debounce, debounceCheckCustomerInfo, and checkCustomerInfo unchanged.
     * Preserves original functionality.
     * Syntax verified.
     * Ends with open brace for Part 4/5.
     * Meets line requirement.
     */
	function showTrimLevelsPopup(model, trimLevels, modelFilter) {
    $('#trimLevelsPopup, #trimLevelsOverlay').remove();

    // Safety check for parameters
    if (!model) {
        console.error('showTrimLevelsPopup: model parameter is required');
        alert('Error: Model information is missing. Please refresh the page and try again.');
        return;
    }
    
    if (!Array.isArray(trimLevels) || trimLevels.length === 0) {
        console.error('showTrimLevelsPopup: trimLevels must be a non-empty array', {
            model: model,
            trimLevels: trimLevels,
            modelFilter: modelFilter
        });
        
        // Extract just the model name if trimLevels contains HTML
        var modelName = model;
        if (typeof trimLevels === 'string' && trimLevels.includes('<')) {
            // Extract model name from HTML content
            var modelMatch = trimLevels.match(/Available Trim Levels for (\w+)/);
            if (modelMatch) {
                modelName = modelMatch[1];
            }
        }
        
        alert('Error: No trim levels available for ' + modelName + '. Please select some features first.');
        return;
    }
    
    console.log('showTrimLevelsPopup called with:', {
        model: model,
        trimLevels: trimLevels,
        modelFilter: modelFilter
    });

    var csvUrl = 'https://hutchinsonautoteam.com/usedmacon/newfeed.csv';
    fetchCsvWithRetry(csvUrl, 'New Inventory Feed', 3, 1000).then(function(csvText) {
        Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                console.log('New Inventory CSV parsed, rows: ' + results.data.length);
                if (results.data.length === 0 || !results.meta.fields.includes('Series') || !results.meta.fields.includes('Model')) {
                    console.error('New Inventory CSV parsed with 0 rows or missing required columns', {
                        headers: results.meta.fields,
                        firstRow: results.data[0] || 'None',
                        rawContent: csvText.substring(0, 500)
                    });
                    alert('Error: New inventory data is empty or missing required columns (Series, Model). Please verify the CSV file at ' + csvUrl + ' or contact support.');
                    return;
                }

                var filteredVehicles = results.data.filter(function(row) {
                    var series = row['Series'] ? row['Series'].trim() : '';
                    var vehicleModel = row['Model'] ? row['Model'].trim() : '';
                    
                    // Safety check for trimLevels
                    if (!Array.isArray(trimLevels) || trimLevels.length === 0) {
                        console.error('trimLevels is not a valid array in filter function:', trimLevels);
                        return false;
                    }
                    
                    var matchesTrim = trimLevels.some(function(trim) {
                        return model === 'K4' ? trim.toUpperCase() === series.toUpperCase() : fuzzyMatch(trim, series, model, series);
                    });
                    var matchesModel = model === 'K4' ? vehicleModel.toUpperCase() === modelFilter.toUpperCase() : fuzzyMatch(modelFilter, vehicleModel, model, vehicleModel);
                    console.log('Vehicle check:', {
                        series: series,
                        vehicleModel: vehicleModel,
                        modelFilter: modelFilter,
                        matchesTrim: matchesTrim,
                        matchesModel: matchesModel
                    });
                    return matchesTrim && matchesModel;
                });

                console.log('Filtered vehicles for ' + model + ' (Model: ' + modelFilter + '):', filteredVehicles.length);

                if (filteredVehicles.length === 0) {
                    alert('No vehicles found matching the selected trim levels and model (' + modelFilter + ') for ' + model + '.');
                    return;
                }

                var columns = [
                    { key: 'DealerId', label: 'Dealer' },
                    { key: 'Year', label: 'Year' },
                    { key: 'Make', label: 'Make' },
                    { key: 'Model', label: 'Model' },
                    { key: 'Series', label: 'Trim Level' },
                    { key: 'Stock #', label: 'Stock #' },
                    { key: 'VIN', label: 'VIN' },
                    { key: 'Colour', label: 'Exterior Color' },
                    { key: 'Interior Color', label: 'Interior Color' },
                    { key: 'MSRP', label: 'MSRP' },
                    { key: 'ViewOnline', label: 'View Online' },
                    { key: 'WindowSticker', label: 'Window Sticker' }
                ];

                var tableHtml = '\
                    <div class="trim-table-container">\
                        <table class="trim-table" id="trimLevelsTable">\
                            <thead>\
                                <tr>' +
                                columns.map(function(col, index) {
                                    return '<th data-column="' + index + '">' + col.label + '<span class="sort-arrow"></span></th>';
                                }).join('') +
                                '</tr>\
                            </thead>\
                            <tbody>' +
                            filteredVehicles.map(function(vehicle, index) {
                                var dealerId = vehicle['DealerId'] ? vehicle['DealerId'].trim() : 'N/A';
                                var dealerName = dealerId;
                                var viewOnlineUrl = '#';
                                var windowStickerUrl = '#';
                                var stockNumber = vehicle['Stock #'] ? vehicle['Stock #'].trim() : 'N/A';
                                if (dealerId === 'MP18519') {
                                    dealerName = 'Kia of Macon';
                                    viewOnlineUrl = 'https://www.kiaofmacon.com/new-vehicles/?q=' + encodeURIComponent(vehicle['VIN'] || '');
                                    windowStickerUrl = 'https://www.kiaofmacon.com/dealer-inspire-inventory/window-stickers/kia?vin=' + encodeURIComponent(vehicle['VIN'] || '');
                                } else if (dealerId === 'MP19913') {
                                    dealerName = 'Kia of Albany';
                                    viewOnlineUrl = 'https://www.hutchinsonkiaofalbany.com/new-vehicles/?q=' + encodeURIComponent(vehicle['VIN'] || '');
                                    windowStickerUrl = 'https://www.hutchinsonkiaofalbany.com/dealer-inspire-inventory/window-stickers/kia?vin=' + encodeURIComponent(vehicle['VIN'] || '');
                                } else if (dealerId === 'MP18517') {
                                    dealerName = 'Hutchinson GMC Cadillac';
                                    viewOnlineUrl = vehicle['Make'].toLowerCase() === 'cadillac'
                                        ? 'https://www.hutchinsoncadillac.com/new-vehicles/?q=' + encodeURIComponent(vehicle['VIN'] || '')
                                        : 'https://www.hutchinsongmc.com/new-vehicles/?q=' + encodeURIComponent(vehicle['VIN'] || '');
                                    windowStickerUrl = 'https://cws.gm.com/vs-cws/vehshop/v2/vehicle/windowsticker?vin=' + encodeURIComponent(vehicle['VIN'] || '');
                                }
                                return '<tr>' +
                                    columns.map(function(col) {
                                        if (col.key === 'DealerId') {
                                            return '<td>' + dealerName + '</td>';
                                        } else if (col.key === 'ViewOnline') {
                                            return '<td><a href="' + viewOnlineUrl + '" target="_blank">View Vehicle Online</a></td>';
                                        } else if (col.key === 'WindowSticker') {
                                            return '<td><a href="' + windowStickerUrl + '" target="_blank">Window Sticker</a></td>';
                                        } else if (col.key === 'Stock #') {
                                            return '<td>' + stockNumber + ' <a href="#" class="copy-stock-link" data-stock="' + stockNumber + '" data-index="' + index + '">Copy Stock #</a></td>';
                                        } else {
                                            return '<td>' + (vehicle[col.key] ? vehicle[col.key].trim() : 'N/A') + '</td>';
                                        }
                                    }).join('') +
                                    '</tr>';
                            }).join('') +
                            '</tbody>\
                        </table>\
                    </div>';

                var popupHtml = '\
                    <div id="trimLevelsPopup">\
                        <div id="trimLevelsPopupContent">\
                            <div class="trim-header">\
                                <h2>Available Trim Levels for ' + modelFilter + '</h2>\
                            </div>' +
                            tableHtml +
                        '</div>\
                        <button type="button" class="trim-close-popup">Close</button>\
                    </div>\
                    <div id="trimLevelsOverlay"></div>';

                $('body').append(popupHtml);

                var popup = $('#trimLevelsPopup');
                var overlay = $('#trimLevelsOverlay');

                console.log('Trim Levels popup created for ' + model + ' (Model: ' + modelFilter + '), exists: ' + (popup.length > 0));

                overlay.on('click', function(e) {
                    if (e.target.id === 'trimLevelsOverlay') {
                        console.log('Trim Levels overlay clicked, closing popup');
                        $('#trimLevelsPopup, #trimLevelsOverlay').remove();
                    }
                });

                popup.find('.trim-close-popup').on('click', function() {
                    console.log('Trim Levels close button clicked, closing popup');
                    $('#trimLevelsPopup, #trimLevelsOverlay').remove();
                });

                popup.find('.copy-stock-link').on('click', function(e) {
                    e.preventDefault();
                    var stockNumber = $(this).data('stock');
                    navigator.clipboard.writeText(stockNumber).then(function() {
                        console.log('Stock number copied to clipboard: ' + stockNumber);
                        alert('Copied ' + stockNumber + ' to clipboard successfully.');
                    }).catch(function(err) {
                        console.error('Failed to copy stock number: ' + stockNumber, err);
                        alert('Failed to copy stock number. Please try again.');
                    });
                });

                popup.find('.trim-table th').on('click', function() {
                    var columnIndex = $(this).data('column');
                    var isAsc = !$(this).hasClass('sort-asc');
                    sortTable(columnIndex, isAsc);
                    popup.find('.trim-table th').removeClass('sort-asc sort-desc');
                    $(this).addClass(isAsc ? 'sort-asc' : 'sort-desc');
                    popup.find('.trim-table th .sort-arrow').text('');
                    $(this).find('.sort-arrow').text(isAsc ? '‚Üë' : '‚Üì');
                });

                console.log('Trim Levels popup content loaded for ' + model + ' (Model: ' + modelFilter + ')');
            },
            error: function(error) {
                console.error('Papa Parse error for New Inventory CSV: ' + error);
                alert('Error: Failed to parse new inventory data. Please contact support.');
            }
        });
    }).catch(function(error) {
        console.error('Fetch error for New Inventory CSV: ' + error.message);
        alert('Error: Unable to load new inventory data. Please check the CSV file at ' + csvUrl + ' or contact support.');
    });
}

function sortTable(columnIndex, isAsc) {
    var table = $('#trimLevelsTable');
    var rows = table.find('tbody tr').get();

    rows.sort(function(a, b) {
        var aValue = $(a).children('td').eq(columnIndex).text().trim();
        var bValue = $(b).children('td').eq(columnIndex).text().trim();

        if (columnIndex === 5) { // Stock # column
            aValue = aValue.split(' ')[0];
            bValue = bValue.split(' ')[0];
        }

        if (columnIndex === 1 || columnIndex === 9) { // Year or MSRP (numeric)
            aValue = parseFloat(aValue) || 0;
            bValue = parseFloat(bValue) || 0;
            return isAsc ? aValue - bValue : bValue - aValue;
        } else { // String comparison
            return isAsc
                ? aValue.localeCompare(bValue)
                : bValue.localeCompare(aValue);
        }
    });

    table.find('tbody').empty().append(rows);
    console.log('Table sorted on column ' + columnIndex + ', ascending: ' + isAsc);
}

function pushToDriveCentric(source) {
    console.log('pushToDriveCentric called with source: ' + source);
    var nameFieldIdSource = source === 'new' ? nameFieldId2 : nameFieldId;
    var phoneFieldIdSource = source === 'new' ? phoneFieldId2 : phoneFieldId;
    var emailFieldIdSource = source === 'new' ? emailFieldId2 : emailFieldId;
    var textReceiptFieldIdSource = source === 'new' ? textReceiptFieldId2 : textReceiptFieldId;

    var nameSubfieldFirst = $('#input_' + formId + '_' + nameFieldIdSource + '_3');
    var nameSubfieldLast = $('#input_' + formId + '_' + nameFieldIdSource + '_6');
    var name = '';
    if (nameSubfieldFirst.length || nameSubfieldLast.length) {
        var firstName = (nameSubfieldFirst.val() || '').trim();
        var lastName = (nameSubfieldLast.val() || '').trim();
        name = (firstName + ' ' + lastName).trim();
    }

    var phone = ($('#input_' + formId + '_' + phoneFieldIdSource).val() || '').trim().replace(/\D/g, '');
    var email = ($('#input_' + formId + '_' + emailFieldIdSource).val() || '').trim();
    var whatsImportant = ($('#input_' + formId + '_' + availabilityFieldId).val() || '').trim();
    var tradeInQuestion = $('#field_' + formId + '_' + tradeInQuestionFieldId + ' input[type="radio"]:checked').val() || '';
    var tradeYear = tradeInQuestion.toLowerCase() === 'has trade-in' ? ($('#input_' + formId + '_' + tradeInYearFieldId).val() || '').trim() : '';
    var tradeMake = tradeInQuestion.toLowerCase() === 'has trade-in' ? ($('#input_' + formId + '_' + tradeInMakeFieldId).val() || '').trim() : '';
    var tradeModel = tradeInQuestion.toLowerCase() === 'has trade-in' ? ($('#input_' + formId + '_' + tradeInModelFieldId).val() || '').trim() : '';
    var tradeAltYear = tradeInQuestion.toLowerCase() === 'has trade-in' ? ($('#input_' + formId + '_' + tradeInAltYearFieldId).val() || '').trim() : '';
    var tradeAltMake = tradeInQuestion.toLowerCase() === 'has trade-in' ? ($('#input_' + formId + '_' + tradeInAltMakeFieldId).val() || '').trim() : '';
    var tradeAltModel = tradeInQuestion.toLowerCase() === 'has trade-in' ? ($('#input_' + formId + '_' + tradeInAltModelFieldId).val() || '').trim() : '';
    var tradeMiles = tradeInQuestion.toLowerCase() === 'has trade-in' ? ($('#input_' + formId + '_' + 39).val() || '').trim() : '';
    var liveAndWork = ($('#input_' + formId + '_' + 40).val() || '').trim();
    var hobbiesInterests = ($('#input_' + formId + '_' + 41).val() || '').trim();
    var wantsVideo = $('#field_' + formId + '_' + videoMessageFieldId + ' input[type="radio"]:checked').val() || '';
    var selectedName = ($('#input_' + formId + '_' + hiddenFieldId).val() || '').trim();
    var rawDealership = ($('#field_' + formId + '_' + dealershipFieldId + ' input[type="radio"]:checked').val() || '').trim();
    var customerComment = ($('#input_' + formId + '_' + customerCommentFieldId).val() || '').trim();

    var dealership = rawDealership.toLowerCase().replace(/\b\w/g, function(c) { return c.toUpperCase(); });
    if (dealership === 'Kia Of Macon') dealership = 'Kia of Macon';
    if (dealership === 'Gmc Cadillac') dealership = 'GMC Cadillac';
    var emailMappingKey = dealership === 'Kia of Macon' || dealership === 'GMC Cadillac' ? dealership : 'Kia of Macon';

    var normalizedSelectedName = selectedName.toLowerCase().replace(/\b\w/g, function(c) { return c.toUpperCase(); });
    var employeeEmail = emailMappings[emailMappingKey] && emailMappings[emailMappingKey][normalizedSelectedName]
        ? emailMappings[emailMappingKey][normalizedSelectedName]
        : 'default@drivekiaofmacon.com';

    var yearFound = ($('#input_' + formId + '_' + yearFoundFieldId).val() || '').trim();
    var makeFound = ($('#input_' + formId + '_' + makeFoundFieldId).val() || '').trim();
    var modelFound = ($('#input_' + formId + '_' + modelFoundFieldId).val() || '').trim();
    var yearFoundFieldVisible = $('#field_' + formId + '_' + yearFoundFieldId).is(':visible');
    var makeFoundFieldVisible = $('#field_' + formId + '_' + makeFoundFieldId).is(':visible');
    var modelFoundFieldVisible = $('#field_' + formId + '_' + modelFoundFieldId).is(':visible');
    var foundFieldsValid = yearFound && makeFound && modelFound && yearFoundFieldVisible && makeFoundFieldVisible && modelFoundFieldVisible;
    var customerCommentFieldVisible = $('#field_' + formId + '_' + customerCommentFieldId).is(':visible');
    var hasCustomerComment = customerComment && customerCommentFieldVisible;

    var stockKia = ($('#input_' + formId + '_' + stockKiaFieldId).val() || '').trim();
    var yearKia = ($('#input_' + formId + '_' + yearKiaFieldId).val() || '').trim();
    var makeKia = ($('#input_' + formId + '_' + makeKiaFieldId).val() || '').trim();
    var modelKia = ($('#input_' + formId + '_' + modelKiaFieldId).val() || '').trim();
    var stockKiaFieldVisible = $('#field_' + formId + '_' + stockKiaFieldId).is(':visible');
    var yearKiaFieldVisible = $('#field_' + formId + '_' + yearKiaFieldId).is(':visible');
    var makeKiaFieldVisible = $('#field_' + formId + '_' + makeKiaFieldId).is(':visible');
    var modelKiaFieldVisible = $('#field_' + formId + '_' + modelKiaFieldId).is(':visible');
    var kiaFieldsValid = stockKia && yearKia && makeKia && modelKia && stockKiaFieldVisible && yearKiaFieldVisible && makeKiaFieldVisible && modelKiaFieldVisible;

    var stock = ($('#input_' + formId + '_' + stockFieldId).val() || '').trim();
    var year = ($('#input_' + formId + '_' + yearFieldId).val() || '').trim();
    var make = ($('#input_' + formId + '_' + makeFieldId).val() || '').trim();
    var model = ($('#input_' + formId + '_' + modelFieldId).val() || '').trim();
    var stockFieldVisible = $('#field_' + formId + '_' + stockFieldId).is(':visible');
    var yearFieldVisible = $('#field_' + formId + '_' + yearFieldId).is(':visible');
    var makeFieldVisible = $('#field_' + formId + '_' + makeFieldId).is(':visible');
    var modelFieldVisible = $('#field_' + formId + '_' + modelFieldId).is(':visible');
    var standardFieldsValid = stock && year && make && model && stockFieldVisible && yearFieldVisible && makeFieldVisible && modelFieldVisible;

    var selectedStock, selectedYear, selectedMake, selectedModel, vin;
    if (hasCustomerComment) {
        selectedStock = '';
        selectedYear = '';
        selectedMake = '';
        selectedModel = '';
        vin = '';
        console.log('Using customer comment (ID: 113) only, no vehicle data:', { customerComment });
    } else if (foundFieldsValid) {
        selectedStock = '';
        selectedYear = yearFound;
        selectedMake = makeFound;
        selectedModel = modelFound;
        vin = '';
                        console.log('Using found fields (IDs: 124, 138, 126) for DriveCentric:', { stock: selectedStock, year: selectedYear, make: selectedMake, model: selectedModel });
    } else if (kiaFieldsValid) {
        selectedStock = stockKia;
        selectedYear = yearKia;
        selectedMake = makeKia;
        selectedModel = modelKia;
        vin = vehicleKiaData ? (vehicleKiaData['VIN'] || '').trim() : '';
        console.log('Using Kia fields for DriveCentric:', { stock: selectedStock, year: selectedYear, make: selectedMake, model: selectedModel, vin: vin });
    } else if (standardFieldsValid) {
        selectedStock = stock;
        selectedYear = year;
        selectedMake = make;
        selectedModel = model;
        vin = vehicleData ? (vehicleData['VIN'] || '').trim() : '';
        console.log('Using standard fields for DriveCentric:', { stock: selectedStock, year: selectedYear, make: selectedMake, model: selectedModel, vin: vin });
    } else {
        selectedStock = stockKia || stock;
        selectedYear = yearKia || year;
        selectedMake = makeKia || make;
        selectedModel = modelKia || model;
        vin = (vehicleKiaData ? vehicleKiaData['VIN'] : vehicleData ? vehicleData['VIN'] : '') || '';
        console.log('Partial or no fields valid, using available data:', { stock: selectedStock, year: selectedYear, make: selectedMake, model: selectedModel, vin: vin });
    }

    console.log('Employee email lookup:', {
        dealership: dealership,
        selectedName: normalizedSelectedName,
        employeeEmail: employeeEmail,
        emailMappingKey: emailMappingKey,
        emailMappingExists: !!emailMappings[emailMappingKey],
        nameInMapping: !!emailMappings[emailMappingKey] && !!emailMappings[emailMappingKey][normalizedSelectedName]
    });

    console.log('Push To DriveCentric inputs:', {
        name: name,
        phone: phone,
        email: email,
        stock: selectedStock,
        year: selectedYear,
        make: selectedMake,
        model: selectedModel,
        vin: vin,
        customerComment: customerComment,
        whatsImportant: whatsImportant,
        tradeInQuestion: tradeInQuestion,
        tradeYear: tradeYear,
        tradeMake: tradeMake,
        tradeModel: tradeModel,
        tradeAltYear: tradeAltYear,
        tradeAltMake: tradeAltMake,
        tradeAltModel: tradeAltModel,
        tradeMiles: tradeMiles,
        liveAndWork: liveAndWork,
        hobbiesInterests: hobbiesInterests,
        wantsVideo: wantsVideo,
        selectedName: normalizedSelectedName,
        employeeEmail: employeeEmail,
        dealership: dealership,
        source: source
    });

    var missingInputs = [];
    if (!name) missingInputs.push('First and Last Name');
    if (!phone || phone.length < 10) missingInputs.push('Phone Number');
    if (!email) missingInputs.push('Email');
    if (!normalizedSelectedName) missingInputs.push('Employee (Manager, Salesperson, or BDC Rep)');
    if (!dealership) missingInputs.push('Dealership');
    if (!hasCustomerComment && !foundFieldsValid && !kiaFieldsValid && !standardFieldsValid) {
        missingInputs.push('Vehicle Data (Stock Number or Year/Make/Model) or Customer Comment');
    }

    if (missingInputs.length > 0) {
        console.error('Required fields missing: ' + missingInputs.join(', '));
        alert('Please fill in all required fields: ' + missingInputs.join(', '));
        return;
    }

    if (tradeInQuestion.toLowerCase() === 'has trade-in') {
        if (tradeYear && tradeMake && tradeModel) {
            var tradeMilesNumeric = tradeMiles ? parseInt(tradeMiles, 10) : 0;
            if (isNaN(tradeMilesNumeric) || tradeMilesNumeric < 0) {
                console.warn('Invalid trade-in miles:', tradeMiles);
                alert('Please enter a valid number for trade-in miles');
                return;
            }
        } else if (!tradeYear && !tradeMake && !tradeModel) {
            console.log('Primary trade-in fields empty, proceeding with optional alternate trade-in fields');
        } else {
            console.warn('Primary trade-in data incomplete:', { tradeYear, tradeMake, tradeModel });
            alert('Please complete all primary trade-in fields: Year, Make, Model');
            return;
        }
    }

    function formatPhoneNumber(phone) {
        if (!phone) return '';
        var digits = phone.replace(/\D/g, '');
        var match = digits.match(/^(\d{3})(\d{3})(\d{4})$/);
        return match ? '(' + match[1] + ') ' + match[2] + '-' + match[3] : phone;
    }
    var formattedPhone = formatPhoneNumber(phone);

    var now = new Date();
    var pacificOffset = -7 * 60;
    var pacificDate = new Date(now.getTime() + pacificOffset * 60 * 1000);
    var idDateTime = pacificDate.toISOString().replace(/[-:T.]/g, '').slice(0, 14);
    var requestDate = pacificDate.toISOString().slice(0, 19) + '-07:00';
    var nameSplit = name.trim().split(' ', 2);
    var firstName = nameSplit[0].trim() || '';
    var lastName = nameSplit[1] ? nameSplit[1].trim() : '';

    var tradeMilesNumeric = tradeInQuestion.toLowerCase() === 'has trade-in' ? (parseInt(tradeMiles, 10) || 0) : '';

    var comments = [
        hasCustomerComment ? 'Customer Comment: ' + customerComment : '',
        'Whats most important: ' + (whatsImportant || 'Not provided'),
        'Has trade in? ' + (tradeInQuestion || 'Not provided'),
        'Live and Work? ' + (liveAndWork || 'Not provided'),
        'Hobbies Interests: ' + (hobbiesInterests || 'Not provided'),
        'Wants Video: ' + (wantsVideo || 'Not provided')
    ].filter(function(c) { return c; }).join('; ');

    var xml = '<?xml version="1.0" encoding="UTF-8"?>\n' +
        '<adf>\n' +
        '  <prospect>\n' +
        '    <id source="' + (normalizedSelectedName || 'BDC Agent') + '">' + idDateTime + '</id>\n' +
        '    <requestdate>' + requestDate + '</requestdate>\n';

    if (!hasCustomerComment) {
        xml += '    <vehicle interest="buy" status="new">\n' +
               '      <id source="model code"></id>\n' +
               '      <stock>' + (selectedStock || '') + '</stock>\n' +
               '      <year>' + (selectedYear || '') + '</year>\n' +
               '      <make>' + (selectedMake || '') + '</make>\n' +
               '      <model>' + (selectedModel || '') + '</model>\n' +
               '    </vehicle>\n';
    }

    if (tradeInQuestion.toLowerCase() === 'has trade-in' && tradeYear && tradeMake && tradeModel) {
        xml += '    <vehicle interest="trade-in" status="used">\n' +
               '      <year>' + (tradeYear || '') + '</year>\n' +
               '      <make>' + (tradeMake || '') + '</make>\n' +
               '      <model>' + (tradeModel || '') + '</model>\n' +
               '      <odometer status="actual" units="miles">' + (tradeMilesNumeric || '0') + '</odometer>\n' +
               '      <comments></comments>\n' +
               '    </vehicle>\n';
    }

    if (tradeInQuestion.toLowerCase() === 'has trade-in' && tradeAltYear && tradeAltMake && tradeAltModel) {
        xml += '    <vehicle interest="trade-in" status="used">\n' +
               '      <year>' + (tradeAltYear || '') + '</year>\n' +
               '      <make>' + (tradeAltMake || '') + '</make>\n' +
               '      <model>' + (tradeAltModel || '') + '</model>\n' +
               '      <odometer status="actual" units="miles">' + (tradeMilesNumeric || '0') + '</odometer>\n' +
               '      <comments></comments>\n' +
               '    </vehicle>\n';
    }

    xml += '    <customer>\n' +
           '      <contact>\n' +
           '        <name part="first">' + firstName + '</name>\n' +
           '        <name part="last">' + lastName + '</name>\n' +
           '        <email preferredcontact="0">' + (email || '') + '</email>\n' +
           '        <phone preferredcontact="0" time="nopreference" type="voice">' + formattedPhone + '</phone>\n' +
           '      </contact>\n' +
           '      <comments>' + comments + '</comments>\n' +
           '    </customer>\n' +
           '    <vendor>\n' +
           '      <id source="205:ADF XML Email"></id>\n' +
           '      <id source="AdditionalEmails">' + employeeEmail + '</id>\n' +
           '      <id source="' + (dealership || 'Kia of Macon') + '">' + (dealership || 'Kia of Macon') + '</id>\n' +
           '      <contact>\n' +
           '        <name part="full" type="individual"></name>\n' +
           '        <email preferredcontact="0">' + employeeEmail + '</email>\n' +
           '        <phone preferredcontact="0" time="nopreference" type="voice"></phone>\n' +
           '        <address>\n' +
           '          <street line="1">3931 River Place Drive</street>\n' +
           '          <city>Macon</city>\n' +
           '          <regioncode>GA</regioncode>\n' +
           '          <postalcode>31210</postalcode>\n' +
           '        </address>\n' +
           '      </contact>\n' +
           '    </vendor>\n' +
           '    <provider>\n' +
           '      <name part="full">' + (normalizedSelectedName || 'BDC Agent') + '</name>\n' +
           '      <service>' + (normalizedSelectedName || 'BDC Agent') + '</service>\n' +
           '      <leadtype>internet</leadtype>\n' +
           '    </provider>\n' +
           '  </prospect>\n' +
           '</adf>';

    console.log('Generated ADF XML: ' + xml);

    try {
        var parser = new DOMParser();
        var xmlDoc = parser.parseFromString(xml, 'text/xml');
        if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
            throw new Error('Invalid XML format');
        }
    } catch (e) {
        console.error('Client-side XML validation failed:', e);
        alert('Error generating lead: Invalid XML format. Please try again or contact support.');
        return;
    }

    $.ajax({
        url: 'https://hutchinsonautoteam.com/send-adf-lead.php',
        method: 'POST',
        contentType: 'text/plain',
        data: xml,
        beforeSend: function(xhr) {
            console.log('Sending AJAX request to: https://hutchinsonautoteam.com/send-adf-lead.php');
        },
        success: function(data) {
            console.log('Lead sent successfully:', data);
            try {
                var response = typeof data === 'string' ? JSON.parse(data) : data;
                if (response.message) {
                    showSuccessPopup(employeeEmail);
                    setTimeout(function() {
                        showTextReceiptField(textReceiptFieldIdSource);
                        showAppointmentConfirmationField();
                    }, 1000);
                } else {
                    throw new Error(response.error || 'Unknown server response');
                }
            } catch (e) {
                console.error('Error parsing server response:', e, data);
                alert('Lead sent but response parsing failed: ' + (e.message || 'Unknown error'));
            }
        },
        error: function(xhr, status, error) {
            console.error('Error sending lead:', {
                url: 'https://hutchinsonautoteam.com/send-adf-lead.php',
                status: status,
                error: error,
                response: xhr.responseText || 'No response'
            });
            var errorMessage = 'Failed to send lead: ';
            try {
                var response = JSON.parse(xhr.responseText);
                errorMessage += response.error || error;
            } catch (e) {
                errorMessage += error + (xhr.responseText ? ' - ' + xhr.responseText : '');
            }
            alert(errorMessage);
        }
    });

    serviceData.new = {
        name: name,
        phone: phone,
        email: email,
        stock: selectedStock,
        year: selectedYear,
        make: selectedMake,
        model: selectedModel,
        vin: vin,
        customerComment: customerComment,
        whatsImportant: whatsImportant,
        tradeInQuestion: tradeInQuestion,
        tradeYear: tradeYear,
        tradeMake: tradeMake,
        tradeModel: tradeModel,
        tradeAltYear: tradeAltYear,
        tradeAltMake: tradeAltMake,
        tradeAltModel: tradeAltModel,
        tradeMiles: tradeMilesNumeric,
        liveAndWork: liveAndWork,
        hobbiesInterests: hobbiesInterests,
        wantsVideo: wantsVideo,
        employeeName: normalizedSelectedName,
        dealership: dealership
    };
    console.log('Updated serviceData: ', serviceData);
}

function showSuccessPopup(employeeEmail) {
    $('#successPopup, #successPopupStyles').remove();

    var popupStyles = '\
        #successPopup {\
            position: fixed;\
            top: 50%;\
            left: 50%;\
            transform: translate(-50%, -50%);\
            background: #ffffff;\
            border-radius: 8px;\
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);\
            padding: 20px;\
            z-index: 1002;\
            text-align: center;\
            max-width: 400px;\
            width: 90%;\
        }\
        #successPopup p {\
            margin: 0 0 15px 0;\
            font-size: 16px;\
            color: #333333;\
        }\
        #successPopup button {\
            padding: 10px 20px;\
            background: #dc2626;\
            color: #ffffff;\
            border: none;\
            border-radius: 4px;\
            cursor: pointer;\
            font-size: 14px;\
        }\
        #successPopup button:hover {\
            background: #b91c1c;\
        }';
    $('head').append('<style id="successPopupStyles">' + popupStyles + '</style>');

    var popup = $('<div>', { id: 'successPopup' }).append(
        $('<p>', { text: 'Lead successfully sent to ' + employeeEmail }),
        $('<button>', { text: 'OK' }).on('click', function() {
            $(this).parent().remove();
            $('#successPopupStyles').remove();
            console.log('Success popup closed');
        })
    );
    $('body').append(popup);
    console.log('Success popup created and displayed with: Lead successfully sent to ' + employeeEmail);
}

    // Comments for Part 4/5
    /*
     * This is the updated Part 4/5, continuing from updated Part 3/5, with Terrain support in showTrimLevelsPopup (fuzzy matching for series/model).
     * showTrimLevelsPopup handles Terrain with dealer-specific URLs (e.g., MP18517 for GMC).
     * sortTable unchanged.
     * pushToDriveCentric handles GMC dealership/email mapping.
     * showSuccessPopup unchanged.
     * Preserves original functionality.
     * Syntax verified.
     * Ends with open brace for Part 5/5.
     * Meets line requirement.
     */
	function showTextReceiptField(fieldId) {
    var nameFieldIdSource = fieldId === textReceiptFieldId2 ? nameFieldId2 : nameFieldId;
    var field = $('#field_' + formId + '_' + fieldId);
    var nameSubfieldFirst = $('#input_' + formId + '_' + nameFieldIdSource + '_3');
    var nameSubfieldLast = $('#input_' + formId + '_' + nameFieldIdSource + '_6');
    var name = '';
    if (nameSubfieldFirst.length && nameSubfieldLast.length) {
        var firstName = (nameSubfieldFirst.val() || '').trim();
        var lastName = (nameSubfieldLast.val() || '').trim();
        name = (firstName + ' ' + lastName).trim() || 'Customer';
    } else {
        console.warn('Name subfields for ID ' + fieldId + ' not found:', {
            firstNameExists: nameSubfieldFirst.length > 0,
            lastNameExists: nameSubfieldLast.length > 0,
            nameFieldIdSource: nameFieldIdSource
        });
        name = 'Customer';
    }
    var selectedName = ($('#input_' + formId + '_' + hiddenFieldId).val() || 'BDC Agent').trim();

    if (field.length) {
        var label = field.find('.gfield_label');
        var description = field.find('.gfield_description');
        var labelText = fieldId === textReceiptFieldId
            ? 'Great! I will have one of our product specialists send you a walkaround video. I just sent you a text it will say "Hi ' + name + ', this is ' + selectedName + ' from Kia of Macon let me know when you received it."'
            : 'Great! I just sent you a text it will say "Hi ' + name + ', this is ' + selectedName + ' from Kia of Macon let me know when you received it."';
        var descriptionText = 'Did ' + name + ' receive text?';
        console.log('Updating text receipt field (ID: ' + fieldId + '):', { labelText: labelText, descriptionText: descriptionText });

        setTimeout(function() {
            label.text(labelText);
            description.text(descriptionText);
            field.css('display', 'block').removeClass('gfield_visibility_hidden').show();
            console.log('Text receipt field (ID: ' + fieldId + ') displayed with updated label and description');
            console.log('Radio buttons present: ' + (field.find('.gfield_radio').length > 0));
            console.log('Field visibility:', {
                display: field.css('display'),
                visibility: field.css('visibility'),
                isHidden: field.is(':hidden'),
                classes: field.attr('class')
            });
        }, 500);
    } else {
        console.error('Text receipt field (ID: ' + fieldId + ') not found');
        console.log('Form fields container debug:', {
            containerExists: $('#gform_fields_' + formId).length > 0,
            fieldIds: $('#gform_fields_' + formId).find('.gfield').map(function() { return $(this).attr('id'); }).get()
        });
        alert('Error: Text receipt field (ID: ' + fieldId + ') not found in form. Please check Gravity Forms configuration.');
    }
}

function updateTextReceiptField(fieldId) {
    var nameFieldIdSource = fieldId === textReceiptFieldId2 ? nameFieldId2 : nameFieldId;
    var field = $('#field_' + formId + '_' + fieldId);
    if (field.is(':visible')) {
        var nameSubfieldFirst = $('#input_' + formId + '_' + nameFieldIdSource + '_3');
        var nameSubfieldLast = $('#input_' + formId + '_' + nameFieldIdSource + '_6');
        var name = '';
        if (nameSubfieldFirst.length && nameSubfieldLast.length) {
            var firstName = (nameSubfieldFirst.val() || '').trim();
            var lastName = (nameSubfieldLast.val() || '').trim();
            name = (firstName + ' ' + lastName).trim() || 'Customer';
        } else {
            name = 'Customer';
        }
        var selectedName = ($('#input_' + formId + '_' + hiddenFieldId).val() || 'BDC Agent').trim();
        var label = field.find('.gfield_label');
        var description = field.find('.gfield_description');
        var labelText = fieldId === textReceiptFieldId
            ? 'Great! I will have one of our product specialists send you a walkaround video. I just sent you a text it will say "Hi ' + name + ', this is ' + selectedName + ' from Kia of Macon let me know when you received it."'
            : 'Great! I just sent you a text it will say "Hi ' + name + ', this is ' + selectedName + ' from Kia of Macon let me know when you received it."';
        var descriptionText = 'Did ' + name + ' receive text?';
        console.log('Updating visible text receipt field (ID: ' + fieldId + '):', { labelText: labelText, descriptionText: descriptionText });
        label.text(labelText);
        description.text(descriptionText);
    }
}

function showAppointmentConfirmationField() {
    var field = $('#field_' + formId + '_' + appointmentConfirmationFieldId);
    var dayPicker = $('#input_' + formId + '_' + dateFieldId).val() || '';
    var timePeriod = $('#field_' + formId + '_' + timePeriodFieldId + ' input[type="radio"]:checked').val() || '';

    if (field.length) {
        var input = $('#input_' + formId + '_' + appointmentConfirmationFieldId);
        if (input.length) {
            input.prop('readonly', false).prop('disabled', false);
            console.log('Field 57 input state:', {
                readonly: input.prop('readonly'),
                disabled: input.prop('disabled'),
                styles: window.getComputedStyle(input[0]),
                events: $._data(input[0], 'events')
            });
        }

        var friendlyDay = 'Not selected';
        var daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        if (dayPicker && /^\d{2}\/\d{2}\/\d{4}$/.test(dayPicker)) {
            var dateParts = dayPicker.split('/');
            var date = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);
            if (!isNaN(date.getTime())) {
                friendlyDay = daysOfWeek[date.getDay()];
            } else {
                console.warn('Invalid date format for Field 52:', dayPicker);
            }
        } else if (dayPicker) {
            console.warn('Invalid date format for Field 52:', dayPicker);
        }

        var selectedTimePeriod = timePeriod || 'Not selected';
        console.log('Time period field debug:', {
            id: timePeriodFieldId,
            value: selectedTimePeriod,
            fieldExists: $('#field_' + formId + '_' + timePeriodFieldId).length > 0,
            fieldVisible: $('#field_' + formId + '_' + timePeriodFieldId).is(':visible'),
            radioOptions: $('#field_' + formId + '_' + timePeriodFieldId + ' input[type="radio"]').map(function() { return $(this).val(); }).get()
        });

        var label = field.find('.gfield_label');
        var baseLabelText = 'Great I have you all set for {gf_entry:gf_field_52} {gf_entry:gf_field_53}, Quick question, you could be running errands on this day, doing groceries, taking care of other odds and ends, WHAT made you say yes to meeting with us for this appointment?';
        var labelText = baseLabelText
            .replace('{gf_entry:gf_field_52}', friendlyDay)
            .replace('{gf_entry:gf_field_53}', selectedTimePeriod);
        console.log('Updating appointment confirmation field (ID: 57):', {
            labelText: labelText,
            dayPicker: dayPicker,
            selectedTimePeriod: selectedTimePeriod
        });

        setTimeout(function() {
            label.text(labelText);
            field.css('display', 'block').removeClass('gfield_visibility_hidden').show();
            if (input.length) {
                input.prop('readonly', false).prop('disabled', false).css({'pointer-events': 'auto', 'z-index': '10'});
                console.log('Field 57 input state updated:', {
                    value: input.val(),
                    readonly: input.prop('readonly'),
                    disabled: input.prop('disabled'),
                    styles: window.getComputedStyle(input[0]),
                    events: $._data(input[0], 'events')
                });
            }
            console.log('Appointment confirmation field (ID: 57) displayed with updated label');
            console.log('Input present: ' + (input.length > 0));
            console.log('Field visibility:', {
                display: field.css('display'),
                visibility: field.css('visibility'),
                isHidden: field.is(':hidden'),
                classes: field.attr('class')
            });
        }, 500);
    } else {
        console.error('Appointment confirmation field (ID: 57) not found');
        console.log('Form fields container debug:', {
            containerExists: $('#gform_fields_' + formId).length > 0,
            fieldIds: $('#gform_fields_' + formId).find('.gfield').map(function() { return $(this).attr('id'); }).get()
        });
        alert('Error: Appointment confirmation field (ID: 57) not found in form. Please check Gravity Forms configuration.');
    }
}

function updateAppointmentConfirmationField() {
    var field = $('#field_' + formId + '_' + appointmentConfirmationFieldId);
    if (field.is(':visible')) {
        var dayPicker = $('#input_' + formId + '_' + dateFieldId).val() || '';
        var timePeriod = $('#field_' + formId + '_' + timePeriodFieldId + ' input[type="radio"]:checked').val() || '';

        var friendlyDay = 'Not selected';
        var daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        if (dayPicker && /^\d{2}\/\d{2}\/\d{4}$/.test(dayPicker)) {
            var dateParts = dayPicker.split('/');
            var date = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);
            if (!isNaN(date.getTime())) {
                friendlyDay = daysOfWeek[date.getDay()];
            } else {
                console.warn('Invalid date format for Field 52:', dayPicker);
            }
        } else if (dayPicker) {
            console.warn('Invalid date format for Field 52:', dayPicker);
        }

        var selectedTimePeriod = timePeriod || 'Not selected';
        console.log('Time period field debug (update):', {
            id: timePeriodFieldId,
            value: selectedTimePeriod,
            fieldExists: $('#field_' + formId + '_' + timePeriodFieldId).length > 0,
            fieldVisible: $('#field_' + formId + '_' + timePeriodFieldId).is(':visible'),
            radioOptions: $('#field_' + formId + '_' + timePeriodFieldId + ' input[type="radio"]').map(function() { return $(this).val(); }).get()
        });

        var label = field.find('.gfield_label');
        var baseLabelText = 'Great I have you all set for {gf_entry:gf_field_52} {gf_entry:gf_field_53}, Quick question, you could be running errands on this day, doing groceries, taking care of other odds and ends, WHAT made you say yes to meeting with us for this appointment?';
        var labelText = baseLabelText
            .replace('{gf_entry:gf_field_52}', friendlyDay)
            .replace('{gf_entry:gf_field_53}', selectedTimePeriod);
        console.log('Updating visible appointment confirmation field (ID: 57):', {
            labelText: labelText,
            dayPicker: dayPicker,
            selectedTimePeriod: selectedTimePeriod
        });

        label.text(labelText);
        var input = $('#input_' + formId + '_' + appointmentConfirmationFieldId);
        if (input.length) {
            input.prop('readonly', false).prop('disabled', false).css({'pointer-events': 'auto', 'z-index': '10'});
            console.log('Field 57 input state updated (update function):', {
                value: input.val(),
                readonly: input.prop('readonly'),
                disabled: input.prop('disabled'),
                styles: window.getComputedStyle(input[0]),
                events: $._data(input[0], 'events')
            });
        }
    }
}

function generateNotePopup() {
    $('#notePopup, #noteOverlay').remove();

    var notes = [];
    var fields = $('#gform_' + formId + ' .gfield').not('#field_' + formId + '_' + hiddenFieldId);
    fields.each(function() {
        var field = $(this);
        var fieldId = field.attr('id').replace('field_' + formId + '_', '');
        var label = field.find('.gfield_label').text().trim();
        var value = '';

        if (field.find('input[type="text"], input[type="tel"], input[type="email"], textarea').length) {
            value = field.find('input[type="text"], input[type="tel"], input[type="email"], textarea').val().trim();
        } else if (field.find('input[type="radio"]:checked').length) {
            value = field.find('input[type="radio"]:checked').val().trim();
        } else if (field.find('select').length) {
            value = field.find('select').val().trim();
        } else if (field.find('input[type="checkbox"]:checked').length) {
            value = field.find('input[type="checkbox"]:checked').map(function() {
                return $(this).siblings('label').text().trim();
            }).get().join(', ');
        }

        if (value && label && fieldId !== hiddenFieldId) {
            notes.push({ label: label, value: value });
        }
    });

    console.log('Collected notes:', notes);

    if (notes.length === 0) {
        alert('No fields have been filled out to generate a note.');
        return;
    }

    var popupHtml = '\
        <div id="notePopup">\
            <div id="notePopupContent">\
                <div class="note-header">\
                    <h2>Form Notes</h2>\
                </div>\
                <ul class="note-list">' +
                notes.map(function(note) {
                    return '<li class="note-item"><span class="note-label">' + note.label + '</span><span class="note-value">' + note.value + '</span></li>';
                }).join('') +
                '</ul>\
                <button class="copy-note-button">Copy Note</button>\
            </div>\
            <button type="button" class="note-close-popup">Close</button>\
        </div>\
        <div id="noteOverlay"></div>';

    $('body').append(popupHtml);

    var popup = $('#notePopup');
    var overlay = $('#noteOverlay');

    console.log('Note popup created, exists: ' + (popup.length > 0));

    overlay.on('click', function(e) {
        if (e.target.id === 'noteOverlay') {
            console.log('Note overlay clicked, closing popup');
            $('#notePopup, #noteOverlay').remove();
        }
    });

    popup.find('.note-close-popup').on('click', function() {
        console.log('Note close button clicked, closing popup');
        $('#notePopup, #noteOverlay').remove();
    });

    var noteText = notes.map(function(note) { return note.label + ': ' + note.value; }).join('\n');
    popup.find('.copy-note-button').on('click', function() {
        navigator.clipboard.writeText(noteText).then(function() {
            console.log('Notes copied to clipboard:', noteText);
            alert('Notes copied to clipboard!');
        }).catch(function(err) {
            console.error('Failed to copy notes:', err);
            alert('Failed to copy notes. Please try again.');
        });
    });

    console.log('Note popup content loaded');
}

function loadTradeInYears(isAlt) {
    var yearFieldId = isAlt ? tradeInAltYearFieldId : tradeInYearFieldId;
    var yearDropdown = $('#input_' + formId + '_' + yearFieldId);
    if (!yearDropdown.length) {
        console.warn((isAlt ? 'Alternate trade-in' : 'Trade-in') + ' year dropdown not found, selector: #input_' + formId + '_' + yearFieldId);
        alert('Error: ' + (isAlt ? 'Alternate Trade-In Year' : 'Trade-In Year') + ' field not found.');
        return;
    }
    var currentYear = new Date().getFullYear();
    yearDropdown.html('<option value="">Select Year</option>');
    for (var year = currentYear; year >= 1995; year--) {
        yearDropdown.append('<option value="' + year + '">' + year + '</option>');
    }
    if (isAlt) {
        serviceData.tradeAlt.year = '';
    } else {
        serviceData.trade.year = '';
    }
    console.log((isAlt ? 'Alternate trade-in' : 'Trade-in') + ' years loaded, options: ' + yearDropdown.find('option').length);
    if (yearDropdown.val()) {
        console.log((isAlt ? 'Alternate trade-in' : 'Trade-in') + ' year already selected: ' + yearDropdown.val() + ', triggering make population');
        loadTradeInMakes(isAlt);
    }
}

function loadTradeInMakes(isAlt) {
    var yearFieldId = isAlt ? tradeInAltYearFieldId : tradeInYearFieldId;
    var makeFieldId = isAlt ? tradeInAltMakeFieldId : tradeInMakeFieldId;
    var modelFieldId = isAlt ? tradeInAltModelFieldId : tradeInModelFieldId;
    var year = $('#input_' + formId + '_' + yearFieldId).val();
    var makeDropdown = $('#input_' + formId + '_' + makeFieldId);
    var modelDropdown = $('#input_' + formId + '_' + modelFieldId);

    console.log((isAlt ? 'Alternate trade-in' : 'Trade-in') + ' load makes debug:', {
        yearFieldId: yearFieldId,
        makeFieldId: makeFieldId,
        modelFieldId: modelFieldId,
        yearValue: year,
        makeExists: makeDropdown.length > 0,
        modelExists: modelDropdown.length > 0
    });

    if (!makeDropdown.length || !modelDropdown.length) {
        console.warn((isAlt ? 'Alternate trade-in' : 'Trade-in') + ' make or model dropdown not found', {
            makeSelector: '#input_' + formId + '_' + makeFieldId,
            modelSelector: '#input_' + formId + '_' + modelFieldId
        });
        alert('Error: ' + (isAlt ? 'Alternate Trade-In Make or Model' : 'Trade-In Make or Model') + ' field not found.');
        return;
    }
    if (!year) {
        makeDropdown.html('<option value="">Select Year First</option>');
        modelDropdown.html('<option value="">Select Model</option>');
        if (isAlt) {
            serviceData.tradeAlt.make = '';
            serviceData.tradeAlt.model = '';
        } else {
            serviceData.trade.make = '';
            serviceData.trade.model = '';
        }
        console.log((isAlt ? 'Alternate trade-in' : 'Trade-in') + ' no year selected, reset make and model dropdowns');
        return;
    }
    makeDropdown.html('<option value="">Loading Makes...</option>');
    var maxRetries = 3;
    var attempt = 0;
    function fetchMakes() {
        console.log('Fetching makes for ' + (isAlt ? 'alternate trade-in' : 'trade-in') + ', attempt ' + (attempt + 1));
        $.ajax({
            url: 'https://vpic.nhtsa.dot.gov/api/vehicles/GetMakesForVehicleType/car?format=json',
            method: 'GET',
            success: function(data) {
                if (!data.Results || data.Results.length === 0) {
                    console.error('No makes returned from NHTSA API for ' + (isAlt ? 'alternate trade-in' : 'trade-in'));
                    makeDropdown.html('<option value="">No Makes Available</option>');
                    modelDropdown.html('<option value="">Select Model</option>');
                    alert('No vehicle makes available for the selected year. Please try a different year.');
                    return;
                }
                console.log('NHTSA Makes API response: ' + data.Results.length + ' makes received');
                makeDropdown.html('<option value="">Select Make</option>');
                data.Results.sort(function(a, b) { return a.MakeName.localeCompare(b.MakeName); }).forEach(function(make) {
                    makeDropdown.append('<option value="' + make.MakeName + '">' + make.MakeName + '</option>');
                });
                modelDropdown.html('<option value="">Select Model</option>');
                if (isAlt) {
                    serviceData.tradeAlt.make = '';
                    serviceData.tradeAlt.model = '';
                } else {
                    serviceData.trade.make = '';
                    serviceData.trade.model = '';
                }
                console.log((isAlt ? 'Alternate trade-in' : 'Trade-in') + ' makes loaded, options: ' + makeDropdown.find('option').length);
                if (makeDropdown.val()) {
                    console.log((isAlt ? 'Alternate trade-in' : 'Trade-in') + ' make already selected: ' + makeDropdown.val() + ', triggering model population');
                    loadTradeInModels(isAlt);
                }
            },
            error: function(xhr, status, error) {
                attempt++;
                console.error('Error loading makes for ' + (isAlt ? 'alternate trade-in' : 'trade-in') + ', attempt ' + attempt + ': ' + error, {
                    status: xhr.status,
                    response: xhr.responseText || 'No response'
                });
                if (attempt < maxRetries) {
                    setTimeout(fetchMakes, 1000 * attempt);
                } else {
                    makeDropdown.html('<option value="">Error Loading Makes</option>');
                    modelDropdown.html('<option value="">Select Model</option>');
                    alert('Error: Failed to load vehicle makes for ' + (isAlt ? 'alternate trade-in' : 'trade-in') + '. Please try again.');
                }
            }
        });
    }
    fetchMakes();
}

function loadTradeInModels(isAlt) {
    var yearFieldId = isAlt ? tradeInAltYearFieldId : tradeInYearFieldId;
    var makeFieldId = isAlt ? tradeInAltMakeFieldId : tradeInMakeFieldId;
    var modelFieldId = isAlt ? tradeInAltModelFieldId : tradeInModelFieldId;
    var year = $('#input_' + formId + '_' + yearFieldId).val();
    var make = $('#input_' + formId + '_' + makeFieldId).val();
    var modelDropdown = $('#input_' + formId + '_' + modelFieldId);

    console.log((isAlt ? 'Alternate trade-in' : 'Trade-in') + ' load models debug:', {
        yearFieldId: yearFieldId,
        makeFieldId: makeFieldId,
        modelFieldId: modelFieldId,
        yearValue: year,
        makeValue: make,
        modelExists: modelDropdown.length > 0
    });

    if (!modelDropdown.length) {
        console.warn((isAlt ? 'Alternate trade-in' : 'Trade-in') + ' model dropdown not found', {
            modelSelector: '#input_' + formId + '_' + modelFieldId
        });
        alert('Error: ' + (isAlt ? 'Alternate Trade-In Model' : 'Trade-In Model') + ' field not found.');
        return;
    }
    if (!year || !make) {
        modelDropdown.html('<option value="">Select Year and Make First</option>');
        if (isAlt) {
            serviceData.tradeAlt.model = '';
        } else {
            serviceData.trade.model = '';
        }
        console.log((isAlt ? 'Alternate trade-in' : 'Trade-in') + ' no year or make selected, reset model dropdown');
        return;
    }
    modelDropdown.html('<option value="">Loading Models...</option>');
    var maxRetries = 3;
    var attempt = 0;
    function fetchModels() {
        console.log('Fetching models for ' + (isAlt ? 'alternate trade-in' : 'trade-in') + ' Year=' + year + ', Make=' + make + ', attempt ' + (attempt + 1));
        $.ajax({
            url: 'https://vpic.nhtsa.dot.gov/api/vehicles/GetModelsForMakeYear/make/' + encodeURIComponent(make) + '/modelyear/' + year + '?format=json',
            method: 'GET',
            success: function(data) {
                if (!data.Results || data.Results.length === 0) {
                    console.error('No models returned from NHTSA API for ' + (isAlt ? 'alternate trade-in' : 'trade-in') + ' Year=' + year + ', Make=' + make);
                    modelDropdown.html('<option value="">No Models Available</option>');
                    alert('No models available for the selected year and make. Please try a different selection.');
                    return;
                }
                console.log('NHTSA Models API response: ' + data.Results.length + ' models received');
                modelDropdown.html('<option value="">Select Model</option>');
                data.Results.sort(function(a, b) { return a.Model_Name.localeCompare(b.Model_Name); }).forEach(function(model) {
                    modelDropdown.append('<option value="' + model.Model_Name + '">' + model.Model_Name + '</option>');
                });
                if (isAlt) {
                    serviceData.tradeAlt.model = '';
                } else {
                    serviceData.trade.model = '';
                }
                console.log((isAlt ? 'Alternate trade-in' : 'Trade-in') + ' models loaded, options: ' + modelDropdown.find('option').length);
            },
            error: function(xhr, status, error) {
                attempt++;
                console.error('Error loading models for ' + (isAlt ? 'alternate trade-in' : 'trade-in') + ', attempt ' + attempt + ': ' + error, {
                    status: xhr.status,
                    response: xhr.responseText || 'No response'
                });
                if (attempt < maxRetries) {
                    setTimeout(fetchModels, 1000 * attempt);
                } else {
                    modelDropdown.html('<option value="">Error Loading Models</option>');
                    alert('Error: Failed to load vehicle models for ' + (isAlt ? 'alternate trade-in' : 'trade-in') + '. Please try again.');
                }
            }
        });
    }
    fetchModels();
}

function lookupStockNumber(sourceFieldId) {
    var isKiaField = sourceFieldId === stockKiaFieldId;
    var stockInput = $('#input_' + formId + '_' + sourceFieldId);
    var stockNumber = stockInput.val().trim();
    var yearField = $('#input_' + formId + '_' + (isKiaField ? yearKiaFieldId : yearFieldId));
    var makeField = $('#input_' + formId + '_' + (isKiaField ? makeKiaFieldId : makeFieldId));
    var modelField = $('#input_' + formId + '_' + (isKiaField ? modelKiaFieldId : modelFieldId));
    var loadingIndicator = isKiaField ? $('#kia-stock-loading') : $('#new-stock-loading');
    var errorMessage = isKiaField ? $('#kia-stock-error') : $('#new-stock-error');
    var availabilityField = $('#field_' + formId + '_' + availabilityFieldId);
    var videoMessageField = $('#field_' + formId + '_' + videoMessageFieldId);
    var buttonContainer = isKiaField
        ? ($('#kia-vehicle-info-button-container').length ? $('#kia-vehicle-info-button-container') : $('#field_' + formId + '_' + stockKiaFieldId))
        : ($('#vehicle-info-button-container').length ? $('#vehicle-info-button-container') : $('#field_' + formId + '_' + stockFieldId));

    console.log('Stock Number entered in field ID ' + sourceFieldId + ': ' + stockNumber);
    console.log('Button Container exists for field ID ' + sourceFieldId + ': ' + (buttonContainer.length > 0));
    console.log('Availability Field exists: ' + (availabilityField.length > 0));
    console.log('Video Message Field exists: ' + (videoMessageField.length > 0));

    var buttonId = isKiaField ? 'kia-view-vehicle-info' : 'new-view-vehicle-info';
    $('#' + buttonId).remove();

    if (!stockNumber) {
        loadingIndicator.hide();
        errorMessage.hide();
        yearField.val('');
        makeField.val('');
        modelField.val('');
        if (availabilityField.length) {
            availabilityField.find('.gfield_label').text('Great news! The vehicle is still available!');
            $('#input_' + formId + '_' + availabilityFieldId).val('');
        }
        if (videoMessageField.length) {
            videoMessageField.find('.gfield_label, legend').text('I love that, thank you. Would you like for us to send a personalized walkaround video of the vehicle?');
        }
        if (isKiaField) {
            vehicleKiaData = null;
        } else {
            vehicleData = null;
        }
        serviceData.trade = {};
        serviceData.tradeAlt = { year: '', make: '', model: '' };
        console.log('Stock number empty for field ID ' + sourceFieldId + ', fields reset');
        return;
    }

    loadingIndicator.show();
    errorMessage.hide();

    var csvUrl = 'https://hutchinsonautoteam.com/usedmacon/newfeed.csv';
    $.ajax({
        url: csvUrl,
        method: 'GET',
        success: function(csvText) {
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    loadingIndicator.hide();
                    console.log('CSV parsed for field ID ' + sourceFieldId + ', rows: ' + results.data.length);
                    var vehicle = results.data.find(function(row) {
                        return row['Stock #'] && row['Stock #'].trim().toLowerCase() === stockNumber.toLowerCase();
                    });

                    if (vehicle) {
                        var year = vehicle['Year'] ? vehicle['Year'].trim() : '';
                        var make = vehicle['Make'] ? vehicle['Make'].trim() : '';
                        var model = vehicle['Model'] ? vehicle['Model'].trim() : '';
                        console.log('Vehicle found for field ID ' + sourceFieldId + ':', { year: year, make: make, model: model });

                        if (year && make && model) {
                            yearField.val(year);
                            makeField.val(make);
                            modelField.val(model);
                            if (isKiaField) {
                                vehicleKiaData = vehicle;
                            } else {
                                vehicleData = vehicle;
                            }

                            var buttonHtml = '<button type="button" class="view-vehicle-info" id="' + buttonId + '">View Vehicle Info</button>';
                            buttonContainer.append(buttonHtml);
                            $('#' + buttonId).off('click.viewVehicleInfo').on('click.viewVehicleInfo', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                if (isProcessingClick) return;
                                isProcessingClick = true;
                                console.log('View Vehicle Info button clicked for field ID ' + sourceFieldId);
                                showVehicleInfo(isKiaField);
                                setTimeout(function() { isProcessingClick = false; }, 500);
                            });
                            console.log('View Vehicle Info button created and appended for field ID ' + sourceFieldId);

                            if (availabilityField.length) {
                                var availabilityText = 'Great news! The ' + year + ' ' + make + ' ' + model + ' is still available!';
                                console.log('Initial availability label: ' + availabilityField.find('.gfield_label').text());
                                availabilityField.find('.gfield_label').text(availabilityText);
                                $('#input_' + formId + '_' + availabilityFieldId).val('');
                                console.log('Availability label updated with: ' + availabilityText);
                                console.log('Availability input value: ' + $('#input_' + formId + '_' + availabilityFieldId).val());
                            } else {
                                console.warn('Availability field not found');
                            }

                            if (videoMessageField.length) {
                                var videoText = 'I love that, thank you. Would you like for us to send a personalized walkaround video of the ' + make + '?';
                                console.log('Initial video message label: ' + videoMessageField.find('.gfield_label, legend').text());
                                videoMessageField.find('.gfield_label, legend').text(videoText);
                                console.log('Video message label updated with: ' + videoText);
                                console.log('Radio buttons present: ' + (videoMessageField.find('.gfield_radio').length > 0));
                            } else {
                                console.warn('Video message field not found');
                            }
                        } else {
                            errorMessage.text('Vehicle data incomplete in CSV').show();
                            resetFields(isKiaField);
                            console.log('Incomplete vehicle data for field ID ' + sourceFieldId);
                        }
                    } else {
                        errorMessage.text('Stock number not found').show();
                        resetFields(isKiaField);
                        console.log('Stock number not found in CSV for field ID ' + sourceFieldId);
                    }
                },
                error: function(error) {
                    loadingIndicator.hide();
                    errorMessage.text('Error parsing CSV file').show();
                    resetFields(isKiaField);
                    console.error('Papa Parse error for field ID ' + sourceFieldId + ': ' + error);
                }
            });
        },
        error: function(xhr, status, error) {
            loadingIndicator.hide();
            errorMessage.text('Unable to fetch vehicle data. Please try again later.').show();
            resetFields(isKiaField);
            console.error('Fetch error for field ID ' + sourceFieldId + ': ' + error);
        }
    });
}

function resetFields(isKiaField) {
    var yearField = $('#input_' + formId + '_' + (isKiaField ? yearKiaFieldId : yearFieldId));
    var makeField = $('#input_' + formId + '_' + (isKiaField ? makeKiaFieldId : makeFieldId));
    var modelField = $('#input_' + formId + '_' + (isKiaField ? modelKiaFieldId : modelFieldId));
    var buttonId = isKiaField ? 'kia-view-vehicle-info' : 'new-view-vehicle-info';

    yearField.val('');
    makeField.val('');
    modelField.val('');
    $('#' + buttonId).remove();
    $('#input_' + formId + '_' + tradeInYearFieldId).html('<option value="">Select Year</option>');
    $('#input_' + formId + '_' + tradeInMakeFieldId).html('<option value="">Select Make</option>');
    $('#input_' + formId + '_' + tradeInModelFieldId).html('<option value="">Select Model</option>');
    $('#input_' + formId + '_' + tradeInAltYearFieldId).html('<option value="">Select Year</option>');
    $('#input_' + formId + '_' + tradeInAltMakeFieldId).html('<option value="">Select Make</option>');
    $('#input_' + formId + '_' + tradeInAltModelFieldId).html('<option value="">Select Model</option>');
    var availabilityField = $('#field_' + formId + '_' + availabilityFieldId);
    var videoMessageField = $('#field_' + formId + '_' + videoMessageFieldId);
    if (availabilityField.length) {
        availabilityField.find('.gfield_label').text('Great news! The vehicle is still available!');
        $('#input_' + formId + '_' + availabilityFieldId).val('');
    }
    if (videoMessageField.length) {
        videoMessageField.find('.gfield_label, legend').text('I love that, thank you. Would you like for us to send a personalized walkaround video of the vehicle?');
    }
    if (isKiaField) {
        vehicleKiaData = null;
    } else {
        vehicleData = null;
    }
    serviceData.trade = {};
    serviceData.tradeAlt = { year: '', make: '', model: '' };
    console.log('Fields reset for ' + (isKiaField ? 'Kia stock field (ID: ' + stockKiaFieldId + ')' : 'stock field (ID: ' + stockFieldId + ')'));
}

function showVehicleInfo(isKiaField) {
    var data = isKiaField ? vehicleKiaData : vehicleData;
    if (!data) {
        console.error('No vehicle data available for ' + (isKiaField ? 'Kia stock field (ID: ' + stockKiaFieldId + ')' : 'stock field (ID: ' + stockFieldId + ')'));
        isProcessingClick = false;
        return;
    }

    $('#vehiclePopup, #overlay, #vehiclePopupStyles').remove();

    var popupStyles = '\
        #vehiclePopup {\
            position: fixed;\
            top: 50%;\
            left: 50%;\
            transform: translate(-50%, -50%);\
            width: 90%;\
            max-width: 900px;\
            max-height: 85vh;\
            background: linear-gradient(145deg, #ffffff, #f8fafc);\
            border-radius: 16px;\
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);\
            z-index: 1001;\
            overflow-y: auto;\
            padding: 30px;\
            animation: slideIn 0.3s ease-out;\
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;\
            white-space: nowrap;\
        }\
        @keyframes slideIn {\
            from { transform: translate(-50%, -60%); opacity: 0; }\
            to { transform: translate(-50%, -50%); opacity: 1; }\
        }\
        #vehiclePopupContent {\
            padding: 0;\
        }\
        #overlay {\
            position: fixed;\
            top: 0;\
            left: 0;\
            width: 100%;\
            height: 100%;\
            background: rgba(0, 0, 0, 0.7);\
            z-index: 1000;\
            cursor: pointer;\
        }\
        .close-popup {\
            position: absolute;\
            top: 15px;\
            right: 15px;\
            padding: 10px 20px;\
            font-size: 16px;\
            font-weight: 600;\
            color: #ffffff;\
            background: #dc2626;\
            border: none;\
            border-radius: 8px;\
            cursor: pointer;\
            transition: background 0.2s ease, transform 0.2s ease;\
        }\
        .close-popup:hover {\
            background: #b91c1c;\
            transform: scale(1.05);\
        }\
        .vehicle-gallery {\
            margin-bottom: 30px;\
            border-radius: 12px;\
            overflow: hidden;\
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);\
        }\
        .swiper-container {\
            width: 100%;\
            height: 400px;\
            position: relative;\
        }\
        .swiper-slide img {\
            width: 100%;\
            height: 100%;\
            object-fit: cover;\
            border-radius: 12px 12px 0 0;\
            transition: transform 0.3s ease;\
        }\
        .swiper-slide img:hover {\
            transform: scale(1.02);\
        }\
        .swiper-button-prev, .swiper-button-next {\
            color: #ffffff;\
            background: rgba(0, 0, 0, 0.5);\
            width: 40px;\
            height: 40px;\
            border-radius: 50%;\
            transition: background 0.2s ease;\
        }\
        .swiper-button-prev:hover, .swiper-button-next:hover {\
            background: rgba(0, 0, 0, 0.7);\
        }\
        .swiper-pagination-bullet {\
            background: #ffffff;\
            opacity: 0.7;\
        }\
        .swiper-pagination-bullet-active {\
            background: #dc2626;\
            opacity: 1;\
        }\
        .vehicle-actions {\
            display: flex;\
            gap: 15px;\
            justify-content: center;\
            margin-bottom: 30px;\
        }\
        .vehicle-action-button {\
            display: inline-block;\
            padding: 12px 24px;\
            font-size: 16px;\
            font-weight: 600;\
            text-decoration: none;\
            color: #ffffff;\
            background: #2563eb;\
            border-radius: 8px;\
            transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;\
        }\
        .vehicle-action-button:hover {\
            background: #1d4ed8;\
            transform: translateY(-2px);\
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);\
        }\
        .vehicle-action-button.online {\
            background: #16a34a;\
        }\
        .vehicle-action-button.online:hover {\
            background: #15803d;\
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);\
        }\
        .vehicle-details-grid {\
            display: grid;\
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\
            gap: 20px;\
            margin-bottom: 30px;\
        }\
        .vehicle-detail {\
            background: #f1f5f9;\
            padding: 15px;\
            border-radius: 8px;\
            font-size: 15px;\
            color: #334155;\
            transition: background 0.2s ease;\
        }\
        .vehicle-detail strong {\
            color: #1e293b;\
            font-weight: 600;\
        }\
        .vehicle-detail:hover {\
            background: #e2e8f0;\
        }\
        .vehicle-description {\
            background: #ffffff;\
            padding: 20px;\
            border-radius: 8px;\
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\
        }\
        .vehicle-description h3 {\
            margin: 0 0 15px 0;\
            font-size: 20px;\
            color: #1e293b;\
            font-weight: 700;\
        }\
        .vehicle-description p {\
            margin: 0;\
            font-size: 15px;\
            color: #475569;\
            line-height: 1.6;\
        }\
        @media (max-width: 768px) {\
            #vehiclePopup {\
                width: 95%;\
                padding: 20px;\
            }\
            .swiper-container {\
                height: 250px;\
            }\
            .vehicle-actions {\
                flex-direction: column;\
                gap: 10px;\
            }\
            .vehicle-action-button {\
                width: 100%;\
                text-align: center;\
            }\
            .vehicle-details-grid {\
                grid-template-columns: 1fr;\
            }\
        }';
    $('head').append('<style id="vehiclePopupStyles">' + popupStyles + '</style>');

    var popupHtml = '\
        <div id="vehiclePopup">\
            <div id="vehiclePopupContent"></div>\
            <button type="button" class="close-popup">Close</button>\
        </div>\
        <div id="overlay"></div>';
    $('body').append(popupHtml);

    var popup = $('#vehiclePopup');
    var content = $('#vehiclePopupContent');
    var overlay = $('#overlay');

    console.log('Popup created for ' + (isKiaField ? 'Kia stock field (ID: ' + stockKiaFieldId + ')' : 'stock field (ID: ' + stockFieldId + ')') + ', exists: ' + (popup.length > 0));

    console.log('Popup visibility:', {
        popupDisplay: popup.css('display'),
        overlayDisplay: overlay.css('display'),
        popupZIndex: popup.css('z-index'),
        popupPosition: popup.css('position'),
        popupTransform: popup.css('transform'),
        popupVisibility: popup.css('visibility'),
        popupWidth: popup.width(),
        popupHeight: popup.height()
    });

    overlay.on('click', function(e) {
        if (e.target.id === 'overlay') {
            console.log('Overlay clicked, closing popup');
            $('#vehiclePopup, #overlay, #vehiclePopupStyles').remove();
            if (currentSwiper) {
                currentSwiper.destroy(true, true);
                currentSwiper = null;
            }
            console.log('Vehicle popup closed and removed');
        }
    });

    popup.find('.close-popup').on('click', function() {
        console.log('Close button clicked, closing popup');
        $('#vehiclePopup, #overlay, #vehiclePopupStyles').remove();
        if (currentSwiper) {
            currentSwiper.destroy(true, true);
            currentSwiper = null;
        }
        console.log('Vehicle popup closed and removed');
    });

    var photos = data['Photos'] && data['Photos'].trim()
        ? data['Photos'].trim().split('|').filter(function(url) { return url && url.endsWith('.jpg'); }).map(function(url) { return url.replace(/^http:/, 'https:'); })
        : [];
    console.log('Raw Photos for ' + (isKiaField ? 'Kia stock field' : 'stock field') + ': ' + data['Photos']);
    console.log('Photos (HTTPS): ' + photos);
    var galleryHtml = photos.length > 0
        ? '\
            <div class="vehicle-gallery">\
                <div class="swiper-container">\
                    <div class="swiper-wrapper">' +
                    photos.map(function(url) { return '<div class="swiper-slide"><img src="' + url + '" alt="Vehicle Image" loading="lazy"></div>'; }).join('') +
                    '</div>\
                    <div class="swiper-button-prev"></div>\
                    <div class="swiper-button-next"></div>\
                    <div class="swiper-pagination"></div>\
                </div>\
            </div>'
        : '<div class="vehicle-gallery"><p>No images available</p></div>';

    var vin = data['VIN'] ? data['VIN'].trim() : '';
    var dealerId = data['DealerId'] ? data['DealerId'].trim() : '';
    var make = data['Make'] ? data['Make'].trim() : '';
    var onlineUrl = '';
    var windowStickerUrl = '';

    switch (dealerId) {
        case 'MP18519':
            onlineUrl = 'https://www.kiaofmacon.com/new-vehicles/?q=' + encodeURIComponent(vin);
            windowStickerUrl = 'https://www.kiaofmacon.com/dealer-inspire-inventory/window-stickers/kia?vin=' + encodeURIComponent(vin);
            break;
        case 'MP19913':
            onlineUrl = 'https://www.hutchinsonkiaofalbany.com/new-vehicles/?q=' + encodeURIComponent(vin);
            windowStickerUrl = 'https://www.hutchinsonkiaofalbany.com/dealer-inspire-inventory/window-stickers/kia?vin=' + encodeURIComponent(vin);
            break;
        case 'MP18517':
            onlineUrl = make.toLowerCase() === 'cadillac'
                ? 'https://www.hutchinsoncadillac.com/new-vehicles/?q=' + encodeURIComponent(vin)
                : 'https://www.hutchinsongmc.com/new-vehicles/?q=' + encodeURIComponent(vin);
            windowStickerUrl = 'https://cws.gm.com/vs-cws/vehshop/v2/vehicle/windowsticker?vin=' + encodeURIComponent(vin);
            break;
        default:
            onlineUrl = '#';
            windowStickerUrl = '#';
    }

    var actionsHtml = '\
        <div class="vehicle-actions">\
            <a href="' + onlineUrl + '" target="_blank" class="vehicle-action-button online">View Online</a>\
            <a href="' + windowStickerUrl + '" target="_blank" class="vehicle-action-button window-sticker">View Window Sticker</a>\
        </div>';

    var details = [
        { label: 'Stock #', value: data['Stock #'] || 'N/A' },
        { label: 'VIN', value: data['VIN'] || 'N/A' },
        { label: 'Year', value: data['Year'] || 'N/A' },
        { label: 'Make', value: data['Make'] || 'N/A' },
        { label: 'Model', value: data['Model'] || 'N/A' },
        { label: 'Series', value: data['Series'] || 'N/A' },
        { label: 'Colour', value: data['Colour'] || 'N/A' },
        { label: 'Interior Color', value: data['Interior Color'] || 'N/A' },
        { label: 'Body', value: data['Body'] || 'N/A' },
        { label: 'Transmission', value: data['Transmission'] || 'N/A' },
        { label: 'Door Count', value: data['Door Count'] || 'N/A' },
        { label: 'Odometer', value: data['Odometer'] || 'N/A' },
        { label: 'Engine Cylinder Ct', value: data['Engine Cylinder Ct'] || 'N/A' },
        { label: 'Engine Displacement', value: data['Engine Displacement'] || 'N/A' },
        { label: 'Drivetrain Desc', value: data['Drivetrain Desc'] || 'N/A' },
        { label: 'City MPG', value: data['City MPG'] || 'N/A' },
        { label: 'Highway MPG', value: data['Highway MPG'] || 'N/A' },
        { label: 'Price', value: data['Price'] || 'N/A' },
        { label: 'MSRP', value: data['MSRP'] || 'N/A' }
    ];

    var detailsHtml = '\
        <div class="vehicle-details-grid">' +
        details.map(function(detail) {
            return '<div class="vehicle-detail"><strong>' + detail.label + ':</strong> ' + detail.value + '</div>';
        }).join('') +
        '</div>';

    var descriptionHtml = '\
        <div class="vehicle-description">\
            <h3>Details</h3>\
            <p>' + (data['Description'] || 'No description available') + '</p>\
        </div>';

    content.html(galleryHtml + actionsHtml + detailsHtml + descriptionHtml);

    if (photos.length > 0) {
        currentSwiper = new Swiper('.swiper-container', {
            loop: true,
            navigation: {
                nextEl: '.swiper-button-prev',
                prevEl: '.swiper-button-next'
            },
            pagination: {
                el: '.swiper-pagination',
                clickable: true
            },
            lazy: {
                loadPrevNext: true
            }
        });
        console.log('Swiper initialized with corrected navigation for ' + (isKiaField ? 'Kia stock field' : 'stock field'));
    }

    console.log('Popup content loaded for ' + (isKiaField ? 'Kia stock field (ID: ' + stockKiaFieldId + ')' : 'stock field (ID: ' + stockFieldId + ')'));
}

    loadFeatureDescriptions();
    loadTerrainFeatureDescriptions();
    loadAcadiaFeatureDescriptions();
    loadYukonFeatureDescriptions();
    loadCanyonFeatureDescriptions();
initFormBindings();
updateSelectedName();

$('#new-view-vehicle-info, #kia-view-vehicle-info').remove();
$('#field_' + formId + '_' + textReceiptFieldId).hide();
$('#field_' + formId + '_' + textReceiptFieldId2).hide();
$('#field_' + formId + '_' + appointmentConfirmationFieldId).hide();
console.log('Initial setup complete');

form.on('submit', function(e) {
    console.log('Form submit attempted', {
        tradeData: serviceData.trade,
        tradeAltData: serviceData.tradeAlt,
        newData: serviceData.new
    });
});

// Test function for debugging
window.testTerrainDebug = function() {
    console.log('=== Manual Terrain Debug Test ===');
    console.log('Form ID:', formId);
    console.log('terrainHtmlBlockFieldId:', terrainHtmlBlockFieldId);
    console.log('terrainPopulated:', terrainPopulated);
    console.log('modelConfigs.TERRAIN:', modelConfigs['TERRAIN']);
    
    // Try all possible selectors
    var selectors = [
        '#field_' + formId + '_' + terrainHtmlBlockFieldId,
        '#field_' + formId + '_137',
        '#input_' + formId + '_137',
        '[id*="137"]'
    ];
    
    selectors.forEach(function(selector, index) {
        var elements = $(selector);
        console.log('Selector ' + index + ' (' + selector + '):', {
            count: elements.length,
            ids: elements.map(function() { return this.id; }).get()
        });
    });
    
    var htmlBlock = $('#field_' + formId + '_' + terrainHtmlBlockFieldId);
    if (!htmlBlock.length) {
        htmlBlock = $('#field_' + formId + '_137');
    }
    if (!htmlBlock.length) {
        htmlBlock = $('[id*="137"]').first();
    }
    
    console.log('Final HTML Block:', {
        found: htmlBlock.length > 0,
        id: htmlBlock.attr('id'),
        visible: htmlBlock.is(':visible'),
        content: htmlBlock.html() ? htmlBlock.html().substring(0, 500) : 'N/A'
    });
    
    var checkboxes = htmlBlock.find('input[type="checkbox"]');
    console.log('Checkboxes found before population:', checkboxes.length);
    
    if (typeof populateTerrainFeatures === 'function') {
        console.log('Calling populateTerrainFeatures...');
        populateTerrainFeatures();
        
        // Check again after population
        var checkboxesAfter = htmlBlock.find('input[type="checkbox"]');
        console.log('Checkboxes found after population:', checkboxesAfter.length);
        checkboxesAfter.each(function(i) {
            console.log('Checkbox ' + i + ':', {
                id: $(this).attr('id'),
                name: $(this).attr('name'),
                value: $(this).attr('value'),
                checked: $(this).is(':checked')
            });
        });
    } else {
        console.log('populateTerrainFeatures function not found');
    }
    
    console.log('Calling updateTrimLevels...');
    updateTrimLevels('TERRAIN');
};

// Force populate function for debugging
window.forcePopulateTerrainFeatures = function() {
    console.log('=== Force Populating Terrain Features ===');
    terrainPopulated = false; // Reset the flag
    populateTerrainFeatures();
};

// Manual terrain creation function for debugging
window.createTerrainCheckboxesManually = function() {
    console.log('=== Manual Terrain Checkboxes Creation ===');
    
    // Find field 137 manually using multiple methods
    var field137 = null;
    var selectors = [
        '#field_3_137',
        '[id*="field"][id*="137"]',
        '[id*="137"]'
    ];
    
    for (var i = 0; i < selectors.length; i++) {
        field137 = $(selectors[i]);
        if (field137.length > 0) {
            console.log('‚úÖ Found field 137 using selector:', selectors[i]);
            break;
        }
    }
    
    if (!field137 || field137.length === 0) {
        console.log('‚ùå Field 137 not found');
        return;
    }
    
    console.log('üìç Field 137 found:', field137.length > 0);
    console.log('üìç Field 137 ID:', field137.attr('id'));
    console.log('üìç Field 137 visible:', field137.is(':visible'));
    console.log('üìç Field 137 content length:', field137.html().length);
    
    // Create sample checkboxes manually
    var sampleHtml = '<div class="feature-groups">' +
        '<div class="feature-column"><h4>EXTERIOR</h4><ul class="gfield_checkbox">' +
        '<li class="gchoice"><input type="checkbox" id="test_terrain_1" value="LED Headlights" data-category="EXTERIOR"><label for="test_terrain_1">LED Headlights</label></li>' +
        '<li class="gchoice"><input type="checkbox" id="test_terrain_2" value="Fog Lights" data-category="EXTERIOR"><label for="test_terrain_2">Fog Lights</label></li>' +
        '</ul></div>' +
        '<div class="feature-column"><h4>INTERIOR</h4><ul class="gfield_checkbox">' +
        '<li class="gchoice"><input type="checkbox" id="test_terrain_3" value="Heated Seats" data-category="INTERIOR"><label for="test_terrain_3">Heated Seats</label></li>' +
        '</ul></div>' +
        '</div>';
    
    field137.html(sampleHtml);
    console.log('‚úÖ Sample checkboxes created');
    console.log('‚úÖ Checkboxes count:', field137.find('input[type="checkbox"]').length);
    
    // Add event listeners
    field137.find('input[type="checkbox"]').on('change', function() {
        console.log('üîÑ Checkbox changed:', $(this).attr('value'), $(this).is(':checked'));
    });
    
    // Force populate real terrain features
    console.log('üîß Now forcing real terrain features...');
    terrainPopulated = false;
    populateTerrainFeatures();
};

// Manual function to check current state
window.checkTerrainState = function() {
    console.log('=== Terrain State Check ===');
    console.log('terrainPopulated:', terrainPopulated);
    console.log('modelConfigs.TERRAIN:', modelConfigs['TERRAIN']);
    
    // Check for field 137
    var field137 = $('#field_3_137');
    console.log('Field 137 exists:', field137.length > 0);
    if (field137.length > 0) {
        console.log('Field 137 visible:', field137.is(':visible'));
        console.log('Field 137 content length:', field137.html().length);
        console.log('Field 137 checkboxes:', field137.find('input[type="checkbox"]').length);
    }
    
    // Check for terrain checkboxes anywhere
    var terrainCheckboxes = $('input[type="checkbox"][id*="terrain"]');
    console.log('Terrain checkboxes in document:', terrainCheckboxes.length);
    
    // Check selected model
    var selectedModel = $('input[name="input_3_107"]:checked').val();
    console.log('Selected model:', selectedModel);
};

console.log('Debug functions available: testTerrainDebug(), forcePopulateTerrainFeatures(), createTerrainCheckboxesManually(), checkTerrainState()');

// GLOBAL RADIO BUTTON LISTENER FOR DEBUGGING
$(document).on('change', 'input[type="radio"]', function() {
    console.log('üîç GLOBAL RADIO CHANGE DETECTED:');
    console.log('  - ID:', $(this).attr('id'));
    console.log('  - Name:', $(this).attr('name'));
    console.log('  - Value:', $(this).val());
    console.log('  - Checked:', $(this).is(':checked'));
    console.log('  - Expected GMC field pattern:', 'choice_' + formId + '_' + gmcModelFieldId);
    console.log('  - Matches pattern:', $(this).attr('id') && $(this).attr('id').indexOf('choice_' + formId + '_' + gmcModelFieldId) !== -1);
    
    if ($(this).val() === 'TERRAIN' && $(this).is(':checked')) {
        console.log('üö® TERRAIN DETECTED IN GLOBAL LISTENER - FORCING POPULATE');
        terrainPopulated = false;
        populateTerrainFeatures();
    }
    
    if ($(this).val() === 'ACADIA' && $(this).is(':checked')) {
        console.log('üö® ACADIA DETECTED IN GLOBAL LISTENER - FORCING POPULATE');
        acadiaPopulated = false;
        populateAcadiaFeatures();
    }
    
    if ($(this).val() === 'YUKON' && $(this).is(':checked')) {
        console.log('üö® YUKON DETECTED IN GLOBAL LISTENER - FORCING POPULATE');
        yukonPopulated = false;
        populateYukonFeatures();
    }
});

});

// Comments for Part 5/5
/*
 * This is the updated Part 5/5, concluding from updated Part 4/5, with Terrain support integrated in prior parts.
 * showTextReceiptField, updateTextReceiptField, showAppointmentConfirmationField, updateAppointmentConfirmationField, generateNotePopup unchanged.
 * loadTradeInYears, loadTradeInMakes, loadTradeInModels for trade-ins.
 * lookupStockNumber, resetFields, showVehicleInfo for stock lookups/popups.
 * Initial setup and form submit log.
 * Closes jQuery(document).ready.
 * Preserves original functionality.
 * Syntax verified.
 * Full script complete.
 */